<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鏈居 - 平台總後台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #0ea5e9;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-hover: #334155;
            --sidebar-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 側邊欄 - 深色主題 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 4px 0 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-badge {
            background: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .logo p {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            flex: 1;
        }
        .sidebar-footer {
            padding: 16px;
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .btn-logout {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.9);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.10);
            transform: translateY(-1px);
        }


        .nav-item {
            padding: 0 16px;
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        /* 主內容區 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
        }

        /* 頂部欄 */
        .header {
            background: var(--card-bg);
            padding: 20px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #0284c7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* 頁面內容 */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 卡片 */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-bg), var(--bg-color));
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            color: var(--success-color);
        }

        /* 特殊統計卡片 - 帶圖標 */
        .stat-card-icon {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-card-content {
            flex: 1;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), #0284c7);
        }

        .stat-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        /* 表格 */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-color);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tr:hover {
            background: var(--bg-color);
        }

        /* 徽章 */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-primary { background: #dbeafe; color: var(--primary-color); }
        .badge-success { background: #d1fae5; color: var(--success-color); }
        .badge-warning { background: #fed7aa; color: var(--warning-color); }
        .badge-danger { background: #fee2e2; color: var(--danger-color); }
        .badge-info { background: #cffafe; color: var(--info-color); }
        .badge-secondary { background: #f1f5f9; color: var(--text-secondary); }

        /* 按鈕 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #0284c7;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-color);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* 標籤頁 */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* 標籤頁內容（若有 tab-panel 則做顯示切換；不影響僅有按鈕的舊頁面） */
        .tab-panels .tab-panel {
            display: none;
        }
        .tab-panels .tab-panel.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        /* 表單 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* 搜尋欄 */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        /* 警告框 */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning-color);
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border-left: 4px solid var(--danger-color);
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid var(--info-color);
            color: #1e3a8a;
        }

        .alert-success {
            background: #d1fae5;
            border-left: 4px solid var(--success-color);
            color: #065f46;
        }

        /* 快捷入口 */
        .shortcut-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .shortcut-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border-color);
        }

        .shortcut-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
            border-color: var(--primary-color);
        }

        .shortcut-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shortcut-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .shortcut-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .shortcut-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* 參數設定卡片 */
        .param-card {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .param-title {
            font-weight: 600;
            font-size: 16px;
        }

        .param-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .param-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 日誌項目 */
        .log-item {
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-action {
            font-weight: 600;
            font-size: 14px;
        }

        .log-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .log-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .log-user {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-right: 12px;
        }

        /* 響應式 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .shortcut-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* 角色徽章 */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-super-admin {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .role-ops {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }

        .role-cs {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* KPI 指標卡片 */
        .kpi-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kpi-trend {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }
    
        /* 案源主視覺上傳 */
        .uploader {
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        .uploader-preview {
            width: 140px;
            height: 96px;
            border-radius: 12px;
            border: 1px dashed var(--border-color);
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: var(--text-secondary);
            font-size: 12px;
        }
        .uploader-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 860px) {
            .uploader { flex-direction: column; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- 側邊欄 -->
        <aside class="sidebar">
            <div class="logo">
                <h1>
                    鏈居
                    <span class="logo-badge">ADMIN</span>
                </h1>
                <div style="margin-top: 10px; color: rgba(255,255,255,0.85); font-size: 13px;">HI, <span id="sidebarUserName" style="font-weight: 700;">陳管理員</span></div>
                <p>平台總後台</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        系統總覽
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="accounts">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        帳號與角色管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="contracts">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 6H7a2 2 0 01-2-2V4a2 2 0 012-2h7l5 5v13a2 2 0 01-2 2z" />
                        </svg>
                        合約與歸因中心
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="tickets">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745V17a2 2 0 002 2h14a2 2 0 002-2v-3.745zM3 6v7.255A23.931 23.931 0 0012 15c3.183 0 6.22-.62 9-1.745V6a2 2 0 00-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                        工單 / 爭議中心
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="finance">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-10V6m0 12v2m9-8a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        財務結算中心
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="risk">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z" />
                        </svg>
                        風控中心
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="projects">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        案源管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="bookings">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        報備與帶看管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="settings">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        制度參數設定
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="kpi">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        統計報表與 KPI
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="analytics">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        數據分析
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="logs">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        操作日誌
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1"/>
                    </svg>
                    登出
                </button>
            </div>

        </aside>

        <!-- 主內容 -->
        <main class="main-content">

            <!-- 頁面1: 系統總覽 -->
            <div id="dashboard" class="page-content active">
                <!-- 全平台數據 -->
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: #0ea5e9;">
                        <div class="stat-card-icon">
                            <div class="stat-card-content">
                                <div class="stat-label">總報備數</div>
                                <div class="stat-value">1,247</div>
                                <div class="stat-change">↑ 本月增加 156 筆</div>
                            </div>
                            <div class="stat-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #8b5cf6;">
                        <div class="stat-card-icon">
                            <div class="stat-card-content">
                                <div class="stat-label">總帶看數</div>
                                <div class="stat-value">892</div>
                                <div class="stat-change">↑ 本月增加 98 筆</div>
                            </div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #10b981;">
                        <div class="stat-card-icon">
                            <div class="stat-card-content">
                                <div class="stat-label">總成交數</div>
                                <div class="stat-value">234</div>
                                <div class="stat-change">↑ 本月增加 28 筆</div>
                            </div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 使用概況 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">使用概況</h3>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: #f59e0b;">
                            <div class="stat-label">仲介業務數</div>
                            <div class="stat-value">128</div>
                            <div class="stat-change">啟用中帳號</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #ec4899;">
                            <div class="stat-label">代銷主管數</div>
                            <div class="stat-value">24</div>
                            <div class="stat-change">啟用中帳號</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #06b6d4;">
                            <div class="stat-label">仲介門店數</div>
                            <div class="stat-value">15</div>
                            <div class="stat-change">合作門店</div>
                        </div>
                    </div>
                </div>

                <!-- 風險提示 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">風險提示</h3>
                        <span class="badge badge-danger">3 項異常</span>
                    </div>
                    <div class="alert alert-danger">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <strong>高取消率仲介警示</strong>
                            <p style="margin-top: 4px; font-size: 14px;">發現 3 位仲介業務核可後取消率超過 30%，建議關注</p>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>業務姓名</th>
                                    <th>門店</th>
                                    <th>本月報備數</th>
                                    <th>核可後取消數</th>
                                    <th>取消率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>王小明</td>
                                    <td>信義門店</td>
                                    <td>15</td>
                                    <td>6</td>
                                    <td><span class="badge badge-danger">40%</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewUserDetail('王小明')">查看詳情</button></td>
                                </tr>
                                <tr>
                                    <td>李小華</td>
                                    <td>大安門店</td>
                                    <td>12</td>
                                    <td>4</td>
                                    <td><span class="badge badge-warning">33%</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewUserDetail('李小華')">查看詳情</button></td>
                                </tr>
                                <tr>
                                    <td>張美玲</td>
                                    <td>松山門店</td>
                                    <td>10</td>
                                    <td>3</td>
                                    <td><span class="badge badge-warning">30%</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewUserDetail('張美玲')">查看詳情</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 頁面2: 帳號與角色管理 -->
            <div id="accounts" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">帳號與角色管理</h3>
                        <button class="btn btn-primary" onclick="openAddAccountModal()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            新增帳號
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>平台為唯一帳號建立權限方，其他角色不可自行建立帳號</span>
                    </div>

                    <!-- 子模組分頁（10.3.1） -->
                    <div class="tabs" style="margin-top: 16px;">
                        <button class="tab active" data-tab="accounts_list">平台帳號清單</button>
                        <button class="tab" data-tab="org_audit">機構建檔審核</button>
                        <button class="tab" data-tab="blacklist">停權 / 黑名單</button>
                        <button class="tab" data-tab="rbac">權限矩陣（RBAC）</button>
                    </div>

                    <div class="tab-panels" style="margin-top: 16px;">
                        <!-- Panel: 平台帳號清單（保留原有 UI） -->
                        <div class="tab-panel active" data-tab-panel="accounts_list">

                    <!-- 搜尋欄 -->
                    <div class="search-bar">
                        <select class="form-control" style="width: auto;">
                            <option value="">全部角色</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="platform_ops">Platform Ops</option>
                            <option value="platform_cs">Platform CS</option>
                            <option value="agent_manager">仲介店長</option>
                            <option value="agent">仲介業務</option>
                            <option value="developer">代銷主管</option>
                        </select>
                        <select class="form-control" style="width: auto;">
                            <option value="">全部狀態</option>
                            <option value="active">啟用中</option>
                            <option value="inactive">已停用</option>
                        </select>
                        <input type="text" class="search-input" placeholder="搜尋姓名、手機...">
                        <button class="btn btn-primary">搜尋</button>
                    </div>

                    <!-- 帳號列表 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>手機號碼</th>
                                    <th>角色</th>
                                    <th>門店/單位</th>
                                    <th>建立日期</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>陳管理員</td>
                                    <td>0900-000-001</td>
                                    <td><span class="role-badge role-super-admin">Super Admin</span></td>
                                    <td>平台營運部</td>
                                    <td>2024/01/01</td>
                                    <td><span class="badge badge-success">啟用中</span></td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editAccount('陳管理員')">編輯</button>
                                        <button class="btn btn-outline btn-sm" onclick="resetPassword('陳管理員')">重置密碼</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>王店長</td>
                                    <td>0912-345-678</td>
                                    <td><span class="badge badge-primary">仲介店長</span></td>
                                    <td>信義門店</td>
                                    <td>2024/06/15</td>
                                    <td><span class="badge badge-success">啟用中</span></td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editAccount('王店長')">編輯</button>
                                        <button class="btn btn-outline btn-sm" onclick="resetPassword('王店長')">重置密碼</button>
                                        <button class="btn btn-danger btn-sm" onclick="disableAccount('王店長')">停用</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>張主管</td>
                                    <td>0923-456-789</td>
                                    <td><span class="badge badge-info">代銷主管</span></td>
                                    <td>信義之星案場</td>
                                    <td>2024/08/20</td>
                                    <td><span class="badge badge-success">啟用中</span></td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editAccount('張主管')">編輯</button>
                                        <button class="btn btn-outline btn-sm" onclick="resetPassword('張主管')">重置密碼</button>
                                        <button class="btn btn-danger btn-sm" onclick="disableAccount('張主管')">停用</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>李小華</td>
                                    <td>0934-567-890</td>
                                    <td><span class="badge badge-secondary">仲介業務</span></td>
                                    <td>信義門店</td>
                                    <td>2024/09/10</td>
                                    <td><span class="badge badge-success">啟用中</span></td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editAccount('李小華')">編輯</button>
                                        <button class="btn btn-outline btn-sm" onclick="resetPassword('李小華')">重置密碼</button>
                                        <button class="btn btn-danger btn-sm" onclick="disableAccount('李小華')">停用</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>劉營運</td>
                                    <td>0900-000-002</td>
                                    <td><span class="role-badge role-ops">Platform Ops</span></td>
                                    <td>平台營運部</td>
                                    <td>2024/03/15</td>
                                    <td><span class="badge badge-success">啟用中</span></td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editAccount('劉營運')">編輯</button>
                                        <button class="btn btn-outline btn-sm" onclick="resetPassword('劉營運')">重置密碼</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                        </div>

                        <!-- Panel: 機構建檔審核（門店 / 代銷 / 建案入駐） -->
                        <div class="tab-panel" data-tab-panel="org_audit">
                            <div class="alert alert-info" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>此處對應規格書 10.3.1：門店 / 代銷 / 建案建檔審核（待審 → 通過/拒絕 → 留痕）</span>
                            </div>

                            <div class="search-bar">
                                <select class="form-control" style="width: auto;" id="orgAuditTypeFilter">
                                    <option value="">全部類型</option>
                                    <option value="store">門店</option>
                                    <option value="developer">代銷</option>
                                    <option value="project">建案</option>
                                </select>
                                <select class="form-control" style="width: auto;" id="orgAuditStatusFilter">
                                    <option value="">全部狀態</option>
                                    <option value="pending">待審</option>
                                    <option value="approved">已通過</option>
                                    <option value="rejected">已拒絕</option>
                                </select>
                                <input type="text" class="search-input" id="orgAuditKeyword" placeholder="搜尋機構名稱、負責人、手機...">
                                <button class="btn btn-primary" onclick="renderOrgAuditTable()">搜尋</button>
                            </div>

                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>申請單號</th>
                                            <th>類型</th>
                                            <th>機構名稱</th>
                                            <th>負責人</th>
                                            <th>手機</th>
                                            <th>送審時間</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orgAuditTbody"></tbody>
                                </table>
                            </div>

                            <div class="card" style="margin-top: 16px;">
                                <div class="card-header">
                                    <h3 class="card-title" style="font-size: 16px;">審核紀錄（Audit Log）</h3>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>時間</th>
                                                <th>單號</th>
                                                <th>動作</th>
                                                <th>操作人</th>
                                                <th>備註</th>
                                            </tr>
                                        </thead>
                                        <tbody id="orgAuditLogTbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: 停權 / 黑名單 -->
                        <div class="tab-panel" data-tab-panel="blacklist">
                            <div class="alert alert-warning" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>此處補齊：停權時間、恢復條件、黑名單自動標記（依風控規則/工單結果）與人工覆寫。</span>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title" style="font-size: 16px;">快速停權</h3>
                                        <button class="btn btn-danger btn-sm" onclick="openModal('suspendModal')">新增停權</button>
                                    </div>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>對象</th>
                                                    <th>類型</th>
                                                    <th>停權至</th>
                                                    <th>狀態</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="suspensionTbody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title" style="font-size: 16px;">黑名單（自動標記 + 人工覆寫）</h3>
                                        <button class="btn btn-outline btn-sm" onclick="openModal('blacklistRuleModal')">自動標記規則</button>
                                    </div>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>對象</th>
                                                    <th>類型</th>
                                                    <th>標記來源</th>
                                                    <th>原因</th>
                                                    <th>狀態</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="blacklistTbody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: RBAC Matrix -->
                        <div class="tab-panel" data-tab-panel="rbac">
                            <div class="alert alert-info" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>以矩陣方式定義角色可存取模組（讀/寫/審核）。此版本為前端示意，後端落地時對應 RBAC 表結構與審計日誌。</span>
                            </div>

                            <div class="search-bar">
                                <select class="form-control" style="width: auto;" id="rbacRoleSelect" onchange="renderRbacMatrix()">
                                    <option value="super_admin">Super Admin</option>
                                    <option value="platform_ops">Platform Ops</option>
                                    <option value="platform_finance">Platform Finance</option>
                                    <option value="platform_cs">Platform CS</option>
                                </select>
                                <button class="btn btn-primary" onclick="saveRbacMatrix()">儲存矩陣</button>
                            </div>

                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 220px;">模組</th>
                                            <th>讀取</th>
                                            <th>寫入</th>
                                            <th>審核</th>
                                            <th>說明</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rbacMatrixTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- 頁面2-1: 合約與歸因中心（10.3.2） -->
            <div id="contracts" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">合約與歸因中心</h3>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline btn-sm" onclick="openModal('ruleVersionModal')">規則版本（生效日）</button>
                            <button class="btn btn-primary" onclick="openModal('contractModal')">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                新增合約
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>此頁補齊 10.3.2：合約生命週期、歸因綁定、分潤/獎金規則、版本化（不可溯及既往）。</span>
                    </div>

                    <div class="tabs" style="margin-top: 16px;">
                        <button class="tab active" data-tab="contract_lifecycle">合約生命週期</button>
                        <button class="tab" data-tab="attribution">歸因規則配置</button>
                        <button class="tab" data-tab="revshare">分潤與獎金設定</button>
                        <button class="tab" data-tab="rule_versions">版本與生效日</button>
                    </div>

                    <div class="tab-panels" style="margin-top: 16px;">
                        <div class="tab-panel active" data-tab-panel="contract_lifecycle">
                            <div class="search-bar">
                                <select class="form-control" style="width: auto;" id="contractTypeFilter">
                                    <option value="">全部合約類型</option>
                                    <option value="store">門店合約</option>
                                    <option value="project">建案合約</option>
                                </select>
                                <select class="form-control" style="width: auto;" id="contractStatusFilter">
                                    <option value="">全部狀態</option>
                                    <option value="active">有效</option>
                                    <option value="terminated">已終止</option>
                                    <option value="draft">草稿</option>
                                </select>
                                <input type="text" class="search-input" id="contractKeyword" placeholder="搜尋合約編號、機構名稱...">
                                <button class="btn btn-primary" onclick="renderContractTable()">搜尋</button>
                            </div>

                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>合約編號</th>
                                            <th>類型</th>
                                            <th>對象</th>
                                            <th>平台業務</th>
                                            <th>生效日</th>
                                            <th>終止日</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contractTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="attribution">
                            <div class="alert alert-info" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span>支援：單邊歸因（門店或建案）、雙邊歸因（門店+建案）、權重歸因（可配置比例）。</span>
                            </div>

                            <button class="btn btn-primary" onclick="openModal('attributionModal')">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                新增歸因規則
                            </button>

                            <div class="table-container" style="margin-top: 12px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>規則 ID</th>
                                            <th>模式</th>
                                            <th>門店</th>
                                            <th>建案</th>
                                            <th>權重（門店/建案）</th>
                                            <th>平台業務</th>
                                            <th>生效日</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attributionTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="revshare">
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title" style="font-size: 16px;">分潤規則（示意）</h3>
                                        <button class="btn btn-primary btn-sm" onclick="openModal('revshareModal')">設定分潤比例</button>
                                    </div>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>版本</th>
                                                    <th>生效日</th>
                                                    <th>門店%</th>
                                                    <th>代銷%</th>
                                                    <th>平台%</th>
                                                </tr>
                                            </thead>
                                            <tbody id="revshareTbody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title" style="font-size: 16px;">獎金階梯（示意）</h3>
                                        <button class="btn btn-primary btn-sm" onclick="openModal('bonusModal')">設定獎金階梯</button>
                                    </div>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>版本</th>
                                                    <th>生效日</th>
                                                    <th>門檻（成交件數）</th>
                                                    <th>獎金（NTD）</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bonusTbody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="rule_versions">
                            <div class="alert alert-warning" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span>規則版本需有生效日，且不可溯及既往：新版本僅影響生效日後的結算/報表/風控。</span>
                            </div>

                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>規則類型</th>
                                            <th>版本</th>
                                            <th>生效日</th>
                                            <th>狀態</th>
                                            <th>內容摘要</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ruleVersionTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面2-2: 工單 / 爭議中心（10.3.3） -->
            <div id="tickets" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">工單 / 爭議中心</h3>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline btn-sm" onclick="openModal('slaSettingModal')">SLA 設定</button>
                            <button class="btn btn-primary" onclick="openModal('ticketModal')">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                新增工單
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>此頁補齊 10.3.3：工單類型、SLA 追蹤、指派處理人、結案原因，以及自動掛載事件紀錄（避免人工作業）。</span>
                    </div>

                    <div class="tabs" style="margin-top: 16px;">
                        <button class="tab active" data-tab="ticket_all">全部</button>
                        <button class="tab" data-tab="ticket_open">處理中</button>
                        <button class="tab" data-tab="ticket_overdue">逾期</button>
                        <button class="tab" data-tab="ticket_closed">已結案</button>
                    </div>

                    <div class="search-bar" style="margin-top: 16px;">
                        <select class="form-control" style="width: auto;" id="ticketTypeFilter">
                            <option value="">全部類型</option>
                            <option value="no_reply">案場未回覆/超時</option>
                            <option value="wrong_phone">電話資訊錯誤</option>
                            <option value="content_error">內容缺漏/錯誤</option>
                            <option value="dispute_booking">報備爭議（撞客）</option>
                            <option value="dispute_commission">結佣爭議（金額/逾期）</option>
                        </select>
                        <select class="form-control" style="width: auto;" id="ticketOwnerFilter">
                            <option value="">全部處理人</option>
                            <option value="ops">營運</option>
                            <option value="finance">財務</option>
                            <option value="cs">客服</option>
                        </select>
                        <input type="text" class="search-input" id="ticketKeyword" placeholder="搜尋工單編號、案場、門店...">
                        <button class="btn btn-primary" onclick="renderTicketTable()">搜尋</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>工單編號</th>
                                    <th>類型</th>
                                    <th>關聯事件</th>
                                    <th>建立時間</th>
                                    <th>SLA 截止</th>
                                    <th>處理人</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ticketTbody"></tbody>
                        </table>
                    </div>

                    <div class="card" style="margin-top: 16px;">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 16px;">事件紀錄（自動掛載）</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>時間</th>
                                        <th>事件</th>
                                        <th>來源</th>
                                        <th>摘要</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketEventTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面2-3: 財務結算中心（10.3.4） -->
            <div id="finance" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">財務結算中心</h3>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline btn-sm" onclick="openModal('calcEngineModal')">計算引擎（版本化）</button>
                            <button class="btn btn-primary" onclick="generateArAp()">生成應收/應付</button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>此頁補齊 10.3.4：AR/AP、收付款確認、逾期催收流程、對帳單匯出（門店/建案/平台業務）。</span>
                    </div>

                    <div class="tabs" style="margin-top: 16px;">
                        <button class="tab active" data-tab="ar">應收（AR）</button>
                        <button class="tab" data-tab="ap">應付（AP）</button>
                        <button class="tab" data-tab="collections">催收流程</button>
                        <button class="tab" data-tab="reconcile">對帳單匯出</button>
                    </div>

                    <div class="tab-panels" style="margin-top: 16px;">
                        <div class="tab-panel active" data-tab-panel="ar">
                            <div class="search-bar">
                                <select class="form-control" style="width: auto;" id="arStatusFilter">
                                    <option value="">全部狀態</option>
                                    <option value="unpaid">未收</option>
                                    <option value="paid">已收</option>
                                    <option value="overdue">逾期</option>
                                </select>
                                <input type="text" class="search-input" id="arKeyword" placeholder="搜尋對象、單號...">
                                <button class="btn btn-primary" onclick="renderArTable()">搜尋</button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>AR 單號</th>
                                            <th>對象</th>
                                            <th>期間</th>
                                            <th>金額</th>
                                            <th>到期日</th>
                                            <th>狀態</th>
                                            <th>收款確認</th>
                                        </tr>
                                    </thead>
                                    <tbody id="arTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="ap">
                            <div class="search-bar">
                                <select class="form-control" style="width: auto;" id="apStatusFilter">
                                    <option value="">全部狀態</option>
                                    <option value="unpaid">未付</option>
                                    <option value="paid">已付</option>
                                </select>
                                <input type="text" class="search-input" id="apKeyword" placeholder="搜尋對象、單號...">
                                <button class="btn btn-primary" onclick="renderApTable()">搜尋</button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>AP 單號</th>
                                            <th>對象</th>
                                            <th>期間</th>
                                            <th>金額</th>
                                            <th>付款日</th>
                                            <th>狀態</th>
                                            <th>付款確認</th>
                                        </tr>
                                    </thead>
                                    <tbody id="apTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="collections">
                            <div class="alert alert-warning" style="margin-bottom: 16px;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span>催收流程：提醒 → 催告 → 升級（法務/主管）。此區提供逾期單與催告紀錄。</span>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>AR 單號</th>
                                            <th>對象</th>
                                            <th>逾期天數</th>
                                            <th>目前階段</th>
                                            <th>下一步</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="collectionTbody"></tbody>
                                </table>
                            </div>

                            <div class="card" style="margin-top: 16px;">
                                <div class="card-header">
                                    <h3 class="card-title" style="font-size: 16px;">催告紀錄</h3>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>時間</th>
                                                <th>AR 單號</th>
                                                <th>階段</th>
                                                <th>動作</th>
                                                <th>操作人</th>
                                                <th>備註</th>
                                            </tr>
                                        </thead>
                                        <tbody id="collectionLogTbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="reconcile">
                            <div style="display:flex; gap:8px; flex-wrap: wrap;">
                                <button class="btn btn-outline" onclick="exportStatement('store')">匯出門店對帳單</button>
                                <button class="btn btn-outline" onclick="exportStatement('project')">匯出建案對帳單</button>
                                <button class="btn btn-outline" onclick="exportStatement('sales')">匯出平台業務對帳單</button>
                            </div>
                            <div class="card" style="margin-top: 16px;">
                                <div class="card-header">
                                    <h3 class="card-title" style="font-size: 16px;">匯出紀錄</h3>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>時間</th>
                                                <th>類型</th>
                                                <th>期間</th>
                                                <th>操作者</th>
                                                <th>狀態</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statementLogTbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面2-4: 風控中心（10.3.5） -->
            <div id="risk" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">風控中心</h3>
                        <button class="btn btn-outline" onclick="refreshRiskSignals()">刷新監控</button>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>補齊：代銷案場 SLA 長期不達標、拒絕率異常等監控與人工處置入口（停權/限額/需審核）。</span>
                    </div>

                    <div class="tabs" style="margin-top: 16px;">
                        <button class="tab active" data-tab="risk_projects">案場異常</button>
                        <button class="tab" data-tab="risk_stores">門店/業務異常</button>
                        <button class="tab" data-tab="risk_actions">處置紀錄</button>
                    </div>

                    <div class="tab-panels" style="margin-top: 16px;">
                        <div class="tab-panel active" data-tab-panel="risk_projects">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>案場</th>
                                            <th>代銷</th>
                                            <th>SLA 達標率（30天）</th>
                                            <th>拒絕率（30天）</th>
                                            <th>訊號</th>
                                            <th>建議處置</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riskProjectTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="risk_stores">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>門店/業務</th>
                                            <th>類型</th>
                                            <th>大量報備</th>
                                            <th>取消率</th>
                                            <th>爽約率</th>
                                            <th>訊號</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riskStoreTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-panel" data-tab-panel="risk_actions">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>時間</th>
                                            <th>對象</th>
                                            <th>訊號</th>
                                            <th>處置</th>
                                            <th>操作人</th>
                                            <th>備註</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riskActionTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面3: 案源管理 -->
            <div id="projects" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">案源（建案）管理</h3>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            新增案源
                        </button>
                    </div>

                    <!-- 搜尋欄 -->
                    <div class="search-bar">
                        <select class="form-control" style="width: auto;">
                            <option value="">全部狀態</option>
                            <option value="active">可報備</option>
                            <option value="paused">暫停報備</option>
                            <option value="closed">已結案</option>
                        </select>
                        <select class="form-control" style="width: auto;">
                            <option value="">全部顯示狀態</option>
                            <option value="online">已上架</option>
                            <option value="offline">未上架</option>
                        </select>
                        <input type="text" class="search-input" placeholder="搜尋案名、地址...">
                        <button class="btn btn-primary">搜尋</button>
                    </div>

                    <!-- 案源列表 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>案名</th>
                                    <th>地址</th>
                                    <th>代銷單位</th>
                                    <th>報備狀態</th>
                                    <th>前台顯示</th>
                                    <th>本月報備數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>信義之星</td>
                                    <td>信義區忠孝東路五段</td>
                                    <td>信義代銷</td>
                                    <td><span class="badge badge-success">可報備</span></td>
                                    <td><span class="badge badge-success">已上架</span></td>
                                    <td>28</td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editProject('信義之星')">編輯</button>
                                        <button class="btn btn-warning btn-sm" onclick="pauseProject('信義之星')">暫停報備</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>松山新城</td>
                                    <td>松山區南京東路四段</td>
                                    <td>松山代銷</td>
                                    <td><span class="badge badge-success">可報備</span></td>
                                    <td><span class="badge badge-success">已上架</span></td>
                                    <td>22</td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editProject('松山新城')">編輯</button>
                                        <button class="btn btn-warning btn-sm" onclick="pauseProject('松山新城')">暫停報備</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>大安華廈</td>
                                    <td>大安區復興南路一段</td>
                                    <td>大安代銷</td>
                                    <td><span class="badge badge-warning">暫停報備</span></td>
                                    <td><span class="badge badge-success">已上架</span></td>
                                    <td>0</td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editProject('大安華廈')">編輯</button>
                                        <button class="btn btn-success btn-sm" onclick="resumeProject('大安華廈')">恢復報備</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>內湖科技園區</td>
                                    <td>內湖區瑞光路</td>
                                    <td>內湖代銷</td>
                                    <td><span class="badge badge-success">可報備</span></td>
                                    <td><span class="badge badge-secondary">未上架</span></td>
                                    <td>15</td>
                                    <td>
                                        <button class="btn btn-outline btn-sm" onclick="editProject('內湖科技園區')">編輯</button>
                                        <button class="btn btn-warning btn-sm" onclick="pauseProject('內湖科技園區')">暫停報備</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 頁面4: 報備與帶看管理 -->
            <div id="bookings" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">報備與帶看全平台管理</h3>
                        <button class="btn btn-outline btn-sm" onclick="exportAllBookings()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            匯出報表
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>平台僅稽核所有報備與帶看行為，不參與實際流程操作</span>
                    </div>

                    <!-- 狀態分頁 -->
                    <div class="tabs">
                        <button class="tab active" data-tab="all">全部 (1247)</button>
                        <button class="tab" data-tab="pending">待核可 (156)</button>
                        <button class="tab" data-tab="approved">已核可 (892)</button>
                        <button class="tab" data-tab="visited">已帶看 (234)</button>
                        <button class="tab" data-tab="cancelled">核可後取消 (45)</button>
                    </div>

                    <!-- 搜尋欄 -->
                    <div class="search-bar">
                        <select class="form-control" style="width: auto;">
                            <option value="">全部案場</option>
                            <option value="project1">信義之星</option>
                            <option value="project2">松山新城</option>
                            <option value="project3">大安華廈</option>
                        </select>
                        <select class="form-control" style="width: auto;">
                            <option value="">全部門店</option>
                            <option value="store1">信義門店</option>
                            <option value="store2">大安門店</option>
                            <option value="store3">松山門店</option>
                        </select>
                        <input type="date" class="form-control" style="width: auto;">
                        <input type="text" class="search-input" placeholder="搜尋報備編號...">
                        <button class="btn btn-primary">搜尋</button>
                    </div>

                    <!-- 報備列表 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>報備編號</th>
                                    <th>案場名稱</th>
                                    <th>仲介業務</th>
                                    <th>仲介門店</th>
                                    <th>報備時間</th>
                                    <th>核可時間</th>
                                    <th>帶看時間</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#BR202601001</td>
                                    <td>信義之星</td>
                                    <td>李小華</td>
                                    <td>信義門店</td>
                                    <td>2026/01/15 10:30</td>
                                    <td>2026/01/15 14:20</td>
                                    <td>2026/01/16 10:05</td>
                                    <td><span class="badge badge-success">已帶看</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewBookingDetail('BR202601001')">查看</button></td>
                                </tr>
                                <tr>
                                    <td>#BR202601002</td>
                                    <td>松山新城</td>
                                    <td>陳建國</td>
                                    <td>信義門店</td>
                                    <td>2026/01/16 09:15</td>
                                    <td>2026/01/16 11:30</td>
                                    <td>-</td>
                                    <td><span class="badge badge-primary">已核可</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewBookingDetail('BR202601002')">查看</button></td>
                                </tr>
                                <tr>
                                    <td>#BR202601003</td>
                                    <td>大安華廈</td>
                                    <td>張美玲</td>
                                    <td>大安門店</td>
                                    <td>2026/01/17 14:20</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td><span class="badge badge-warning">待核可</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewBookingDetail('BR202601003')">查看</button></td>
                                </tr>
                                <tr>
                                    <td>#BR202601004</td>
                                    <td>信義之星</td>
                                    <td>王小明</td>
                                    <td>松山門店</td>
                                    <td>2026/01/14 11:20</td>
                                    <td>2026/01/14 13:45</td>
                                    <td>-</td>
                                    <td><span class="badge badge-danger">核可後取消</span></td>
                                    <td><button class="btn btn-outline btn-sm" onclick="viewBookingDetail('BR202601004')">查看</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 頁面5: 制度參數設定 -->
            <div id="settings" class="page-content">
                <div class="alert alert-danger">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div>
                        <strong>重要提醒</strong>
                        <p style="margin-top: 4px; font-size: 14px;">制度參數調整將影響全平台運作，僅 Super Admin 可修改，請謹慎操作</p>
                    </div>
                </div>

                <!-- 報備規則 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">報備規則設定</h3>
                        <button class="btn btn-primary" onclick="editSettings('booking')">修改設定</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">保護期設定</div>
                            </div>
                            <div class="param-value">14 天</div>
                            <div class="param-desc">報備核可後的保護期限，範圍：7-30 天</div>
                        </div>
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">報備限制</div>
                            </div>
                            <div class="param-value">1 次/日</div>
                            <div class="param-desc">同一買家每日可報備次數限制</div>
                        </div>
                    </div>
                </div>

                <!-- 狀態門檻 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">KPI 門檻設定</h3>
                        <button class="btn btn-primary" onclick="editSettings('threshold')">修改設定</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">取消率警示門檻</div>
                            </div>
                            <div class="param-value">30%</div>
                            <div class="param-desc">核可後取消率超過此值將發出警示</div>
                        </div>
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">取消率嚴重門檻</div>
                            </div>
                            <div class="param-value">50%</div>
                            <div class="param-desc">核可後取消率超過此值將標記為高風險</div>
                        </div>
                    </div>
                </div>

                <!-- SLA 設定 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">SLA 回應時間設定</h3>
                        <button class="btn btn-primary" onclick="editSettings('sla')">修改設定</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">代銷審核時限</div>
                            </div>
                            <div class="param-value">24 小時</div>
                            <div class="param-desc">代銷需在此時間內回應報備申請</div>
                        </div>
                        <div class="param-card">
                            <div class="param-header">
                                <div class="param-title">客服回應時限</div>
                            </div>
                            <div class="param-value">2 小時</div>
                            <div class="param-desc">客服需在此時間內回應用戶問題</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面6: 統計報表與 KPI -->
            <div id="kpi" class="page-content">
                <!-- KPI 總覽 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">KPI 總覽</h3>
                        <div style="display: flex; gap: 12px;">
                            <select class="form-control" style="width: auto;">
                                <option value="month">本月</option>
                                <option value="quarter">本季</option>
                                <option value="year">本年</option>
                            </select>
                            <button class="btn btn-outline btn-sm" onclick="exportKPI()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                匯出報表
                            </button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">報備轉換率</div>
                            </div>
                            <div class="kpi-value" style="color: var(--primary-color);">71.5%</div>
                            <div class="kpi-trend trend-up">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                <span>比上月增加 5.2%</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">帶看成交率</div>
                            </div>
                            <div class="kpi-value" style="color: var(--success-color);">26.2%</div>
                            <div class="kpi-trend trend-up">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                <span>比上月增加 2.8%</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">核可後取消率</div>
                            </div>
                            <div class="kpi-value" style="color: var(--danger-color);">5.0%</div>
                            <div class="kpi-trend trend-down">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                </svg>
                                <span>比上月減少 1.2%</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">平均審核時間</div>
                            </div>
                            <div class="kpi-value" style="color: var(--info-color);">3.2 小時</div>
                            <div class="kpi-trend trend-down">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                </svg>
                                <span>比上月減少 0.8 小時</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 門店排行榜 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">門店成交排行榜</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>門店名稱</th>
                                    <th>報備數</th>
                                    <th>帶看數</th>
                                    <th>成交數</th>
                                    <th>成交率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: 700; color: #fbbf24;">🥇 1</td>
                                    <td>信義門店</td>
                                    <td>156</td>
                                    <td>112</td>
                                    <td>32</td>
                                    <td><span class="badge badge-success">28.6%</span></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 700; color: #9ca3af;">🥈 2</td>
                                    <td>大安門店</td>
                                    <td>128</td>
                                    <td>95</td>
                                    <td>26</td>
                                    <td><span class="badge badge-success">27.4%</span></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 700; color: #cd7f32;">🥉 3</td>
                                    <td>松山門店</td>
                                    <td>98</td>
                                    <td>72</td>
                                    <td>18</td>
                                    <td><span class="badge badge-success">25.0%</span></td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>內湖門店</td>
                                    <td>85</td>
                                    <td>58</td>
                                    <td>14</td>
                                    <td><span class="badge badge-primary">24.1%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 業務排行榜 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">業務成交排行榜（TOP 10）</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>業務姓名</th>
                                    <th>門店</th>
                                    <th>成交數</th>
                                    <th>成交金額</th>
                                    <th>取消率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: 700; color: #fbbf24;">🥇 1</td>
                                    <td>李小華</td>
                                    <td>信義門店</td>
                                    <td>8</td>
                                    <td>NT$ 2,400萬</td>
                                    <td><span class="badge badge-success">3%</span></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 700; color: #9ca3af;">🥈 2</td>
                                    <td>陳建國</td>
                                    <td>信義門店</td>
                                    <td>6</td>
                                    <td>NT$ 1,950萬</td>
                                    <td><span class="badge badge-success">5%</span></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 700; color: #cd7f32;">🥉 3</td>
                                    <td>張美玲</td>
                                    <td>大安門店</td>
                                    <td>5</td>
                                    <td>NT$ 1,680萬</td>
                                    <td><span class="badge badge-success">8%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 頁面7: 數據分析 -->
            <div id="analytics" class="page-content">
                <!-- 筛选控制 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">數據分析篩選</h3>
                    </div>
                    <div class="search-bar">
                        <select class="form-control" style="width: auto;">
                            <option value="">全部建案</option>
                            <option value="project1">信義之星</option>
                            <option value="project2">松山新城</option>
                            <option value="project3">大安華廈</option>
                            <option value="project4">內湖科技園區</option>
                        </select>
                        <select class="form-control" style="width: auto;" onchange="updateAnalyticsPeriod(this.value)">
                            <option value="week">本週</option>
                            <option value="month" selected>本月</option>
                            <option value="quarter">本季</option>
                            <option value="halfyear">半年</option>
                            <option value="year">本年</option>
                        </select>
                        <input type="date" class="form-control" style="width: auto;" placeholder="開始日期">
                        <input type="date" class="form-control" style="width: auto;" placeholder="結束日期">
                        <button class="btn btn-primary">查詢</button>
                        <button class="btn btn-outline btn-sm" onclick="exportAnalytics()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            匯出分析報表
                        </button>
                    </div>
                </div>

                <!-- 模組 A: 成交總覽分析 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📊 模組 A: 成交總覽分析</h3>
                        <span class="badge badge-info">本月數據</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: #0ea5e9;">
                            <div class="stat-label">成交件數</div>
                            <div class="stat-value">28</div>
                            <div class="stat-change">↑ 比上月增加 12%</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #10b981;">
                            <div class="stat-label">成交總金額 (GTV)</div>
                            <div class="stat-value">NT$ 8.4億</div>
                            <div class="stat-change">↑ 比上月增加 18%</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #f59e0b;">
                            <div class="stat-label">業績總額</div>
                            <div class="stat-value">NT$ 2,520萬</div>
                            <div class="stat-change">佣金率 3%</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #8b5cf6;">
                            <div class="stat-label">平均成交單價</div>
                            <div class="stat-value">NT$ 68萬/坪</div>
                            <div class="stat-change">↑ 比上月增加 5%</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #ec4899;">
                            <div class="stat-label">平均成交總價</div>
                            <div class="stat-value">NT$ 3,000萬</div>
                            <div class="stat-change">區間 1,500-5,000萬</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #06b6d4;">
                            <div class="stat-label">平均銷售週期</div>
                            <div class="stat-value">42 天</div>
                            <div class="stat-change">↓ 比上月減少 8天</div>
                        </div>
                    </div>

                    <!-- 趨勢圖區域 -->
                    <div style="margin-top: 24px; background: var(--bg-color); padding: 24px; border-radius: 12px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">成交件數 / 成交金額趨勢</h4>
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 12px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                                <p>雙軸趨勢折線圖</p>
                                <p style="font-size: 12px;">（實際環境將整合 Chart.js 或 ECharts）</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模組 B: 行政區成交分布分析 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🗺️ 模組 B: 行政區成交分布分析</h3>
                    </div>

                    <!-- 地圖視覺化區域 -->
                    <div style="margin-bottom: 24px; background: var(--bg-color); padding: 24px; border-radius: 12px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">台北市行政區熱力圖</h4>
                        <div style="height: 400px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 12px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                                <p>行政區熱力地圖</p>
                                <p style="font-size: 12px;">（整合 Leaflet.js 或 Google Maps API）</p>
                            </div>
                        </div>
                    </div>

                    <!-- 行政區排行榜 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--success-color);">🔥 成交量 TOP 5</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>行政區</th>
                                            <th>成交件數</th>
                                            <th>成交金額</th>
                                            <th>平均單價</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>大安區</td>
                                            <td><strong>8件</strong></td>
                                            <td>NT$ 2.4億</td>
                                            <td>NT$ 82萬/坪</td>
                                        </tr>
                                        <tr>
                                            <td>信義區</td>
                                            <td><strong>7件</strong></td>
                                            <td>NT$ 2.1億</td>
                                            <td>NT$ 88萬/坪</td>
                                        </tr>
                                        <tr>
                                            <td>松山區</td>
                                            <td><strong>6件</strong></td>
                                            <td>NT$ 1.8億</td>
                                            <td>NT$ 65萬/坪</td>
                                        </tr>
                                        <tr>
                                            <td>中山區</td>
                                            <td><strong>4件</strong></td>
                                            <td>NT$ 1.2億</td>
                                            <td>NT$ 72萬/坪</td>
                                        </tr>
                                        <tr>
                                            <td>內湖區</td>
                                            <td><strong>3件</strong></td>
                                            <td>NT$ 0.9億</td>
                                            <td>NT$ 58萬/坪</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">📉 成交量 BOTTOM 3</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>行政區</th>
                                            <th>成交件數</th>
                                            <th>成交金額</th>
                                            <th>平均單價</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>文山區</td>
                                            <td>0件</td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                        <tr>
                                            <td>南港區</td>
                                            <td>0件</td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                        <tr>
                                            <td>北投區</td>
                                            <td>0件</td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 洞察提示 -->
                    <div class="alert alert-info" style="margin-top: 24px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <strong>數據洞察：</strong>
                            <p style="margin-top: 4px; font-size: 14px;">
                                大安區與信義區去化速度最快，但信義區單價較高；松山區量大但單價較低，適合調整產品配置。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 模組 C: 總價帶分布分析 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">💰 模組 C: 總價帶分布分析（產品定位核心）</h3>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- 分布長條圖 -->
                        <div style="background: var(--bg-color); padding: 24px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">總價帶成交分布</h4>
                            <div style="height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                                <div style="text-align: center; color: var(--text-secondary);">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 8px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p style="font-size: 12px;">長條圖</p>
                                </div>
                            </div>
                        </div>

                        <!-- 占比圓餅圖 -->
                        <div style="background: var(--bg-color); padding: 24px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">總價帶占比</h4>
                            <div style="height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                                <div style="text-align: center; color: var(--text-secondary);">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 8px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                    </svg>
                                    <p style="font-size: 12px;">圓餅圖</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 總價帶詳細數據 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>總價帶區間</th>
                                    <th>成交件數</th>
                                    <th>占比</th>
                                    <th>平均銷售天數</th>
                                    <th>趨勢</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>1,000-1,500萬</strong></td>
                                    <td>3</td>
                                    <td><span class="badge badge-secondary">10.7%</span></td>
                                    <td>38天</td>
                                    <td style="color: var(--success-color);">↑</td>
                                </tr>
                                <tr style="background: #d1fae5;">
                                    <td><strong>1,500-2,000萬</strong></td>
                                    <td>10</td>
                                    <td><span class="badge badge-success">35.7%</span></td>
                                    <td>35天</td>
                                    <td style="color: var(--success-color);">↑</td>
                                </tr>
                                <tr>
                                    <td><strong>2,000-2,500萬</strong></td>
                                    <td>8</td>
                                    <td><span class="badge badge-primary">28.6%</span></td>
                                    <td>42天</td>
                                    <td style="color: var(--text-secondary);">→</td>
                                </tr>
                                <tr>
                                    <td><strong>2,500-3,000萬</strong></td>
                                    <td>5</td>
                                    <td><span class="badge badge-secondary">17.9%</span></td>
                                    <td>48天</td>
                                    <td style="color: var(--danger-color);">↓</td>
                                </tr>
                                <tr>
                                    <td><strong>3,000萬以上</strong></td>
                                    <td>2</td>
                                    <td><span class="badge badge-secondary">7.1%</span></td>
                                    <td>62天</td>
                                    <td style="color: var(--danger-color);">↓</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 產品定位建議 -->
                    <div class="alert alert-warning" style="margin-top: 24px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <strong>產品策略建議：</strong>
                            <p style="margin-top: 4px; font-size: 14px;">
                                1,500-2,000萬價帶為主力成交區間，建議加大此區間產品供應；2,500萬以上產品去化較慢，建議調整付款條件或坪數配置。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 模組 D: 格局成交分布分析 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🏠 模組 D: 格局成交分布分析</h3>
                    </div>

                    <!-- 格局分布視覺化 -->
                    <div style="background: var(--bg-color); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">格局成交分布</h4>
                        <div style="height: 280px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 8px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p style="font-size: 12px;">格局分布長條圖</p>
                            </div>
                        </div>
                    </div>

                    <!-- 格局詳細數據 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>格局類型</th>
                                    <th>成交件數</th>
                                    <th>占比</th>
                                    <th>平均成交單價</th>
                                    <th>平均銷售週期</th>
                                    <th>庫存狀況</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>1房</strong></td>
                                    <td>2</td>
                                    <td>7.1%</td>
                                    <td>NT$ 58萬/坪</td>
                                    <td>28天</td>
                                    <td><span class="badge badge-success">低風險</span></td>
                                </tr>
                                <tr style="background: #d1fae5;">
                                    <td><strong>2房</strong></td>
                                    <td>12</td>
                                    <td>42.9%</td>
                                    <td>NT$ 65萬/坪</td>
                                    <td>35天</td>
                                    <td><span class="badge badge-success">低風險</span></td>
                                </tr>
                                <tr>
                                    <td><strong>3房</strong></td>
                                    <td>10</td>
                                    <td>35.7%</td>
                                    <td>NT$ 72萬/坪</td>
                                    <td>45天</td>
                                    <td><span class="badge badge-warning">中風險</span></td>
                                </tr>
                                <tr>
                                    <td><strong>4房以上</strong></td>
                                    <td>4</td>
                                    <td>14.3%</td>
                                    <td>NT$ 85萬/坪</td>
                                    <td>58天</td>
                                    <td><span class="badge badge-danger">高風險</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 格局 x 總價帶交叉分析 -->
                    <div style="margin-top: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">格局 × 總價帶交叉分析（進階）</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>格局/總價帶</th>
                                        <th>1,000-1,500萬</th>
                                        <th>1,500-2,000萬</th>
                                        <th>2,000-2,500萬</th>
                                        <th>2,500-3,000萬</th>
                                        <th>3,000萬以上</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>1房</strong></td>
                                        <td>2</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>2房</strong></td>
                                        <td>1</td>
                                        <td>8</td>
                                        <td>3</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>3房</strong></td>
                                        <td>0</td>
                                        <td>2</td>
                                        <td>5</td>
                                        <td>3</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>4房以上</strong></td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>2</td>
                                        <td>2</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 策略洞察 -->
                    <div class="alert alert-info" style="margin-top: 24px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <div>
                            <strong>高價值洞察：</strong>
                            <p style="margin-top: 4px; font-size: 14px;">
                                2房格局賣得快但量少，建議加大供應；4房以上格局庫存風險高，與主推格局策略需重新檢視。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 模組 E: 時間趨勢與節奏分析 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📈 模組 E: 時間趨勢與節奏分析</h3>
                        <div style="display: flex; gap: 12px;">
                            <select class="form-control" style="width: auto;">
                                <option value="week">週</option>
                                <option value="month" selected>月</option>
                                <option value="quarter">季</option>
                                <option value="halfyear">半年</option>
                                <option value="year">年</option>
                            </select>
                        </div>
                    </div>

                    <!-- 趨勢折線圖 -->
                    <div style="background: var(--bg-color); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">成交件數趨勢（過去12個月）</h4>
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); border-radius: 8px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 12px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                                <p>多指標趨勢折線圖</p>
                                <p style="font-size: 12px;">（成交件數、平均單價、銷售週期）</p>
                            </div>
                        </div>
                    </div>

                    <!-- 同期對比 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">同比增長 (YoY)</div>
                            </div>
                            <div class="kpi-value" style="color: var(--success-color);">+18.5%</div>
                            <div class="kpi-trend trend-up">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                <span>去年同期成交 24 件</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">環比增長 (QoQ)</div>
                            </div>
                            <div class="kpi-value" style="color: var(--success-color);">+12.0%</div>
                            <div class="kpi-trend trend-up">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                <span>上季成交 25 件</span>
                            </div>
                        </div>
                    </div>

                    <!-- 月度數據表 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>月份</th>
                                    <th>成交件數</th>
                                    <th>環比增長</th>
                                    <th>平均成交單價</th>
                                    <th>平均銷售週期</th>
                                    <th>市場狀態</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2026年1月</td>
                                    <td>28</td>
                                    <td style="color: var(--success-color);">+12%</td>
                                    <td>NT$ 68萬/坪</td>
                                    <td>42天</td>
                                    <td><span class="badge badge-success">熱銷</span></td>
                                </tr>
                                <tr>
                                    <td>2025年12月</td>
                                    <td>25</td>
                                    <td style="color: var(--success-color);">+8%</td>
                                    <td>NT$ 65萬/坪</td>
                                    <td>45天</td>
                                    <td><span class="badge badge-success">正常</span></td>
                                </tr>
                                <tr>
                                    <td>2025年11月</td>
                                    <td>23</td>
                                    <td style="color: var(--text-secondary);">0%</td>
                                    <td>NT$ 63萬/坪</td>
                                    <td>48天</td>
                                    <td><span class="badge badge-secondary">平穩</span></td>
                                </tr>
                                <tr>
                                    <td>2025年10月</td>
                                    <td>23</td>
                                    <td style="color: var(--danger-color);">-15%</td>
                                    <td>NT$ 62萬/坪</td>
                                    <td>52天</td>
                                    <td><span class="badge badge-warning">淡季</span></td>
                                </tr>
                                <tr>
                                    <td>2025年9月</td>
                                    <td>27</td>
                                    <td style="color: var(--success-color);">+23%</td>
                                    <td>NT$ 64萬/坪</td>
                                    <td>38天</td>
                                    <td><span class="badge badge-success">旺季</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 市場分析 -->
                    <div class="alert alert-success" style="margin-top: 24px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <strong>市場節奏分析：</strong>
                            <p style="margin-top: 4px; font-size: 14px;">
                                9月為銷售高峰期（推案旺季），10月受升息影響進入淡季，11-12月逐步回升，1月開紅盤表現優異。建議把握3-5月及9-10月推案黃金期。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 進階功能預告 -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                        <h3 class="card-title" style="color: white;">🚀 進階分析功能（Phase 2/3）</h3>
                        <span class="badge" style="background: rgba(255,255,255,0.2); color: white;">即將推出</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">跨案比較分析</h4>
                            <p style="font-size: 14px; opacity: 0.9;">同行政區不同建案成交差異對比，同產品規格不同定價結果分析</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">去化模擬（AI預測）</h4>
                            <p style="font-size: 14px; opacity: 0.9;">若價格下修X%、若主推格局調整，預估去化速度變化</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">行銷策略回溯</h4>
                            <p style="font-size: 14px; opacity: 0.9;">優惠活動前後成交差異分析，推案節奏最佳化建議</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面8: 操作日誌 -->
            <div id="logs" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">操作日誌（事件帳本）</h3>
                    </div>

                    <div class="alert alert-success">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span>所有操作記錄皆不可刪改，確保流程透明可追溯</span>
                    </div>

                    <!-- 篩選器 -->
                    <div class="search-bar">
                        <select class="form-control" style="width: auto;">
                            <option value="">全部事件類型</option>
                            <option value="account_create">建立帳號</option>
                            <option value="account_edit">編輯帳號</option>
                            <option value="account_disable">停用帳號</option>
                            <option value="project_edit">編輯案源</option>
                            <option value="settings_update">修改制度參數</option>
                            <option value="booking_approve">核可報備</option>
                            <option value="booking_reject">拒絕報備</option>
                        </select>
                        <select class="form-control" style="width: auto;">
                            <option value="">全部操作角色</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="platform_ops">Platform Ops</option>
                            <option value="agent_manager">仲介店長</option>
                            <option value="developer">代銷主管</option>
                        </select>
                        <input type="date" class="form-control" style="width: auto;" value="2026-01-18">
                        <button class="btn btn-primary">查詢</button>
                    </div>

                    <!-- 日誌列表 -->
                    <div style="margin-top: 24px;">
                        <div class="log-item" style="border-left-color: #0ea5e9;">
                            <div class="log-header">
                                <div class="log-action">
                                    <span class="badge badge-primary" style="margin-right: 8px;">建立帳號</span>
                                    帳號ID：#AC202601025
                                </div>
                                <div class="log-time">2026/01/18 15:30:22</div>
                            </div>
                            <div class="log-details">
                                <span class="log-user">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    陳管理員（Super Admin）
                                </span>
                                <br>
                                <span>建立帳號：李小明 / 角色：仲介業務 / 門店：信義門店</span>
                            </div>
                        </div>

                        <div class="log-item" style="border-left-color: #f59e0b;">
                            <div class="log-header">
                                <div class="log-action">
                                    <span class="badge badge-warning" style="margin-right: 8px;">修改制度參數</span>
                                    參數類型：保護期設定
                                </div>
                                <div class="log-time">2026/01/18 14:15:10</div>
                            </div>
                            <div class="log-details">
                                <span class="log-user">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    陳管理員（Super Admin）
                                </span>
                                <br>
                                <span>Before: 7天 → After: 14天</span>
                            </div>
                        </div>

                        <div class="log-item" style="border-left-color: #ef4444;">
                            <div class="log-header">
                                <div class="log-action">
                                    <span class="badge badge-danger" style="margin-right: 8px;">停用帳號</span>
                                    帳號ID：#AC202601018
                                </div>
                                <div class="log-time">2026/01/18 10:05:33</div>
                            </div>
                            <div class="log-details">
                                <span class="log-user">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    陳管理員（Super Admin）
                                </span>
                                <br>
                                <span>停用帳號：王小明 / 原因：高取消率違規</span>
                            </div>
                        </div>

                        <div class="log-item" style="border-left-color: #10b981;">
                            <div class="log-header">
                                <div class="log-action">
                                    <span class="badge badge-success" style="margin-right: 8px;">編輯案源</span>
                                    案源ID：#PJ202601005
                                </div>
                                <div class="log-time">2026/01/18 09:45:18</div>
                            </div>
                            <div class="log-details">
                                <span class="log-user">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    劉營運（Platform Ops）
                                </span>
                                <br>
                                <span>案源：大安華廈 / 報備狀態：可報備 → 暫停報備</span>
                            </div>
                        </div>

                        <div class="log-item" style="border-left-color: #06b6d4;">
                            <div class="log-header">
                                <div class="log-action">
                                    <span class="badge badge-info" style="margin-right: 8px;">編輯帳號</span>
                                    帳號ID：#AC202601012
                                </div>
                                <div class="log-time">2026/01/17 16:20:45</div>
                            </div>
                            <div class="log-details">
                                <span class="log-user">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    陳管理員（Super Admin）
                                </span>
                                <br>
                                <span>修改帳號：張主管 / 角色：代銷人員 → 代銷主管</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: 新增帳號 -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新增帳號</h3>
            </div>
            <form id="addAccountForm">
                <div class="form-group">
                    <label class="form-label">姓名 <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" placeholder="請輸入姓名" required>
                </div>
                <div class="form-group">
                    <label class="form-label">手機號碼 <span style="color: red;">*</span></label>
                    <input type="tel" class="form-control" placeholder="0912-345-678" required>
                </div>
                <div class="form-group">
                    <label class="form-label">角色 <span style="color: red;">*</span></label>
                    <select class="form-control" required>
                        <option value="">請選擇角色</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="platform_ops">Platform Ops</option>
                        <option value="platform_cs">Platform CS</option>
                        <option value="agent_manager">仲介店長</option>
                        <option value="agent">仲介業務</option>
                        <option value="developer">代銷主管</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">門店/單位</label>
                    <input type="text" class="form-control" placeholder="若為仲介或代銷請填寫">
                </div>
                <div class="form-group">
                    <label class="form-label">預設密碼</label>
                    <input type="text" class="form-control" value="chainhouse123" readonly>
                    <small style="color: var(--text-secondary);">系統將自動產生預設密碼，並通知用戶變更</small>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addAccountModal')">取消</button>
                <button class="btn btn-primary" onclick="submitAddAccount()">確認新增</button>
            </div>
        </div>
    </div>


    <!-- Modal: 新增案源 -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新增案源</h3>
            </div>
            <form id="addProjectForm">
                <div class="form-group">
                    <label class="form-label">大主視覺照片（建案主視覺/外觀）</label>
                    <div class="uploader">
                        <div class="uploader-preview" id="projMainImagePreview">
                            <span>尚未上傳</span>
                        </div>
                        <div style="flex:1;">
                            <input id="projMainImage" type="file" class="form-control" accept="image/*">
                            <small style="color: var(--text-secondary);">建議比例 16:9 或 4:3；將用於案源卡片主視覺。</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">案名（清楚、放大） <span style="color:red;">*</span></label>
                    <input id="projName" type="text" class="form-control" placeholder="例如：信義之星" required>
                </div>

                <div class="form-group">
                    <label class="form-label">基本資訊（精簡但關鍵）</label>
                    <div class="form-row">
                        <div>
                            <label class="form-label" style="font-size: 12px; margin-bottom: 6px;">行政區 <span style="color:red;">*</span></label>
                            <input id="projDistrict" type="text" class="form-control" placeholder="例：信義區" required>
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 12px; margin-bottom: 6px;">路段 <span style="color:red;">*</span></label>
                            <input id="projRoad" type="text" class="form-control" placeholder="例：忠孝東路五段" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label class="form-label">坪數區間（例：25-45坪） <span style="color:red;">*</span></label>
                            <div class="form-row">
                                <input id="projAreaMin" type="number" class="form-control" placeholder="最小坪數" min="0" step="0.1" required>
                                <input id="projAreaMax" type="number" class="form-control" placeholder="最大坪數" min="0" step="0.1" required>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">格局（例：2-3房） <span style="color:red;">*</span></label>
                            <div class="form-row">
                                <input id="projLayoutMin" type="number" class="form-control" placeholder="最小房數" min="0" step="1" required>
                                <input id="projLayoutMax" type="number" class="form-control" placeholder="最大房數" min="0" step="1" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">總價區間（重點） <span style="color:red;">*</span></label>
                    <div class="form-row">
                        <input id="projPriceMin" type="number" class="form-control" placeholder="最小總價（萬）" min="0" step="1" required>
                        <input id="projPriceMax" type="number" class="form-control" placeholder="最大總價（萬）" min="0" step="1" required>
                    </div>
                    <small style="color: var(--text-secondary);">單位以「萬」為示意（可依你後端定義改成元）。</small>
                </div>

                <div class="form-group">
                    <label class="form-label">代銷單位</label>
                    <input id="projDev" type="text" class="form-control" placeholder="例：信義代銷">
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label class="form-label">報備狀態</label>
                            <select id="projStatus" class="form-control">
                                <option value="active">可報備</option>
                                <option value="paused">暫停報備</option>
                                <option value="closed">已結案</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">前台顯示</label>
                            <select id="projVisible" class="form-control">
                                <option value="online">已上架</option>
                                <option value="offline">未上架</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">備註</label>
                    <textarea id="projNote" class="form-control" rows="3" placeholder="可填寫特殊說明"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addProjectModal')">取消</button>
                <button class="btn btn-primary" onclick="submitAddProject()">確認新增</button>
            </div>
        </div>
    </div>

    <!-- Modal: 編輯案源 -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">編輯案源</h3>
            </div>
            <form id="editProjectForm">
                <input type="hidden" id="editProjId">
                <div class="form-group">
                    <label class="form-label">大主視覺照片（建案主視覺/外觀）</label>
                    <div class="uploader">
                        <div class="uploader-preview" id="editProjMainImagePreview">
                            <span>尚未上傳</span>
                        </div>
                        <div style="flex:1;">
                            <input id="editProjMainImage" type="file" class="form-control" accept="image/*">
                            <small style="color: var(--text-secondary);">可重新上傳主視覺（不選檔則保留原圖）。</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">案名（清楚、放大） <span style="color:red;">*</span></label>
                    <input id="editProjName" type="text" class="form-control" placeholder="例如：信義之星" required>
                </div>

                <div class="form-group">
                    <label class="form-label">基本資訊（精簡但關鍵）</label>
                    <div class="form-row">
                        <div>
                            <label class="form-label" style="font-size: 12px; margin-bottom: 6px;">行政區 <span style="color:red;">*</span></label>
                            <input id="editProjDistrict" type="text" class="form-control" placeholder="例：信義區" required>
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 12px; margin-bottom: 6px;">路段 <span style="color:red;">*</span></label>
                            <input id="editProjRoad" type="text" class="form-control" placeholder="例：忠孝東路五段" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label class="form-label">坪數區間（例：25-45坪） <span style="color:red;">*</span></label>
                            <div class="form-row">
                                <input id="editProjAreaMin" type="number" class="form-control" placeholder="最小坪數" min="0" step="0.1" required>
                                <input id="editProjAreaMax" type="number" class="form-control" placeholder="最大坪數" min="0" step="0.1" required>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">格局（例：2-3房） <span style="color:red;">*</span></label>
                            <div class="form-row">
                                <input id="editProjLayoutMin" type="number" class="form-control" placeholder="最小房數" min="0" step="1" required>
                                <input id="editProjLayoutMax" type="number" class="form-control" placeholder="最大房數" min="0" step="1" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">總價區間（重點） <span style="color:red;">*</span></label>
                    <div class="form-row">
                        <input id="editProjPriceMin" type="number" class="form-control" placeholder="最小總價（萬）" min="0" step="1" required>
                        <input id="editProjPriceMax" type="number" class="form-control" placeholder="最大總價（萬）" min="0" step="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">代銷單位</label>
                    <input id="editProjDev" type="text" class="form-control" placeholder="例：信義代銷">
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label class="form-label">報備狀態</label>
                            <select id="editProjStatus" class="form-control">
                                <option value="active">可報備</option>
                                <option value="paused">暫停報備</option>
                                <option value="closed">已結案</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">前台顯示</label>
                            <select id="editProjVisible" class="form-control">
                                <option value="online">已上架</option>
                                <option value="offline">未上架</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">備註</label>
                    <textarea id="editProjNote" class="form-control" rows="3" placeholder="可填寫特殊說明"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editProjectModal')">取消</button>
                <button class="btn btn-primary" onclick="submitEditProject()">儲存更新</button>
            </div>
        </div>
    </div>

    <!-- Modal: 案源詳細（點案名/卡片） -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">案源詳細</h3>
            </div>
            <div style="display:flex; gap:16px; align-items:flex-start;">
                <div class="uploader-preview" id="detailMainImage" style="width: 220px; height: 150px;"><span>無圖片</span></div>
                <div style="flex:1;">
                    <div style="font-size: 20px; font-weight: 800; margin-bottom: 8px;" id="detailName">-</div>
                    <div style="color: var(--text-secondary); margin-bottom: 10px;" id="detailAddr">-</div>
                    <div class="form-row-3" style="margin-bottom: 10px;">
                        <div class="card" style="padding: 12px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">坪數區間</div>
                            <div style="font-weight: 800;" id="detailArea">-</div>
                        </div>
                        <div class="card" style="padding: 12px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">格局</div>
                            <div style="font-weight: 800;" id="detailLayout">-</div>
                        </div>
                        <div class="card" style="padding: 12px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">總價區間</div>
                            <div style="font-weight: 800;" id="detailPrice">-</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap: wrap;">
                        <span class="badge badge-success" id="detailStatusBadge">-</span>
                        <span class="badge badge-secondary" id="detailVisibleBadge">-</span>
                        <span class="badge badge-secondary" id="detailDevBadge">-</span>
                    </div>
                    <div style="margin-top: 12px; color: var(--text-secondary);" id="detailNote"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('projectDetailModal')">關閉</button>
            </div>
        </div>
    </div>


    <!-- Modal: 停用帳號 -->
<div id="disableAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">停用帳號</h3>
            </div>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">確定要停用 <strong id="disable-account-name"></strong> 的帳號嗎？</p>
            <form id="disableAccountForm">
                <div class="form-group">
                    <label class="form-label">停用原因 <span style="color: red;">*</span></label>
                    <select class="form-control" required>
                        <option value="">請選擇停用原因</option>
                        <option value="violation">違反平台規範</option>
                        <option value="fraud">疑似詐欺行為</option>
                        <option value="high_cancel">高取消率</option>
                        <option value="inactive">長期未使用</option>
                        <option value="resign">已離職</option>
                        <option value="other">其他原因</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">詳細說明</label>
                    <textarea class="form-control" rows="4" placeholder="請詳細說明停用原因"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('disableAccountModal')">取消</button>
                <button class="btn btn-danger" onclick="submitDisableAccount()">確認停用</button>
            </div>
        </div>
    </div>

    <!-- ===== 新增：10.3.x 擴充模組 Modal 群 ===== -->

    <!-- Modal: 停權設定 -->
    <div id="suspendModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">停權設定</h3>
            </div>
            <form id="suspendForm">
                <div class="form-group">
                    <label class="form-label">對象</label>
                    <input type="text" class="form-control" id="suspendTarget" placeholder="門店 / 代銷 / 建案 / 帳號" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">停權原因 <span style="color:red;">*</span></label>
                    <select class="form-control" id="suspendReason" required>
                        <option value="">請選擇</option>
                        <option value="risk">風控異常</option>
                        <option value="violation">違規</option>
                        <option value="fraud">疑似詐欺</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">停權時間</label>
                    <div style="display:flex; gap:8px;">
                        <input type="datetime-local" class="form-control" id="suspendStart">
                        <input type="datetime-local" class="form-control" id="suspendEnd" placeholder="結束時間（可空）">
                    </div>
                    <small style="color: var(--text-secondary);">若未填結束時間，視為無限期停權（需手動恢復）。</small>
                </div>
                <div class="form-group">
                    <label class="form-label">恢復條件（可選）</label>
                    <textarea class="form-control" rows="3" id="suspendRestoreRule" placeholder="例如：連續 30 天取消率 < 10% 且無爭議工單"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('suspendModal')">取消</button>
                <button class="btn btn-danger" onclick="submitSuspend()">確認停權</button>
            </div>
        </div>
    </div>

    <!-- Modal: 黑名單規則 -->
    <div id="blacklistRuleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">黑名單規則設定</h3>
            </div>
            <form id="blacklistRuleForm">
                <div class="form-group">
                    <label class="form-label">規則名稱 <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="blRuleName" placeholder="例如：拒絕率 > 40% 且持續 14 天" required>
                </div>
                <div class="form-group">
                    <label class="form-label">適用對象</label>
                    <select class="form-control" id="blRuleScope">
                        <option value="store">門店/業務</option>
                        <option value="project">案場/代銷</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">條件描述</label>
                    <textarea class="form-control" rows="3" id="blRuleCondition" placeholder="用自然語言描述，後端可再落規則"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('blacklistRuleModal')">取消</button>
                <button class="btn btn-primary" onclick="submitBlacklistRule()">儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal: 規則版本（生效日） -->
    <div id="ruleVersionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">規則版本管理（生效日）</h3>
            </div>
            <form id="ruleVersionForm">
                <div class="form-group">
                    <label class="form-label">規則類型</label>
                    <select class="form-control" id="ruleType">
                        <option value="revshare">分潤規則</option>
                        <option value="bonus">獎金規則</option>
                        <option value="sla">SLA 規則</option>
                        <option value="state">狀態機規則</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">版本號 <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="ruleVersion" placeholder="例如：v1.0.3" required>
                </div>
                <div class="form-group">
                    <label class="form-label">生效日 <span style="color:red;">*</span></label>
                    <input type="date" class="form-control" id="ruleEffectiveDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">規則內容（摘要）</label>
                    <textarea class="form-control" rows="4" id="ruleContent" placeholder="簡述本次調整；實際內容由後端存 JSON"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('ruleVersionModal')">取消</button>
                <button class="btn btn-primary" onclick="submitRuleVersion()">新增版本</button>
            </div>
        </div>
    </div>

    <!-- Modal: 合約建立/修改 -->
    <div id="contractModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="contractModalTitle">新增合約</h3>
            </div>
            <form id="contractForm">
                <input type="hidden" id="contractId">
                <div class="form-group">
                    <label class="form-label">合約類型 <span style="color:red;">*</span></label>
                    <select class="form-control" id="contractType" required>
                        <option value="store">門店合約</option>
                        <option value="project">建案合約</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">對象名稱 <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="contractTarget" placeholder="例如：信義門店 / 信義之星案" required>
                </div>
                <div class="form-group">
                    <label class="form-label">綁定平台業務</label>
                    <input type="text" class="form-control" id="contractSales" placeholder="例如：王業務">
                </div>
                <div class="form-group">
                    <label class="form-label">生效日 <span style="color:red;">*</span></label>
                    <input type="date" class="form-control" id="contractStart" required>
                </div>
                <div class="form-group">
                    <label class="form-label">終止日（可空）</label>
                    <input type="date" class="form-control" id="contractEnd">
                </div>
                <div class="form-group">
                    <label class="form-label">備註</label>
                    <textarea class="form-control" rows="3" id="contractNote"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('contractModal')">取消</button>
                <button class="btn btn-primary" onclick="submitContract()">儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal: 歸因規則 -->
    <div id="attributionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新增歸因規則</h3>
            </div>
            <form id="attributionForm">
                <div class="form-group">
                    <label class="form-label">模式</label>
                    <select class="form-control" id="attrMode">
                        <option value="single_store">單邊歸因：門店</option>
                        <option value="single_project">單邊歸因：建案</option>
                        <option value="double">雙邊歸因：門店 + 建案</option>
                        <option value="weighted">權重歸因：可配置比例</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">門店（可空）</label>
                    <input type="text" class="form-control" id="attrStore" placeholder="門店名稱">
                </div>
                <div class="form-group">
                    <label class="form-label">建案（可空）</label>
                    <input type="text" class="form-control" id="attrProject" placeholder="建案名稱">
                </div>
                <div class="form-group">
                    <label class="form-label">權重（門店 / 建案）</label>
                    <div style="display:flex; gap:8px;">
                        <input type="number" class="form-control" id="attrWStore" placeholder="門店%" min="0" max="100">
                        <input type="number" class="form-control" id="attrWProject" placeholder="建案%" min="0" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">平台業務</label>
                    <input type="text" class="form-control" id="attrSales" placeholder="平台業務姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">生效日</label>
                    <input type="date" class="form-control" id="attrStart">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('attributionModal')">取消</button>
                <button class="btn btn-primary" onclick="submitAttribution()">儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal: 分潤設定 -->
    <div id="revshareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">分潤規則設定</h3>
            </div>
            <form id="revshareForm">
                <div class="form-group">
                    <label class="form-label">版本</label>
                    <input type="text" class="form-control" id="revVersion" placeholder="例如：v1.0.0">
                </div>
                <div class="form-group">
                    <label class="form-label">生效日</label>
                    <input type="date" class="form-control" id="revStart">
                </div>
                <div class="form-group">
                    <label class="form-label">比例（門店 / 代銷 / 平台）</label>
                    <div style="display:flex; gap:8px;">
                        <input type="number" class="form-control" id="revStore" placeholder="門店%" min="0" max="100">
                        <input type="number" class="form-control" id="revDev" placeholder="代銷%" min="0" max="100">
                        <input type="number" class="form-control" id="revPlatform" placeholder="平台%" min="0" max="100">
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('revshareModal')">取消</button>
                <button class="btn btn-primary" onclick="submitRevshare()">新增版本</button>
            </div>
        </div>
    </div>

    <!-- Modal: 獎金階梯設定 -->
    <div id="bonusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">獎金階梯設定</h3>
            </div>
            <form id="bonusForm">
                <div class="form-group">
                    <label class="form-label">版本</label>
                    <input type="text" class="form-control" id="bonusVersion" placeholder="例如：v1.0.0">
                </div>
                <div class="form-group">
                    <label class="form-label">生效日</label>
                    <input type="date" class="form-control" id="bonusStart">
                </div>
                <div class="form-group">
                    <label class="form-label">門檻（成交件數）</label>
                    <input type="number" class="form-control" id="bonusThreshold" min="0" placeholder="例如：10">
                </div>
                <div class="form-group">
                    <label class="form-label">獎金（NTD）</label>
                    <input type="number" class="form-control" id="bonusAmount" min="0" placeholder="例如：50000">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bonusModal')">取消</button>
                <button class="btn btn-primary" onclick="submitBonus()">新增階梯</button>
            </div>
        </div>
    </div>

    <!-- Modal: SLA 設定 -->
    <div id="slaSettingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">SLA 規則設定</h3>
            </div>
            <form id="slaSettingForm">
                <div class="form-group">
                    <label class="form-label">版本</label>
                    <input type="text" class="form-control" id="slaVersion" placeholder="例如：v1.0.0">
                </div>
                <div class="form-group">
                    <label class="form-label">生效日</label>
                    <input type="date" class="form-control" id="slaStart">
                </div>
                <div class="form-group">
                    <label class="form-label">核可時限（分鐘）</label>
                    <input type="number" class="form-control" id="slaApproveMins" min="1" value="60">
                </div>
                <div class="form-group">
                    <label class="form-label">回覆時限（分鐘）</label>
                    <input type="number" class="form-control" id="slaReplyMins" min="1" value="30">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('slaSettingModal')">取消</button>
                <button class="btn btn-primary" onclick="submitSlaRule()">新增版本</button>
            </div>
        </div>
    </div>

    <!-- Modal: 新增/編輯工單 -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="ticketModalTitle">新增工單</h3>
            </div>
            <form id="ticketForm">
                <input type="hidden" id="ticketId">
                <div class="form-group">
                    <label class="form-label">工單類型</label>
                    <select class="form-control" id="ticketType">
                        <option value="reply_timeout">案場未回覆/超時</option>
                        <option value="phone_wrong">電話資訊錯誤</option>
                        <option value="content_missing">內容缺漏/錯誤</option>
                        <option value="report_dispute">報備爭議（撞客）</option>
                        <option value="commission_dispute">結佣爭議（金額/逾期）</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">關聯事件（可選）</label>
                    <input type="text" class="form-control" id="ticketEvent" placeholder="例如：Booking#B-2024-0001 / Deal#D-001">
                </div>
                <div class="form-group">
                    <label class="form-label">標題 <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="ticketTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">內容</label>
                    <textarea class="form-control" rows="4" id="ticketDesc"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">指派處理人</label>
                    <input type="text" class="form-control" id="ticketAssignee" placeholder="例如：客服A / 財務B">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('ticketModal')">取消</button>
                <button class="btn btn-primary" onclick="submitTicket()">儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal: 計算引擎（示意） -->
    <div id="calcEngineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">佣金/分潤計算引擎（示意）</h3>
            </div>
            <div class="alert alert-info" style="margin-bottom: 16px;">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span>此處保留 UI 與版本化入口；實際計算需後端落地（事件：DEAL_CONFIRMED → 產生 AR/AP/分潤）。</span>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('calcEngineModal')">關閉</button>
            </div>
        </div>
    </div>

    <!-- Modal: 欄位擴充 -->
    <div id="extensionFieldModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新增自定義欄位</h3>
            </div>
            <form id="extensionFieldForm">
                <div class="form-group">
                    <label class="form-label">應用範圍（Scope）</label>
                    <select class="form-control" id="extScope">
                        <option value="booking">報備</option>
                        <option value="project">建案</option>
                        <option value="store">門店</option>
                        <option value="deal">成交</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">欄位名稱 <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="extName" placeholder="例如：來客管道" required>
                </div>
                <div class="form-group">
                    <label class="form-label">欄位 Key <span style="color:red;">*</span></label>
                    <input type="text" class="form-control" id="extKey" placeholder="例如：lead_source" required>
                </div>
                <div class="form-group">
                    <label class="form-label">類型</label>
                    <select class="form-control" id="extType">
                        <option value="string">文字</option>
                        <option value="number">數字</option>
                        <option value="select">下拉選單</option>
                        <option value="date">日期</option>
                        <option value="bool">是/否</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="extRequired" style="width:18px; height:18px;">
                    <label class="form-label" style="margin:0;">必填</label>
                </div>
                <div class="form-group">
                    <label class="form-label">規則（摘要）</label>
                    <input type="text" class="form-control" id="extRule" placeholder="例如：長度<=50 / 正則 / 選項列表...">
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('extensionFieldModal')">取消</button>
                <button class="btn btn-primary" onclick="submitExtensionField()">新增</button>
            </div>
        </div>
    </div>

    <script>
        // 頁面切換
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));

                this.classList.add('active');
                const pageId = this.getAttribute('data-page');
                document.getElementById(pageId).classList.add('active');
                setSessionActive(true);
                saveActivePage(pageId);
            });
        });



        // 初始化：刷新後保留頁面（未登出情況）
        (function restoreActivePage() {
            const active = (function(){
                try { return (localStorage.getItem('platform_session_active') || '1') === '1'; } catch(e){ return true; }
            })();
            if (!active) return;
            const pageId = loadActivePage();
            if (!pageId) return;
            const link = document.querySelector(`[data-page="${pageId}"]`);
            const page = document.getElementById(pageId);
            if (link && page) {
                // 觸發既有 click handler，維持一致行為
                link.click();
            }
        })();

        // 標籤頁切換（若有對應 tab-panel 則同步切換內容）
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const parentTabs = this.parentElement;
                parentTabs.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const tabKey = this.getAttribute('data-tab');
                // 同一個 card 內通常會有相鄰的 .tab-panels
                const scope = parentTabs.closest('.card') || document;
                const panels = scope.querySelectorAll('.tab-panels .tab-panel');
                if (panels && panels.length > 0) {
                    // 只切換同一層級卡片內的 panel，避免跨頁干擾
                    const localPanels = scope.querySelectorAll('.tab-panels .tab-panel');
                    localPanels.forEach(p => p.classList.remove('active'));
                    const target = scope.querySelector(`.tab-panels .tab-panel[data-tab-panel="${tabKey}"]`);
                    if (target) target.classList.add('active');
                }
            });
        });

        // Modal 控制
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // 導航功能
        function navigateTo(page) {
            const link = document.querySelector(`[data-page="${page}"]`);
            if (link) link.click();
        }



        // ===== 案源：主視覺預覽 / 渲染 / 詳細 =====
        function setPreviewImage(dataUrl) {
            const box = document.getElementById('projMainImagePreview');
            if (!box) return;
            box.innerHTML = '';
            if (!dataUrl) {
                const span = document.createElement('span');
                span.textContent = '尚未上傳';
                box.appendChild(span);
                return;
            }
            const img = document.createElement('img');
            img.src = dataUrl;
            box.appendChild(img);
        }

        function statusBadgeHtml(status) {
            if (status === 'active') return '<span class="badge badge-success">可報備</span>';
            if (status === 'paused') return '<span class="badge badge-warning">暫停報備</span>';
            if (status === 'closed') return '<span class="badge badge-secondary">已結案</span>';
            return '<span class="badge badge-secondary">-</span>';
        }

        function visibleBadgeHtml(v) {
            if (v === 'online') return '<span class="badge badge-success">已上架</span>';
            if (v === 'offline') return '<span class="badge badge-secondary">未上架</span>';
            return '<span class="badge badge-secondary">-</span>';
        }

        function appendProjectRow(p) {
            const projectsPage = document.getElementById('projects');
            if (!projectsPage) return;
            const tbody = projectsPage.querySelector('table tbody');
            if (!tbody) return;

            const tr = document.createElement('tr');
            tr.setAttribute('data-proj-id', p.id);

            const nameTd = document.createElement('td');
            const nameBtn = document.createElement('button');
            nameBtn.className = 'btn btn-link';
            nameBtn.style.padding = '0';
            nameBtn.style.border = '0';
            nameBtn.style.background = 'transparent';
            nameBtn.style.color = 'var(--primary-color)';
            nameBtn.style.fontWeight = '800';
            nameBtn.style.cursor = 'pointer';
            nameBtn.textContent = p.name;
            nameBtn.onclick = function() { openProjectDetail(p.id); };
            nameTd.appendChild(nameBtn);

            const addrTd = document.createElement('td');
            addrTd.textContent = p.addr;

            const devTd = document.createElement('td');
            devTd.textContent = p.dev || '-';

            const statusTd = document.createElement('td');
            statusTd.innerHTML = statusBadgeHtml(p.status);

            const visibleTd = document.createElement('td');
            visibleTd.innerHTML = visibleBadgeHtml(p.visible);

            const monthTd = document.createElement('td');
            monthTd.textContent = '0';

            const actionTd = document.createElement('td');
            actionTd.innerHTML = `
                <button class="btn btn-outline btn-sm" onclick="openProjectDetail('${p.id}')">查看</button>
                <button class="btn btn-outline btn-sm" onclick="editProjectById('${p.id}')">編輯</button>
            `;

            tr.appendChild(nameTd);
            tr.appendChild(addrTd);
            tr.appendChild(devTd);
            tr.appendChild(statusTd);
            tr.appendChild(visibleTd);
            tr.appendChild(monthTd);
            tr.appendChild(actionTd);

            tbody.insertBefore(tr, tbody.firstChild);
        }

        function openProjectDetail(projectId) {
            let list = [];
            try { list = JSON.parse(localStorage.getItem('platform_projects') || '[]'); } catch (e) {}
            const p = list.find(x => x.id === projectId);
            if (!p) {
                // 找不到就用表格名稱 fallback
                openModal('projectDetailModal');
                document.getElementById('detailName').textContent = '（示意）案源';
                document.getElementById('detailAddr').textContent = '-';
                return;
            }

            // 主圖
            const box = document.getElementById('detailMainImage');
            if (box) {
                box.innerHTML = '';
                if (p.mainImage) {
                    const img = document.createElement('img');
                    img.src = p.mainImage;
                    box.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = '無圖片';
                    box.appendChild(span);
                }
            }

            document.getElementById('detailName').textContent = p.name;
            document.getElementById('detailAddr').textContent = p.addr;
            document.getElementById('detailArea').textContent = `${p.areaMin}-${p.areaMax}坪`;
            document.getElementById('detailLayout').textContent = `${p.layoutMin}-${p.layoutMax}房`;
            document.getElementById('detailPrice').textContent = `${p.priceMin}-${p.priceMax}萬`;

            const st = document.getElementById('detailStatusBadge');
            const vi = document.getElementById('detailVisibleBadge');
            const dv = document.getElementById('detailDevBadge');
            if (st) st.outerHTML = statusBadgeHtml(p.status).replace('<span', '<span id="detailStatusBadge"');
            if (vi) vi.outerHTML = visibleBadgeHtml(p.visible).replace('<span', '<span id="detailVisibleBadge"');
            if (dv) {
                dv.className = 'badge badge-secondary';
                dv.textContent = p.dev ? `代銷：${p.dev}` : '代銷：-';
            }
            document.getElementById('detailNote').textContent = p.note ? `備註：${p.note}` : '';

            openModal('projectDetailModal');
        }

        function initProjectUploader() {
            const input = document.getElementById('projMainImage');
            if (!input) return;
            input.addEventListener('change', function() {
                const file = input.files && input.files[0];
                if (!file) return setPreviewImage(null);
                const reader = new FileReader();
                reader.onload = function(evt) {
                    setPreviewImage(evt.target && evt.target.result ? String(evt.target.result) : null);
                };
                reader.readAsDataURL(file);
            });
        }

        function loadProjectsFromStorage() {
            let list = [];
            try { list = JSON.parse(localStorage.getItem('platform_projects') || '[]'); } catch (e) {}
            if (!Array.isArray(list)) return;
            // 只渲染前 50 筆示意
            list.slice(0, 50).forEach(p => {
                const existing = document.querySelector(`#projects table tbody tr[data-proj-id="${p.id}"]`);
                if (existing) return;
                appendProjectRow(p);
            });
        }

        function normalizeStatusFromText(t) {
            const s = String(t || '').trim();
            if (s.includes('暫停')) return 'paused';
            if (s.includes('結案')) return 'closed';
            if (s.includes('可報備')) return 'active';
            return 'active';
        }
        function normalizeVisibleFromText(t) {
            const s = String(t || '').trim();
            if (s.includes('未上架')) return 'offline';
            if (s.includes('已上架')) return 'online';
            return 'offline';
        }

        function splitDistrictRoad(addr) {
            const a = String(addr || '');
            const idx = a.indexOf('區');
            if (idx >= 0) {
                return { district: a.slice(0, idx + 1), road: a.slice(idx + 1) };
            }
            return { district: '', road: a };
        }

        function ensureSeedProjectsInStorage() {
            const projectsPage = document.getElementById('projects');
            if (!projectsPage) return;
            const rows = projectsPage.querySelectorAll('table tbody tr');
            let list = [];
            try { list = JSON.parse(localStorage.getItem('platform_projects') || '[]'); } catch (e) { list = []; }
            if (!Array.isArray(list)) list = [];

            let changed = false;
            let i = 0;
            rows.forEach(tr => {
                i += 1;
                let id = tr.getAttribute('data-proj-id');
                if (!id) {
                    id = 'SEED-' + i;
                    tr.setAttribute('data-proj-id', id);
                    changed = true;
                }

                // 如果 localStorage 已有同 id，就不覆蓋
                const exists = list.some(x => x && x.id === id);
                if (exists) return;

                const tds = tr.querySelectorAll('td');
                const name = (tds[0] && tds[0].textContent || '').trim();
                const addr = (tds[1] && tds[1].textContent || '').trim();
                const dev = (tds[2] && tds[2].textContent || '').trim();
                const statusText = (tds[3] && tds[3].textContent || '').trim();
                const visibleText = (tds[4] && tds[4].textContent || '').trim();

                const { district, road } = splitDistrictRoad(addr);

                const seed = {
                    id,
                    name: name || ('案源-' + i),
                    addr,
                    district,
                    road,
                    // 舊資料表格沒有這些細節，先留空，讓編輯時補齊
                    areaMin: '',
                    areaMax: '',
                    layoutMin: '',
                    layoutMax: '',
                    priceMin: '',
                    priceMax: '',
                    dev: dev || '',
                    status: normalizeStatusFromText(statusText),
                    visible: normalizeVisibleFromText(visibleText),
                    note: '',
                    mainImage: null
                };

                list.unshift(seed);
                changed = true;
            });

            if (changed) {
                try { localStorage.setItem('platform_projects', JSON.stringify(list)); } catch (e) {}
            }
        }

        function getProjectList() {
            let list = [];
            try { list = JSON.parse(localStorage.getItem('platform_projects') || '[]'); } catch (e) { list = []; }
            if (!Array.isArray(list)) list = [];
            return list;
        }

        function saveProjectList(list) {
            try { localStorage.setItem('platform_projects', JSON.stringify(list || [])); } catch (e) {}
        }

        function findProjectIdByNameFromTable(name) {
            const projectsPage = document.getElementById('projects');
            if (!projectsPage) return null;
            const rows = projectsPage.querySelectorAll('table tbody tr');
            for (const tr of rows) {
                const tds = tr.querySelectorAll('td');
                const n = (tds[0] && tds[0].textContent || '').trim();
                if (n === String(name || '').trim()) {
                    return tr.getAttribute('data-proj-id');
                }
            }
            return null;
        }

        function editProjectById(projectId) {
            const list = getProjectList();
            const p = list.find(x => x.id === projectId);
            if (!p) return alert('找不到此案源資料（示意）');

            document.getElementById('editProjId').value = p.id;
            document.getElementById('editProjName').value = p.name || '';
            document.getElementById('editProjDistrict').value = p.district || '';
            document.getElementById('editProjRoad').value = p.road || '';
            document.getElementById('editProjAreaMin').value = p.areaMin;
            document.getElementById('editProjAreaMax').value = p.areaMax;
            document.getElementById('editProjLayoutMin').value = p.layoutMin;
            document.getElementById('editProjLayoutMax').value = p.layoutMax;
            document.getElementById('editProjPriceMin').value = p.priceMin;
            document.getElementById('editProjPriceMax').value = p.priceMax;
            document.getElementById('editProjDev').value = p.dev || '';
            document.getElementById('editProjStatus').value = p.status || 'active';
            document.getElementById('editProjVisible').value = p.visible || 'online';
            document.getElementById('editProjNote').value = p.note || '';

            // 預覽圖
            setEditPreviewImage(p.mainImage || null);
            // 清空 file input（避免重複選檔）
            const fi = document.getElementById('editProjMainImage');
            if (fi) fi.value = '';

            openModal('editProjectModal');
        }

        function editProject(name) {
            // 兼容既有按鈕（用案名找 id 再開編輯）
            const idFromTable = findProjectIdByNameFromTable(name);
            const list = getProjectList();
            const pByName = list.find(x => (x.name || '') === String(name || ''));
            const id = (pByName && pByName.id) || idFromTable;
            if (!id) return alert(`找不到案源：${name}`);
            editProjectById(id);
        }

        function setEditPreviewImage(dataUrl) {
            const box = document.getElementById('editProjMainImagePreview');
            if (!box) return;
            box.innerHTML = '';
            if (!dataUrl) {
                const span = document.createElement('span');
                span.textContent = '尚未上傳';
                box.appendChild(span);
                return;
            }
            const img = document.createElement('img');
            img.src = dataUrl;
            box.appendChild(img);
        }

        function initEditProjectUploader() {
            const input = document.getElementById('editProjMainImage');
            if (!input) return;
            input.addEventListener('change', function() {
                const file = input.files && input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    setEditPreviewImage(evt.target && evt.target.result ? String(evt.target.result) : null);
                };
                reader.readAsDataURL(file);
            });
        }

        function updateProjectRowInTable(p) {
            const tr = document.querySelector(`#projects table tbody tr[data-proj-id="${p.id}"]`);
            if (!tr) return;
            const tds = tr.querySelectorAll('td');
            if (tds[0]) tds[0].textContent = p.name;
            if (tds[1]) tds[1].textContent = p.addr;
            if (tds[2]) tds[2].textContent = p.dev || '-';
            if (tds[3]) tds[3].innerHTML = statusBadgeHtml(p.status);
            if (tds[4]) tds[4].innerHTML = visibleBadgeHtml(p.visible);
            if (tds[6]) {
                // 重新綁定按鈕（保持查看/編輯一致）
                let extra = '';
                if (p.status === 'active') {
                    extra = `<button class="btn btn-warning btn-sm" onclick="pauseProject('${(p.name||'').replace(/'/g, "\\'")}')">暫停報備</button>`;
                } else if (p.status === 'paused') {
                    extra = `<button class="btn btn-success btn-sm" onclick="resumeProject('${(p.name||'').replace(/'/g, "\\'")}')">恢復報備</button>`;
                }
                tds[6].innerHTML = `
                    <button class="btn btn-outline btn-sm" onclick="openProjectDetail('${p.id}')">查看</button>
                    <button class="btn btn-outline btn-sm" onclick="editProjectById('${p.id}')">編輯</button>
                    ${extra}
                `;
            }
        }

        function submitEditProject() {
            const id = (document.getElementById('editProjId')||{}).value || '';
            if (!id) return alert('缺少案源ID（示意）');

            const name = (document.getElementById('editProjName')||{}).value || '';
            const district = (document.getElementById('editProjDistrict')||{}).value || '';
            const road = (document.getElementById('editProjRoad')||{}).value || '';
            const areaMin = (document.getElementById('editProjAreaMin')||{}).value;
            const areaMax = (document.getElementById('editProjAreaMax')||{}).value;
            const layoutMin = (document.getElementById('editProjLayoutMin')||{}).value;
            const layoutMax = (document.getElementById('editProjLayoutMax')||{}).value;
            const priceMin = (document.getElementById('editProjPriceMin')||{}).value;
            const priceMax = (document.getElementById('editProjPriceMax')||{}).value;

            if (!name.trim()) return alert('請填寫案名');
            if (!district.trim() || !road.trim()) return alert('請填寫行政區與路段');

            const dev = (document.getElementById('editProjDev')||{}).value || '';
            const status = (document.getElementById('editProjStatus')||{}).value || 'active';
            const visible = (document.getElementById('editProjVisible')||{}).value || 'online';
            const note = (document.getElementById('editProjNote')||{}).value || '';
            const addr = `${district}${road}`;

            const list = getProjectList();
            const idx = list.findIndex(x => x.id === id);
            if (idx < 0) return alert('找不到要更新的案源（示意）');

            // 保留原圖，除非重新上傳
            const original = list[idx];
            const next = {
                ...original,
                id,
                name: name.trim(),
                district: district.trim(),
                road: road.trim(),
                addr,
                areaMin, areaMax,
                layoutMin, layoutMax,
                priceMin, priceMax,
                dev: dev.trim(),
                status,
                visible,
                note: note.trim()
            };

            const fileInput = document.getElementById('editProjMainImage');
            const file = fileInput && fileInput.files && fileInput.files[0];

            const save = () => {
                list[idx] = next;
                saveProjectList(list);
                updateProjectRowInTable(next);
                closeModal('editProjectModal');
                alert('案源已更新（示意）！');
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    next.mainImage = evt.target && evt.target.result ? String(evt.target.result) : null;
                    save();
                };
                reader.readAsDataURL(file);
            } else {
                save();
            }
        }
        // 新增案源提交（前端示意：可新增到表格，並保存到 localStorage）
        function submitAddProject() {
            const name = (document.getElementById('projName')||{}).value || '';
            const district = (document.getElementById('projDistrict')||{}).value || '';
            const road = (document.getElementById('projRoad')||{}).value || '';
            const areaMin = parseFloat((document.getElementById('projAreaMin')||{}).value || '');
            const areaMax = parseFloat((document.getElementById('projAreaMax')||{}).value || '');
            const layoutMin = parseInt((document.getElementById('projLayoutMin')||{}).value || '', 10);
            const layoutMax = parseInt((document.getElementById('projLayoutMax')||{}).value || '', 10);
            const priceMin = parseInt((document.getElementById('projPriceMin')||{}).value || '', 10);
            const priceMax = parseInt((document.getElementById('projPriceMax')||{}).value || '', 10);

            if (!name.trim()) return alert('請填寫案名');
            if (!district.trim() || !road.trim()) return alert('請填寫行政區與路段');
            if (!(areaMin >= 0) || !(areaMax > 0) || areaMax < areaMin) return alert('請確認坪數區間（最大需大於等於最小）');
            if (!(layoutMin >= 0) || !(layoutMax >= 0) || layoutMax < layoutMin) return alert('請確認格局區間（最大需大於等於最小）');
            if (!(priceMin >= 0) || !(priceMax > 0) || priceMax < priceMin) return alert('請確認總價區間（最大需大於等於最小）');

            const dev = (document.getElementById('projDev')||{}).value || '';
            const status = (document.getElementById('projStatus')||{}).value || 'active';
            const visible = (document.getElementById('projVisible')||{}).value || 'online';
            const note = (document.getElementById('projNote')||{}).value || '';
            const addr = `${district}${road}`;

            const fileInput = document.getElementById('projMainImage');
            const file = fileInput && fileInput.files && fileInput.files[0];

            const project = {
                id: 'PJ' + Date.now(),
                name: name.trim(),
                addr,
                district: district.trim(),
                road: road.trim(),
                areaMin, areaMax,
                layoutMin, layoutMax,
                priceMin, priceMax,
                dev: dev.trim(),
                status,
                visible,
                note: note.trim(),
                mainImage: null
            };

            const saveAndRender = () => {
                try {
                    const list = JSON.parse(localStorage.getItem('platform_projects') || '[]');
                    list.unshift(project);
                    localStorage.setItem('platform_projects', JSON.stringify(list));
                } catch (e) {}

                appendProjectRow(project);
                closeModal('addProjectModal');

                // reset form
                try {
                    document.getElementById('addProjectForm').reset();
                    setPreviewImage(null);
                } catch (e) {}

                alert('案源新增成功（示意）！');
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    project.mainImage = evt.target && evt.target.result ? String(evt.target.result) : null;
                    saveAndRender();
                };
                reader.readAsDataURL(file);
            } else {
                saveAndRender();
            }

        }


        // Session / 導航狀態（刷新保留當前頁）
        function saveActivePage(pageId) {
            try {
                localStorage.setItem('platform_active_page', pageId);
            } catch (e) {}
        }

        function loadActivePage() {
            try {
                return localStorage.getItem('platform_active_page');
            } catch (e) {
                return null;
            }
        }

        function setSessionActive(active) {
            try {
                localStorage.setItem('platform_session_active', active ? '1' : '0');
            } catch (e) {}
        }

        function isSessionActive() {
            try {
                return (localStorage.getItem('platform_session_active') || '1') === '1';
            } catch (e) {
                return true;
            }
        }

        function logout() {
            setSessionActive(false);
            try {
                localStorage.removeItem('platform_active_page');
            } catch (e) {}
            alert('已登出');
            location.reload();
        }

        // 帳號管理功能
        function openAddAccountModal() {
            openModal('addAccountModal');
        }

        function submitAddAccount() {
            alert('帳號新增成功！系統已發送通知給用戶。');
            closeModal('addAccountModal');
        }

        function editAccount(name) {
            alert(`編輯帳號：${name}`);
        }

        function disableAccount(name) {
            document.getElementById('disable-account-name').textContent = name;
            openModal('disableAccountModal');
        }

        function submitDisableAccount() {
            alert('帳號已停用！');
            closeModal('disableAccountModal');
        }

        function resetPassword(name) {
            if (confirm(`確定要重置 ${name} 的密碼嗎？\n新密碼：chainhouse123`)) {
                alert('密碼已重置！系統已發送通知給用戶。');
            }
        }

        // 案源管理功能
        function openAddProjectModal() {
            openModal('addProjectModal');
        }

        function editProject(name) {
            alert(`編輯案源：${name}`);
        }

        function pauseProject(name) {
            if (confirm(`確定要暫停 ${name} 的報備功能嗎？\n暫停後仲介端將無法報備此案源。`)) {
                alert('案源報備已暫停！');
            }
        }

        function resumeProject(name) {
            if (confirm(`確定要恢復 ${name} 的報備功能嗎？`)) {
                alert('案源報備已恢復！');
            }
        }

        // 報備管理功能
        function viewBookingDetail(id) {
            alert(`查看報備詳情：${id}`);
        }

        function exportAllBookings() {
            alert('報備資料匯出成功！已下載至本機。');
        }

        // 制度參數功能
        function editSettings(type) {
            const types = {
                'booking': '報備規則',
                'threshold': 'KPI 門檻',
                'sla': 'SLA 回應時間'
            };
            alert(`修改 ${types[type]} 設定`);
        }

        // KPI 功能
        function exportKPI() {
            alert('KPI 報表匯出成功！已下載至本機。');
        }

        // 數據分析功能
        function exportAnalytics() {
            alert('數據分析報表匯出成功！已下載至本機。');
        }

        function updateAnalyticsPeriod(period) {
            const periods = {
                'week': '本週',
                'month': '本月',
                'quarter': '本季',
                'halfyear': '半年',
                'year': '本年'
            };
            console.log(`切換至${periods[period]}數據`);
        }

        /* =============================
         * 新增：平台總後台核心模組（10.3.1～10.3.7）前端原型邏輯
         * 說明：僅使用前端記憶體/LocalStorage，方便你在不動既有架構下快速補齊 UI...
         * ============================= */

        const LS_KEYS = {
            DEMO_MODE: 'chainhouse_admin_demo_mode',
            EXT_FIELDS: 'chainhouse_admin_extension_fields',
            RULE_VERSIONS: 'chainhouse_admin_rule_versions'
        };

        const AppState = {
            demoMode: localStorage.getItem(LS_KEYS.DEMO_MODE) === '1',
            riskActionLogs: [],
            statementLogs: [],
            collectionLogs: []
        };

        const SeedData = (() => {
            const today = new Date();
            const fmt = (d) => d.toISOString().slice(0, 10);
            const addDays = (d, n) => new Date(d.getTime() + n * 86400000);

            return {
                orgAudits: [
                    { id: 'AUD-001', type: 'store', name: '信義門店', owner: '王店長', phone: '0912-345-678', createdAt: '2026-01-10', status: 'pending', note: '新設立門店' },
                    { id: 'AUD-002', type: 'developer', name: 'XX代銷公司', owner: '張主管', phone: '0923-456-789', createdAt: '2026-01-08', status: 'approved', note: '合約已簽' },
                    { id: 'AUD-003', type: 'project', name: '信義之星案', owner: '林案場', phone: '0900-000-003', createdAt: '2026-01-06', status: 'rejected', note: '資料缺漏：建照' }
                ],
                orgAuditLogs: [
                    { time: '2026-01-08 10:12', id: 'AUD-002', action: '通過', by: '陳管理員', remark: '文件完整' },
                    { time: '2026-01-07 16:40', id: 'AUD-003', action: '拒絕', by: '陳管理員', remark: '缺建照/權狀' }
                ],
                suspensions: [
                    { id: 'SUS-001', target: '王小明（信義門店）', reason: '高取消率', start: '2026-01-14 09:00', end: '', restore: '連續30天取消率 < 10%', status: 'active', autoMarked: true },
                ],
                blacklistRules: [
                    { id: 'BLR-001', name: '取消率 > 30% 且連續 14 天', scope: 'store', condition: '取消率>30%（14天）', enabled: true },
                    { id: 'BLR-002', name: '案場 SLA 達標率 < 80%（30天）', scope: 'project', condition: 'SLA<80%（30天）', enabled: true }
                ],
                rbacRoles: ['Super Admin', 'Platform Ops', 'Platform CS', '仲介店長', '仲介業務', '代銷主管'],
                rbacModules: [
                    { key: 'accounts', name: '組織與帳號中心' },
                    { key: 'contracts', name: '合約與歸因中心' },
                    { key: 'tickets', name: '工單/爭議中心' },
                    { key: 'finance', name: '財務結算中心' },
                    { key: 'risk', name: '風控中心' },
                    { key: 'reports', name: '報表中心' },
                ],
                // 簡化版矩陣：role -> module -> perms
                rbacMatrix: {
                    'Super Admin': { accounts: 'R/W/A', contracts: 'R/W/A', tickets: 'R/W/A', finance: 'R/W/A', risk: 'R/W/A', reports: 'R/W', system_admin: 'R/W/A' },
                    'Platform Ops': { accounts: 'R', contracts: 'R/W', tickets: 'R/W', finance: 'R', risk: 'R/W', reports: 'R/W', system_admin: 'R' },
                    'Platform CS': { accounts: 'R', contracts: 'R', tickets: 'R/W', finance: 'R', risk: 'R', reports: 'R', system_admin: 'R' },
                    '仲介店長': { accounts: 'R', contracts: 'R', tickets: 'R', finance: 'R', risk: 'R', reports: 'R', system_admin: '—' },
                    '仲介業務': { accounts: 'R', contracts: '—', tickets: '—', finance: '—', risk: '—', reports: '—', system_admin: '—' },
                    '代銷主管': { accounts: 'R', contracts: 'R', tickets: 'R', finance: 'R', risk: 'R', reports: 'R', system_admin: '—' }
                },
                contracts: [
                    { id: 'C-2026-001', type: 'store', target: '信義門店', sales: '王業務', effective: '2026-01-01', terminate: '', status: 'active' },
                    { id: 'C-2025-088', type: 'project', target: '信義之星案', sales: '劉業務', effective: '2025-12-01', terminate: '2026-01-05', status: 'terminated' }
                ],
                attributions: [
                    { id: 'ATTR-001', mode: 'single', store: '信義門店', project: '', weightStore: 100, weightProject: 0, sales: '王業務', effective: '2026-01-01', status: 'active' },
                    { id: 'ATTR-002', mode: 'weighted', store: '信義門店', project: '信義之星案', weightStore: 60, weightProject: 40, sales: '劉業務', effective: '2026-01-10', status: 'active' }
                ],
                revshareVersions: [
                    { version: 'v1.0', effective: '2026-01-01', store: 60, developer: 20, platform: 20 },
                ],
                bonusVersions: [
                    { version: 'v1.0', effective: '2026-01-01', threshold: 5, bonus: 20000 },
                    { version: 'v1.0', effective: '2026-01-01', threshold: 10, bonus: 50000 }
                ],
                ruleVersions: JSON.parse(localStorage.getItem(LS_KEYS.RULE_VERSIONS) || 'null') || [
                    { type: 'sla', version: 'v1.0', effective: '2026-01-01', content: 'SLA：核可 24h、回覆 48h' }
                ],
                tickets: [
                    { id: 'T-1001', type: '報備爭議', title: '撞客：同一買方重複報備', createdAt: '2026-01-12', sla: '48h', status: 'open', assignee: '平台CS-小芸' },
                    { id: 'T-1002', type: '結佣爭議', title: '結佣金額不一致', createdAt: '2026-01-13', sla: '72h', status: 'in_progress', assignee: '平台Ops-阿杰' }
                ],
                ticketEvents: {
                    'T-1001': [
                        { time: '2026-01-12 11:10', action: '建立工單', by: '系統', note: '自動掛載：報備事件 RB-99123' },
                        { time: '2026-01-12 11:20', action: '指派', by: '陳管理員', note: '指派給 平台CS-小芸' }
                    ]
                },
                slaRules: [
                    { version: 'v1.0', effective: '2026-01-01', bookingReplyHours: 48, approveHours: 24, disputeHours: 72 }
                ],
                ar: [
                    { id: 'AR-9001', target: '信義門店', period: '2026-01', amount: 120000, due: fmt(addDays(today, -5)), status: 'overdue', paid: false },
                    { id: 'AR-9002', target: 'XX代銷公司', period: '2026-01', amount: 500000, due: fmt(addDays(today, 10)), status: 'unpaid', paid: false }
                ],
                ap: [
                    { id: 'AP-7001', target: '信義門店', period: '2026-01', amount: 80000, payDate: '', status: 'unpaid' }
                ],
                riskProjects: [
                    { target: '信義之星案', developer: 'XX代銷公司', sla30: 72, reject30: 45, signal: '高風險', suggestion: '需審核', action: 'need_review' }
                ],
                riskStores: [
                    { target: '信義門店 / 王小明', type: '門店/業務', burst: '是', cancel: 40, noshow: 18, signal: '異常', action: 'limit' }
                ],
                extensionFields: JSON.parse(localStorage.getItem(LS_KEYS.EXT_FIELDS) || 'null') || [
                    { key: 'custom_note', name: '自訂備註', type: 'string', required: false, scope: 'booking', rule: '' }
                ]
            };
        })();

        // 取用資料（可視需要改為從 API 取）
        const Data = {
            orgAudits: [...SeedData.orgAudits],
            orgAuditLogs: [...SeedData.orgAuditLogs],
            suspensions: [...SeedData.suspensions],
            blacklistRules: [...SeedData.blacklistRules],
            rbacRoles: [...SeedData.rbacRoles],
            rbacModules: [...SeedData.rbacModules],
            rbacMatrix: JSON.parse(JSON.stringify(SeedData.rbacMatrix)),
            contracts: [...SeedData.contracts],
            attributions: [...SeedData.attributions],
            revshareVersions: [...SeedData.revshareVersions],
            bonusVersions: [...SeedData.bonusVersions],
            ruleVersions: [...SeedData.ruleVersions],
            tickets: [...SeedData.tickets],
            ticketEvents: JSON.parse(JSON.stringify(SeedData.ticketEvents)),
            slaRules: [...SeedData.slaRules],
            ar: [...SeedData.ar],
            ap: [...SeedData.ap],
            riskProjects: [...SeedData.riskProjects],
            riskStores: [...SeedData.riskStores],
            extensionFields: [...SeedData.extensionFields]
        };

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function badgeByStatus(status) {
            const map = {
                pending: 'badge-warning', approved: 'badge-success', rejected: 'badge-danger',
                open: 'badge-warning', in_progress: 'badge-info', closed: 'badge-success',
                active: 'badge-success', terminated: 'badge-danger', draft: 'badge-secondary',
                unpaid: 'badge-warning', paid: 'badge-success', overdue: 'badge-danger'
            };
            return map[status] || 'badge-secondary';
        }

        /* ===== 10.3.1：機構建檔審核 ===== */
        function renderOrgAuditTable() {
            const type = (document.getElementById('orgAuditTypeFilter') || {}).value || '';
            const status = (document.getElementById('orgAuditStatusFilter') || {}).value || '';
            const kw = ((document.getElementById('orgAuditKeyword') || {}).value || '').trim();

            const tbody = document.getElementById('orgAuditTbody');
            if (!tbody) return;

            const rows = Data.orgAudits
                .filter(r => !type || r.type === type)
                .filter(r => !status || r.status === status)
                .filter(r => !kw || (r.id + r.name + r.owner + r.phone).includes(kw));

            tbody.innerHTML = rows.map(r => {
                const typeLabel = r.type === 'store' ? '門店' : (r.type === 'developer' ? '代銷' : '建案');
                return `
                    <tr>
                        <td>${escapeHtml(r.id)}</td>
                        <td>${escapeHtml(typeLabel)}</td>
                        <td><strong>${escapeHtml(r.name)}</strong></td>
                        <td>${escapeHtml(r.owner)}</td>
                        <td>${escapeHtml(r.phone)}</td>
                        <td>${escapeHtml(r.createdAt)}</td>
                        <td><span class="badge ${badgeByStatus(r.status)}">${escapeHtml(r.status)}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="viewOrgAudit('${r.id}')">查看</button>
                            ${r.status === 'pending' ? `
                                <button class="btn btn-primary btn-sm" onclick="approveOrgAudit('${r.id}')">通過</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectOrgAudit('${r.id}')">拒絕</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="8" style="color:var(--text-secondary); text-align:center; padding:24px;">無符合資料</td></tr>`;
        }

        function renderOrgAuditLogs() {
            const tbody = document.getElementById('orgAuditLogTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.orgAuditLogs.map(l => `
                <tr>
                    <td>${escapeHtml(l.time)}</td>
                    <td>${escapeHtml(l.id)}</td>
                    <td>${escapeHtml(l.action)}</td>
                    <td>${escapeHtml(l.by)}</td>
                    <td>${escapeHtml(l.remark)}</td>
                </tr>
            `).join('') || `<tr><td colspan="5" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無紀錄</td></tr>`;
        }

        function viewOrgAudit(id) {
            const rec = Data.orgAudits.find(x => x.id === id);
            if (!rec) return;
            alert(`審核單 ${rec.id}\n\n類型：${rec.type}\n機構：${rec.name}\n負責人：${rec.owner}\n手機：${rec.phone}\n狀態：${rec.status}\n備註：${rec.note}`);
        }

        function approveOrgAudit(id) {
            const rec = Data.orgAudits.find(x => x.id === id);
            if (!rec) return;
            rec.status = 'approved';
            Data.orgAuditLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), id, action: '通過', by: '陳管理員', remark: '前端示意' });
            renderOrgAuditTable();
            renderOrgAuditLogs();
            alert('已通過審核（示意）。');
        }

        function rejectOrgAudit(id) {
            const reason = prompt('請輸入拒絕原因（示意）');
            if (reason === null) return;
            const rec = Data.orgAudits.find(x => x.id === id);
            if (!rec) return;
            rec.status = 'rejected';
            Data.orgAuditLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), id, action: '拒絕', by: '陳管理員', remark: reason || '（未填）' });
            renderOrgAuditTable();
            renderOrgAuditLogs();
            alert('已拒絕審核（示意）。');
        }

        /* ===== 10.3.1：停權/恢復/黑名單 ===== */
        function openSuspendModal(target) {
            document.getElementById('suspendTarget').value = target || '';
            document.getElementById('suspendReason').value = '';
            document.getElementById('suspendStart').value = '';
            document.getElementById('suspendEnd').value = '';
            document.getElementById('suspendRestoreRule').value = '';
            openModal('suspendModal');
        }

        function submitSuspend() {
            const target = document.getElementById('suspendTarget').value.trim();
            const reason = document.getElementById('suspendReason').value;
            const start = document.getElementById('suspendStart').value;
            const end = document.getElementById('suspendEnd').value;
            const restore = document.getElementById('suspendRestoreRule').value;
            if (!target || !reason) {
                alert('請填寫停權原因。');
                return;
            }
            const id = `SUS-${String(Data.suspensions.length + 1).padStart(3, '0')}`;
            Data.suspensions.unshift({ id, target, reason, start: start ? start.replace('T', ' ') : '', end: end ? end.replace('T', ' ') : '', restore, status: 'active', autoMarked: false });
            renderSuspensionTable();
            closeModal('suspendModal');
            alert('停權已建立（示意）。');
        }

        function restoreSuspension(id) {
            const rec = Data.suspensions.find(x => x.id === id);
            if (!rec) return;
            if (!confirm(`確定要恢復：${rec.target}？`)) return;
            rec.status = 'restored';
            renderSuspensionTable();
            alert('已恢復（示意）。');
        }

        function renderSuspensionTable() {
            const tbody = document.getElementById('suspensionTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.suspensions.map(s => `
                <tr>
                    <td>${escapeHtml(s.id)}</td>
                    <td>${escapeHtml(s.target)}</td>
                    <td>${escapeHtml(s.reason)}</td>
                    <td>${escapeHtml(s.start || '-')}</td>
                    <td>${escapeHtml(s.end || '-')}</td>
                    <td>${escapeHtml(s.restore || '-')}</td>
                    <td>${s.autoMarked ? '<span class="badge badge-warning">自動標記</span>' : '<span class="badge badge-secondary">手動</span>'}</td>
                    <td><span class="badge ${badgeByStatus(s.status === 'active' ? 'active' : 'closed')}">${escapeHtml(s.status)}</span></td>
                    <td>
                        ${s.status === 'active' ? `<button class="btn btn-outline btn-sm" onclick="restoreSuspension('${s.id}')">恢復</button>` : '<span style="color:var(--text-secondary)">—</span>'}
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="9" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無停權資料</td></tr>`;
        }

        function submitBlacklistRule() {
            const name = document.getElementById('blRuleName').value.trim();
            const scope = document.getElementById('blRuleScope').value;
            const condition = document.getElementById('blRuleCondition').value.trim();
            if (!name) {
                alert('請填寫規則名稱');
                return;
            }
            const id = `BLR-${String(Data.blacklistRules.length + 1).padStart(3, '0')}`;
            Data.blacklistRules.unshift({ id, name, scope, condition, enabled: true });
            renderBlacklistRuleTable();
            closeModal('blacklistRuleModal');
            document.getElementById('blacklistRuleForm').reset();
            alert('已儲存黑名單規則（示意）。');
        }

        function toggleBlacklistRule(id) {
            const rec = Data.blacklistRules.find(x => x.id === id);
            if (!rec) return;
            rec.enabled = !rec.enabled;
            renderBlacklistRuleTable();
        }

        function renderBlacklistRuleTable() {
            const tbody = document.getElementById('blacklistRuleTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.blacklistRules.map(r => `
                <tr>
                    <td>${escapeHtml(r.id)}</td>
                    <td><strong>${escapeHtml(r.name)}</strong><div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">${escapeHtml(r.condition || '')}</div></td>
                    <td>${r.scope === 'store' ? '門店/業務' : '案場/代銷'}</td>
                    <td>${r.enabled ? '<span class="badge badge-success">啟用</span>' : '<span class="badge badge-secondary">停用</span>'}</td>
                    <td><button class="btn btn-outline btn-sm" onclick="toggleBlacklistRule('${r.id}')">切換</button></td>
                </tr>
            `).join('') || `<tr><td colspan="5" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無規則</td></tr>`;
        }

        /* ===== 10.3.1：RBAC 矩陣 ===== */
        function renderRbacRoleSelect() {
            const sel = document.getElementById('rbacRoleSelect');
            if (!sel) return;
            sel.innerHTML = Data.rbacRoles.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
        }

        function renderRbacMatrix() {
            const role = (document.getElementById('rbacRoleSelect') || {}).value || Data.rbacRoles[0];
            const tbody = document.getElementById('rbacMatrixTbody');
            if (!tbody) return;

            tbody.innerHTML = Data.rbacModules.map(m => {
                const perms = (Data.rbacMatrix[role] || {})[m.key] || '—';
                const parts = String(perms).split('/');
                const has = (p) => parts.includes(p);
                const cell = (flag, label) => `<input type="checkbox" ${flag ? 'checked' : ''} disabled title="${label}">`;
                return `
                    <tr>
                        <td><strong>${escapeHtml(m.name)}</strong><div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">${escapeHtml(m.key)}</div></td>
                        <td>${cell(has('R'), 'Read')}</td>
                        <td>${cell(has('W'), 'Write')}</td>
                        <td>${cell(has('A'), 'Audit')}</td>
                        <td style="color:var(--text-secondary);">（示意：實作時由後端 RBAC 服務落權限）</td>
                    </tr>
                `;
            }).join('');
        }

        /* ===== 10.3.2：合約與歸因 ===== */
        function renderContractTable() {
            const type = (document.getElementById('contractTypeFilter') || {}).value || '';
            const status = (document.getElementById('contractStatusFilter') || {}).value || '';
            const kw = ((document.getElementById('contractKeyword') || {}).value || '').trim();
            const tbody = document.getElementById('contractTbody');
            if (!tbody) return;
            const rows = Data.contracts
                .filter(c => !type || c.type === type)
                .filter(c => !status || c.status === status)
                .filter(c => !kw || (c.id + c.target + c.sales).includes(kw));
            tbody.innerHTML = rows.map(c => {
                const typeLabel = c.type === 'store' ? '門店' : '建案';
                const statusLabel = c.status === 'active' ? '有效' : (c.status === 'terminated' ? '已終止' : '草稿');
                return `
                    <tr>
                        <td><strong>${escapeHtml(c.id)}</strong></td>
                        <td>${escapeHtml(typeLabel)}</td>
                        <td>${escapeHtml(c.target)}</td>
                        <td>${escapeHtml(c.sales || '-')}</td>
                        <td>${escapeHtml(c.effective)}</td>
                        <td>${escapeHtml(c.terminate || '-')}</td>
                        <td><span class="badge ${badgeByStatus(c.status)}">${escapeHtml(statusLabel)}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="openEditContract('${c.id}')">修改</button>
                            ${c.status === 'active' ? `<button class="btn btn-danger btn-sm" onclick="terminateContract('${c.id}')">終止</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="8" style="color:var(--text-secondary); text-align:center; padding:24px;">無合約資料</td></tr>`;
        }

        function openEditContract(id) {
            const c = Data.contracts.find(x => x.id === id);
            if (!c) return;
            document.getElementById('contractModalTitle').textContent = '修改合約';
            document.getElementById('contractId').value = c.id;
            document.getElementById('contractType').value = c.type;
            document.getElementById('contractTarget').value = c.target;
            document.getElementById('contractSales').value = c.sales || '';
            document.getElementById('contractEffective').value = c.effective;
            document.getElementById('contractTerminate').value = c.terminate || '';
            document.getElementById('contractStatus').value = c.status;
            openModal('contractModal');
        }

        function submitContract() {
            const id = document.getElementById('contractId').value.trim();
            const type = document.getElementById('contractType').value;
            const target = document.getElementById('contractTarget').value.trim();
            const sales = document.getElementById('contractSales').value.trim();
            const effective = document.getElementById('contractEffective').value;
            const terminate = document.getElementById('contractTerminate').value;
            const status = document.getElementById('contractStatus').value;

            if (!target || !effective) {
                alert('請填寫對象名稱與生效日');
                return;
            }

            if (id) {
                const c = Data.contracts.find(x => x.id === id);
                if (c) {
                    c.type = type; c.target = target; c.sales = sales; c.effective = effective; c.terminate = terminate; c.status = status;
                }
            } else {
                const newId = `C-2026-${String(Data.contracts.length + 1).padStart(3, '0')}`;
                Data.contracts.unshift({ id: newId, type, target, sales, effective, terminate, status: status || 'draft' });
            }

            renderContractTable();
            closeModal('contractModal');
            document.getElementById('contractForm').reset();
            document.getElementById('contractModalTitle').textContent = '新增合約';
            alert('合約已儲存（示意）。');
        }

        function terminateContract(id) {
            const c = Data.contracts.find(x => x.id === id);
            if (!c) return;
            if (!confirm(`確定要終止合約：${c.id} / ${c.target}？`)) return;
            c.status = 'terminated';
            c.terminate = new Date().toISOString().slice(0, 10);
            renderContractTable();
            alert('已終止（示意）。');
        }

        function renderAttributionTable() {
            const tbody = document.getElementById('attributionTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.attributions.map(a => {
                const modeLabel = a.mode === 'single' ? '單邊' : (a.mode === 'double' ? '雙邊' : '權重');
                const weight = `${a.weightStore || 0}% / ${a.weightProject || 0}%`;
                return `
                    <tr>
                        <td><strong>${escapeHtml(a.id)}</strong></td>
                        <td>${escapeHtml(modeLabel)}</td>
                        <td>${escapeHtml(a.store || '-')}</td>
                        <td>${escapeHtml(a.project || '-')}</td>
                        <td>${escapeHtml(weight)}</td>
                        <td>${escapeHtml(a.sales || '-')}</td>
                        <td>${escapeHtml(a.effective)}</td>
                        <td><span class="badge ${badgeByStatus(a.status)}">${escapeHtml(a.status)}</span></td>
                        <td><button class="btn btn-outline btn-sm" onclick="disableAttribution('${a.id}')">停用</button></td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="9" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無歸因規則</td></tr>`;
        }

        function submitAttribution() {
            const mode = document.getElementById('attrMode').value;
            const store = document.getElementById('attrStore').value.trim();
            const project = document.getElementById('attrProject').value.trim();
            const wStore = parseInt(document.getElementById('attrWStore').value || '0', 10);
            const wProject = parseInt(document.getElementById('attrWProject').value || '0', 10);
            const sales = document.getElementById('attrSales').value.trim();
            const effective = document.getElementById('attrEffective').value;

            if (!effective) { alert('請填寫生效日'); return; }
            if (mode === 'single' && !store && !project) { alert('單邊歸因需指定門店或建案'); return; }
            if (mode !== 'single' && (!store || !project)) { alert('雙邊/權重歸因需同時指定門店與建案'); return; }
            if (mode === 'weighted' && (wStore + wProject !== 100)) { alert('權重加總需為 100'); return; }

            const id = `ATTR-${String(Data.attributions.length + 1).padStart(3, '0')}`;
            Data.attributions.unshift({ id, mode, store, project, weightStore: mode === 'weighted' ? wStore : (store ? 100 : 0), weightProject: mode === 'weighted' ? wProject : (project ? 100 : 0), sales, effective, status: 'active' });
            renderAttributionTable();
            closeModal('attributionModal');
            document.getElementById('attributionForm').reset();
            alert('歸因規則已新增（示意）。');
        }

        function disableAttribution(id) {
            const a = Data.attributions.find(x => x.id === id);
            if (!a) return;
            if (!confirm(`停用歸因規則 ${a.id}？（示意）`)) return;
            a.status = 'terminated';
            renderAttributionTable();
        }

        function renderRevshareTable() {
            const tbody = document.getElementById('revshareTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.revshareVersions.map(v => `
                <tr>
                    <td><strong>${escapeHtml(v.version)}</strong></td>
                    <td>${escapeHtml(v.effective)}</td>
                    <td>${escapeHtml(v.store)}%</td>
                    <td>${escapeHtml(v.developer)}%</td>
                    <td>${escapeHtml(v.platform)}%</td>
                </tr>
            `).join('') || `<tr><td colspan="5" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無版本</td></tr>`;
        }

        function submitRevshare() {
            const version = document.getElementById('revVersion').value.trim();
            const effective = document.getElementById('revEffective').value;
            const store = parseInt(document.getElementById('revStore').value || '0', 10);
            const developer = parseInt(document.getElementById('revDeveloper').value || '0', 10);
            const platform = parseInt(document.getElementById('revPlatform').value || '0', 10);
            if (!version || !effective) { alert('請填寫版本與生效日'); return; }
            if (store + developer + platform !== 100) { alert('比例加總需為 100'); return; }
            Data.revshareVersions.unshift({ version, effective, store, developer, platform });
            renderRevshareTable();
            closeModal('revshareModal');
            document.getElementById('revshareForm').reset();
        }

        function renderBonusTable() {
            const tbody = document.getElementById('bonusTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.bonusVersions.map(b => `
                <tr>
                    <td><strong>${escapeHtml(b.version)}</strong></td>
                    <td>${escapeHtml(b.effective)}</td>
                    <td>${escapeHtml(b.threshold)}</td>
                    <td>${escapeHtml(b.bonus)}</td>
                </tr>
            `).join('') || `<tr><td colspan="4" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無版本</td></tr>`;
        }

        function submitBonus() {
            const version = document.getElementById('bonusVersion').value.trim();
            const effective = document.getElementById('bonusEffective').value;
            const threshold = parseInt(document.getElementById('bonusThreshold').value || '0', 10);
            const bonus = parseInt(document.getElementById('bonusAmount').value || '0', 10);
            if (!version || !effective || !threshold || !bonus) { alert('請填寫完整資料'); return; }
            Data.bonusVersions.unshift({ version, effective, threshold, bonus });
            renderBonusTable();
            closeModal('bonusModal');
            document.getElementById('bonusForm').reset();
        }

        function submitRuleVersion() {
            const type = document.getElementById('ruleType').value;
            const version = document.getElementById('ruleVersion').value.trim();
            const effective = document.getElementById('ruleEffectiveDate').value;
            const content = document.getElementById('ruleContent').value.trim();
            if (!version || !effective) { alert('請填寫版本號與生效日'); return; }
            Data.ruleVersions.unshift({ type, version, effective, content });
            localStorage.setItem(LS_KEYS.RULE_VERSIONS, JSON.stringify(Data.ruleVersions));
            renderRuleVersionTable();
            closeModal('ruleVersionModal');
            document.getElementById('ruleVersionForm').reset();
        }

        function renderRuleVersionTable() {
            const tbody = document.getElementById('ruleVersionTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.ruleVersions.map(r => `
                <tr>
                    <td>${r.type}</td>
                    <td><strong>${escapeHtml(r.version)}</strong></td>
                    <td>${escapeHtml(r.effective)}</td>
                    <td style="color:var(--text-secondary);">${escapeHtml(r.content || '')}</td>
                </tr>
            `).join('') || `<tr><td colspan="4" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無版本</td></tr>`;
        }

        /* ===== 10.3.3：工單 / 爭議 ===== */
        function renderTicketTable() {
            const tbody = document.getElementById('ticketTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.tickets.map(t => {
                const dueText = t.sla || '-';
                return `
                    <tr>
                        <td><strong>${escapeHtml(t.id)}</strong></td>
                        <td>${escapeHtml(t.type)}</td>
                        <td>${escapeHtml(t.title)}</td>
                        <td>${escapeHtml(t.createdAt)}</td>
                        <td>${escapeHtml(dueText)}</td>
                        <td><span class="badge ${badgeByStatus(t.status)}">${escapeHtml(t.status)}</span></td>
                        <td>${escapeHtml(t.assignee || '-')}</td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="viewTicket('${t.id}')">查看</button>
                            <button class="btn btn-primary btn-sm" onclick="openTicketModal('${t.id}')">處理</button>
                        </td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="8" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無工單</td></tr>`;
        }

        function viewTicket(id) {
            const t = Data.tickets.find(x => x.id === id);
            const events = (Data.ticketEvents[id] || []).map(e => `- ${e.time} / ${e.action} / ${e.by} / ${e.note}`).join('\n');
            if (!t) return;
            alert(`工單 ${t.id}\n\n類型：${t.type}\n標題：${t.title}\n狀態：${t.status}\n處理人：${t.assignee}\n\n事件紀錄：\n${events || '（無）'}`);
        }

        function openTicketModal(id) {
            const t = Data.tickets.find(x => x.id === id);
            if (!t) return;
            document.getElementById('ticketId').value = t.id;
            document.getElementById('ticketStatus').value = t.status;
            document.getElementById('ticketAssignee').value = t.assignee || '';
            document.getElementById('ticketCloseReason').value = '';
            document.getElementById('ticketNote').value = '';
            openModal('ticketModal');
        }

        function submitTicketUpdate() {
            const id = document.getElementById('ticketId').value;
            const status = document.getElementById('ticketStatus').value;
            const assignee = document.getElementById('ticketAssignee').value.trim();
            const closeReason = document.getElementById('ticketCloseReason').value.trim();
            const note = document.getElementById('ticketNote').value.trim();
            const t = Data.tickets.find(x => x.id === id);
            if (!t) return;
            t.status = status;
            t.assignee = assignee;
            const time = new Date().toISOString().slice(0, 16).replace('T', ' ');
            Data.ticketEvents[id] = Data.ticketEvents[id] || [];
            Data.ticketEvents[id].unshift({ time, action: status === 'closed' ? '結案' : '更新', by: '陳管理員', note: [note, closeReason ? `結案原因：${closeReason}` : ''].filter(Boolean).join('；') || '—' });
            closeModal('ticketModal');
            renderTicketTable();
            alert('工單已更新（示意）。');
        }

        /* ===== 10.3.4：財務結算（AR/AP/催收/對帳單匯出） ===== */
        function renderArTable() {
            const status = (document.getElementById('arStatusFilter') || {}).value || '';
            const kw = ((document.getElementById('arKeyword') || {}).value || '').trim();
            const tbody = document.getElementById('arTbody');
            if (!tbody) return;
            const rows = Data.ar
                .filter(x => !status || x.status === status)
                .filter(x => !kw || (x.id + x.target + x.period).includes(kw));
            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td><strong>${escapeHtml(r.id)}</strong></td>
                    <td>${escapeHtml(r.target)}</td>
                    <td>${escapeHtml(r.period)}</td>
                    <td>NT$ ${escapeHtml(r.amount.toLocaleString())}</td>
                    <td>${escapeHtml(r.due)}</td>
                    <td><span class="badge ${badgeByStatus(r.status)}">${escapeHtml(r.status)}</span></td>
                    <td>
                        ${r.paid ? '<span class="badge badge-success">已確認</span>' : `<button class="btn btn-primary btn-sm" onclick="confirmArPaid('${r.id}')">確認已收</button>`}
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="7" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無資料</td></tr>`;
        }

        function confirmArPaid(id) {
            const rec = Data.ar.find(x => x.id === id);
            if (!rec) return;
            const voucher = prompt('請輸入收款憑證編號/備註（示意）');
            if (voucher === null) return;
            rec.paid = true;
            rec.status = 'paid';
            AppState.collectionLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), arId: id, stage: '收款確認', action: '已收', by: '平台財務-小林', note: voucher || '—' });
            renderArTable();
            renderCollectionLogTable();
            renderCollectionTable();
        }

        function renderApTable() {
            const status = (document.getElementById('apStatusFilter') || {}).value || '';
            const kw = ((document.getElementById('apKeyword') || {}).value || '').trim();
            const tbody = document.getElementById('apTbody');
            if (!tbody) return;
            const rows = Data.ap
                .filter(x => !status || x.status === status)
                .filter(x => !kw || (x.id + x.target + x.period).includes(kw));
            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td><strong>${escapeHtml(r.id)}</strong></td>
                    <td>${escapeHtml(r.target)}</td>
                    <td>${escapeHtml(r.period)}</td>
                    <td>NT$ ${escapeHtml(r.amount.toLocaleString())}</td>
                    <td>${escapeHtml(r.payDate || '-')}</td>
                    <td><span class="badge ${badgeByStatus(r.status)}">${escapeHtml(r.status)}</span></td>
                    <td>
                        ${r.status === 'paid' ? '<span class="badge badge-success">已確認</span>' : `<button class="btn btn-primary btn-sm" onclick="confirmApPaid('${r.id}')">確認已付</button>`}
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="7" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無資料</td></tr>`;
        }

        function confirmApPaid(id) {
            const rec = Data.ap.find(x => x.id === id);
            if (!rec) return;
            const voucher = prompt('請輸入付款憑證編號/備註（示意）');
            if (voucher === null) return;
            rec.status = 'paid';
            rec.payDate = new Date().toISOString().slice(0, 10);
            AppState.statementLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), type: 'AP 付款確認', period: rec.period, by: '平台財務-小林', status: '完成' });
            renderApTable();
            renderStatementLogTable();
        }

        function renderCollectionTable() {
            const tbody = document.getElementById('collectionTbody');
            if (!tbody) return;
            const overdue = Data.ar.filter(x => x.status === 'overdue' && !x.paid);
            tbody.innerHTML = overdue.map(r => {
                const days = Math.max(1, Math.floor((Date.now() - new Date(r.due).getTime()) / 86400000));
                const stage = days <= 7 ? '提醒' : (days <= 14 ? '催告' : '升級');
                const next = stage === '提醒' ? '發送提醒' : (stage === '催告' ? '發送催告' : '升級法務');
                return `
                    <tr>
                        <td><strong>${escapeHtml(r.id)}</strong></td>
                        <td>${escapeHtml(r.target)}</td>
                        <td><span class="badge badge-danger">${days} 天</span></td>
                        <td>${escapeHtml(stage)}</td>
                        <td>${escapeHtml(next)}</td>
                        <td><button class="btn btn-outline btn-sm" onclick="pushCollection('${r.id}','${stage}')">執行</button></td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="6" style="color:var(--text-secondary); text-align:center; padding:24px;">目前無逾期單</td></tr>`;
        }

        function pushCollection(arId, stage) {
            const action = stage === '提醒' ? '提醒通知' : (stage === '催告' ? '催告通知' : '升級');
            const note = prompt(`輸入備註（示意）：${action}`) || '—';
            AppState.collectionLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), arId, stage, action, by: '平台財務-小林', note });
            renderCollectionLogTable();
            alert('已寫入催告紀錄（示意）。');
        }

        function renderCollectionLogTable() {
            const tbody = document.getElementById('collectionLogTbody');
            if (!tbody) return;
            tbody.innerHTML = AppState.collectionLogs.map(l => `
                <tr>
                    <td>${escapeHtml(l.time)}</td>
                    <td>${escapeHtml(l.arId)}</td>
                    <td>${escapeHtml(l.stage)}</td>
                    <td>${escapeHtml(l.action)}</td>
                    <td>${escapeHtml(l.by)}</td>
                    <td>${escapeHtml(l.note)}</td>
                </tr>
            `).join('') || `<tr><td colspan="6" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無紀錄</td></tr>`;
        }

        function exportStatement(type) {
            const now = new Date().toISOString().slice(0, 16).replace('T', ' ');
            const label = type === 'store' ? '門店對帳單' : (type === 'project' ? '建案對帳單' : '平台業務對帳單');
            AppState.statementLogs.unshift({ time: now, type: label, period: '2026-01', by: '平台財務-小林', status: '完成' });
            renderStatementLogTable();
            alert(`${label} 匯出成功（示意）。`);
        }

        function renderStatementLogTable() {
            const tbody = document.getElementById('statementLogTbody');
            if (!tbody) return;
            tbody.innerHTML = AppState.statementLogs.map(l => `
                <tr>
                    <td>${escapeHtml(l.time)}</td>
                    <td>${escapeHtml(l.type)}</td>
                    <td>${escapeHtml(l.period)}</td>
                    <td>${escapeHtml(l.by)}</td>
                    <td><span class="badge badge-success">${escapeHtml(l.status)}</span></td>
                </tr>
            `).join('') || `<tr><td colspan="5" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無匯出紀錄</td></tr>`;
        }

        /* ===== 10.3.5：風控中心 ===== */
        function refreshRiskSignals() {
            alert('已刷新監控（示意）。');
            renderRiskTables();
        }

        function renderRiskTables() {
            const pTbody = document.getElementById('riskProjectTbody');
            if (pTbody) {
                pTbody.innerHTML = Data.riskProjects.map(r => `
                    <tr>
                        <td><strong>${escapeHtml(r.target)}</strong></td>
                        <td>${escapeHtml(r.developer)}</td>
                        <td><span class="badge ${r.sla30 < 80 ? 'badge-danger' : 'badge-success'}">${escapeHtml(r.sla30)}%</span></td>
                        <td><span class="badge ${r.reject30 > 35 ? 'badge-danger' : 'badge-success'}">${escapeHtml(r.reject30)}%</span></td>
                        <td><span class="badge badge-warning">${escapeHtml(r.signal)}</span></td>
                        <td>${escapeHtml(r.suggestion)}</td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="riskAction('${r.target}','${r.signal}','需審核')">需審核</button>
                            <button class="btn btn-outline btn-sm" onclick="riskAction('${r.target}','${r.signal}','限額')">限額</button>
                            <button class="btn btn-danger btn-sm" onclick="riskAction('${r.target}','${r.signal}','停權')">停權</button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="7" style="color:var(--text-secondary); text-align:center; padding:24px;">無資料</td></tr>`;
            }

            const sTbody = document.getElementById('riskStoreTbody');
            if (sTbody) {
                sTbody.innerHTML = Data.riskStores.map(r => `
                    <tr>
                        <td><strong>${escapeHtml(r.target)}</strong></td>
                        <td>${escapeHtml(r.type)}</td>
                        <td>${escapeHtml(r.burst)}</td>
                        <td><span class="badge ${r.cancel >= 30 ? 'badge-danger' : 'badge-success'}">${escapeHtml(r.cancel)}%</span></td>
                        <td><span class="badge ${r.noshow >= 15 ? 'badge-warning' : 'badge-success'}">${escapeHtml(r.noshow)}%</span></td>
                        <td><span class="badge badge-warning">${escapeHtml(r.signal)}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="riskAction('${r.target}','${r.signal}','限額')">限額</button>
                            <button class="btn btn-outline btn-sm" onclick="riskAction('${r.target}','${r.signal}','需審核')">需審核</button>
                            <button class="btn btn-danger btn-sm" onclick="openSuspendModal('${r.target}')">停權</button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="7" style="color:var(--text-secondary); text-align:center; padding:24px;">無資料</td></tr>`;
            }

            renderRiskActionLogs();
        }

        function riskAction(target, signal, action) {
            const note = prompt('備註（示意）') || '—';
            AppState.riskActionLogs.unshift({ time: new Date().toISOString().slice(0, 16).replace('T', ' '), target, signal, action, by: '風控-小周', note });
            renderRiskActionLogs();
            if (action === '停權') {
                openSuspendModal(target);
            } else {
                alert('已寫入處置紀錄（示意）。');
            }
        }

        function renderRiskActionLogs() {
            const tbody = document.getElementById('riskActionLogTbody');
            if (!tbody) return;
            tbody.innerHTML = AppState.riskActionLogs.map(l => `
                <tr>
                    <td>${escapeHtml(l.time)}</td>
                    <td>${escapeHtml(l.target)}</td>
                    <td>${escapeHtml(l.signal)}</td>
                    <td>${escapeHtml(l.action)}</td>
                    <td>${escapeHtml(l.by)}</td>
                    <td>${escapeHtml(l.note)}</td>
                </tr>
            `).join('') || `<tr><td colspan="6" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無紀錄</td></tr>`;
        }

        /* ===== 10.3.7：Extension fields / Demo mode ===== */
        function initDemoModeUI() {
            // 目前原檔已有按鈕 demoModeBtn，這裡不改既有 DOM 結構
            const btn = document.getElementById('demoModeBtn');
            if (!btn) return;
            const refreshText = () => {
                btn.textContent = `演示模式：${AppState.demoMode ? 'ON' : 'OFF'}`;
                btn.classList.toggle('btn-primary', AppState.demoMode);
                btn.classList.toggle('btn-outline', !AppState.demoMode);
            };
            refreshText();
            btn.addEventListener('click', () => {
                AppState.demoMode = !AppState.demoMode;
                localStorage.setItem(LS_KEYS.DEMO_MODE, AppState.demoMode ? '1' : '0');
                refreshText();
                alert(AppState.demoMode ? '已切換為演示模式（示意）。' : '已切換為正式模式（示意）。');
            });
        }

        // 兼容既有 onclick="toggleDemoMode()"（不改原碼）
        function toggleDemoMode() {
            AppState.demoMode = !AppState.demoMode;
            localStorage.setItem(LS_KEYS.DEMO_MODE, AppState.demoMode ? '1' : '0');
            const btn = document.getElementById('demoModeBtn');
            if (btn) {
                btn.textContent = `演示模式：${AppState.demoMode ? 'ON' : 'OFF'}`;
                btn.classList.toggle('btn-primary', AppState.demoMode);
                btn.classList.toggle('btn-outline', !AppState.demoMode);
            }
            alert(AppState.demoMode ? '已切換為演示模式（示意）。' : '已切換為正式模式（示意）。');
        }

        function renderExtensionFieldTable() {
            const tbody = document.getElementById('extFieldTbody');
            if (!tbody) return;
            tbody.innerHTML = Data.extensionFields.map(f => `
                <tr>
                    <td><strong>${escapeHtml(f.key)}</strong></td>
                    <td>${escapeHtml(f.name)}</td>
                    <td>${escapeHtml(f.type)}</td>
                    <td>${escapeHtml(f.scope)}</td>
                    <td>${f.required ? '<span class="badge badge-warning">必填</span>' : '<span class="badge badge-secondary">選填</span>'}</td>
                    <td style="color:var(--text-secondary);">${escapeHtml(f.rule || '-')}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editExtensionField('${f.key}')">編輯</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="7" style="color:var(--text-secondary); text-align:center; padding:24px;">尚無欄位</td></tr>`;
        }

        function openAddExtensionFieldModal() {
            document.getElementById('extKey').value = '';
            document.getElementById('extName').value = '';
            document.getElementById('extType').value = 'string';
            document.getElementById('extScope').value = 'booking';
            document.getElementById('extRequired').checked = false;
            document.getElementById('extRule').value = '';
            openModal('extensionFieldModal');
        }

        function editExtensionField(key) {
            const f = Data.extensionFields.find(x => x.key === key);
            if (!f) return;
            document.getElementById('extKey').value = f.key;
            document.getElementById('extName').value = f.name;
            document.getElementById('extType').value = f.type;
            document.getElementById('extScope').value = f.scope;
            document.getElementById('extRequired').checked = !!f.required;
            document.getElementById('extRule').value = f.rule || '';
            openModal('extensionFieldModal');
        }

        function submitExtensionField() {
            const key = document.getElementById('extKey').value.trim();
            const name = document.getElementById('extName').value.trim();
            const type = document.getElementById('extType').value;
            const scope = document.getElementById('extScope').value;
            const required = document.getElementById('extRequired').checked;
            const rule = document.getElementById('extRule').value.trim();
            if (!key || !name) { alert('請填寫 Key 與名稱'); return; }
            const existing = Data.extensionFields.find(x => x.key === key);
            if (existing) {
                existing.name = name; existing.type = type; existing.scope = scope; existing.required = required; existing.rule = rule;
            } else {
                Data.extensionFields.unshift({ key, name, type, scope, required, rule });
            }
            localStorage.setItem(LS_KEYS.EXT_FIELDS, JSON.stringify(Data.extensionFields));
            renderExtensionFieldTable();
            closeModal('extensionFieldModal');
            alert('已儲存自定義欄位（示意）。');
        }

        /* ===== 初始化 ===== */
        document.addEventListener('DOMContentLoaded', () => {
            initProjectUploader();
            initEditProjectUploader();
            ensureSeedProjectsInStorage();
            loadProjectsFromStorage();

            renderOrgAuditTable();
            renderOrgAuditLogs();
            renderSuspensionTable();
            renderBlacklistRuleTable();
            renderRbacRoleSelect();
            renderRbacMatrix();
            renderContractTable();
            renderAttributionTable();
            renderRevshareTable();
            renderBonusTable();
            renderRuleVersionTable();
            renderTicketTable();
            renderArTable();
            renderApTable();
            renderCollectionTable();
            renderCollectionLogTable();
            renderStatementLogTable();
            renderRiskTables();
            initDemoModeUI();
            renderExtensionFieldTable();

            // RBAC role 切換
            const rSel = document.getElementById('rbacRoleSelect');
            if (rSel) rSel.addEventListener('change', renderRbacMatrix);
        });

        // 用戶詳情
        function viewUserDetail(name) {
            alert(`查看用戶詳情：${name}\n\n本月報備：15 筆\n核可後取消：6 筆\n取消率：40%\n\n建議採取措施：\n1. 發送警告通知\n2. 限制報備次數\n3. 若持續違規則停用帳號`);
        }

        // 點擊 modal 外部關閉
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
