<!doctype html>
<!--
  Copaws å¯µç‰©æ—¥è¨˜ - æ¯›å­©ç®¡ç†é‡æ§‹ç‰ˆ

  è³‡æ–™çµæ§‹ï¼š
  - ownerProfile: { ownerName, birthday, email, phone, gender, avatar }
  - pets: [{ petId, name, type, gender, breed, birthdayOrAge, color, weight, avatar, notes: [{ noteId, title, content, tag, pinned, createdAt, updatedAt }] }]
  - photos: [{ photoId, date, image, note, time, petIds: [] }] // petIds ç‚ºé—œè¯çš„å¯µç‰© ID é™£åˆ—
  - selectedPetFilter: [] // æ—¥æ›†ç¯©é¸çš„å¯µç‰© IDï¼ˆç©ºé™£åˆ—è¡¨ç¤ºé¡¯ç¤ºå…¨éƒ¨ï¼‰

  localStorage Key: 'copawsAppData'
  ç‰ˆæœ¬è™Ÿ: 'v2' (ç”¨æ–¼è³‡æ–™é·ç§»åˆ¤æ–·)

  ä¸»è¦ Render å‡½å¼ï¼š
  - renderOwnerProfile(): æ¸²æŸ“é£¼ä¸»è³‡æ–™å€
  - renderPetsList(): æ¸²æŸ“å¯µç‰©æ¸…å–®
  - renderPetNotes(petId): æ¸²æŸ“ç‰¹å®šå¯µç‰©çš„æ³¨æ„äº‹é …
  - renderPetSelector(): æ¸²æŸ“ä¸Šå‚³é é¢çš„å¯µç‰©é¸æ“‡å™¨
  - renderPetFilter(): æ¸²æŸ“æ—¥æ›†é é¢çš„å¯µç‰©ç¯©é¸å™¨
  - openPetEditModal(petId): é–‹å•Ÿå¯µç‰©ç·¨è¼¯ Modal
  - openNotesModal(petId): é–‹å•Ÿæ³¨æ„äº‹é … Modal
-->
<html lang="zh-TW" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copaws å¯µç‰©æ—¥è¨˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    /* æ ¸å¿ƒä½ˆå±€ï¼šé–å®šè¦–çª—é«˜åº¦ï¼Œç¢ºä¿å°èˆªæ¬„å›ºå®š */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
    }

    .tab-active {
      color: #0c5832;
      border-bottom: 3px solid #0c5832;
    }

    .paw-button {
      transition: all 0.3s ease;
      position: relative;
    }

    .paw-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(12, 88, 50, 0.3);
    }

    .paw-button:active { transform: scale(0.95); }

    /* æ—¥æ›†æ¨£å¼ï¼šç§»é™¤é‚Šæ¡†æ ¼ç·š */
    .calendar-grid-no-border {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
    }

    .calendar-day {
      transition: all 0.2s ease;
      position: relative;
      background: transparent;
      border: none;
      height: 70px;
    }

    .calendar-day:hover { transform: scale(1.08); }

    /* ç…§ç‰‡å †ç–Šæ•ˆæœ */
    .photo-stack {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .photo-stack-item {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: transform 0.2s ease;
      background: #eee;
    }

    .photo-stack-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* å †ç–Šåƒæ•¸ */
    .photo-stack-item:nth-child(1) { transform: translate(0, 0) rotate(0deg); z-index: 3; }
    .photo-stack-item:nth-child(2) { transform: translate(3px, 3px) rotate(4deg); z-index: 2; }
    .photo-stack-item:nth-child(3) { transform: translate(6px, 6px) rotate(-4deg); z-index: 1; }

    .calendar-day:hover .photo-stack-item:nth-child(1) { transform: translate(-2px, -2px) rotate(-3deg); }

    /* æ—¥æœŸæ•¸å­—é¡è‰²ï¼šçµ±ä¸€ç‚ºç¶ è‰² */
    .day-number {
      position: absolute;
      bottom: 4px;
      right: 4px;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      padding: 1px 5px;
      border-radius: 4px;
      z-index: 10;
      font-weight: 800;
      color: #0c5832;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .no-photo-day {
      color: #0c5832;
      font-weight: 800;
      font-size: 14px;
    }

    /* å‹•ç•« */
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .page-transition-out { animation: fadeOutScale 0.4s ease forwards; }
    .page-transition-in { animation: fadeInScale 0.5s ease forwards; }
    @keyframes fadeOutScale { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    @keyframes fadeInScale { from { opacity: 0; transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }

    .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .scrollable::-webkit-scrollbar { width: 4px; }
    .scrollable::-webkit-scrollbar-thumb { background: #e5ad3f; border-radius: 4px; }

    .detail-page { position: absolute; inset: 0; z-index: 50; }

    .paw-icon {
      display: inline-block; animation: pawBounce 2s ease-in-out infinite;
      filter: sepia(100%) saturate(300%) hue-rotate(10deg) brightness(1.1);
    }
    @keyframes pawBounce { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(-5deg); } }

    .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 20px 60px rgba(12, 88, 50, 0.2); max-height: 90vh; overflow-y: auto; }
    .login-card::-webkit-scrollbar { width: 6px; }
    .login-card::-webkit-scrollbar-track { background: rgba(200, 230, 212, 0.3); border-radius: 10px; }
    .login-card::-webkit-scrollbar-thumb { background: #0c5832; border-radius: 10px; }
    .login-card::-webkit-scrollbar-thumb:hover { background: #0a4528; }
    .input-field { transition: all 0.3s ease; border-color: #c8e6d4; }
    .input-field:focus { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(12, 88, 50, 0.15); border-color: #0c5832; }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #0c5832; color: white; padding: 12px 24px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideDown 0.3s ease;
    }
    @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    .demo-badge {
      display: inline-block; background: linear-gradient(135deg, #e5ad3f 0%, #d99e2f 100%);
      color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;
    }

    /* Modal æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-content::-webkit-scrollbar { width: 6px; }
    .modal-content::-webkit-scrollbar-thumb { background: #0c5832; border-radius: 10px; }

    /* å¯µç‰©å¡ç‰‡æ¨£å¼ */
    .pet-card {
      background: white;
      border: 2px solid #c8e6d4;
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
    }

    .pet-card:hover {
      border-color: #0c5832;
      box-shadow: 0 4px 12px rgba(12, 88, 50, 0.15);
    }

    /* æ³¨æ„äº‹é …å¡ç‰‡ */
    .note-card {
      background: #f8fdf9;
      border: 1px solid #e0f2e6;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.2s ease;
    }

    .note-card:hover {
      border-color: #c8e6d4;
      box-shadow: 0 2px 8px rgba(12, 88, 50, 0.1);
    }

    .note-card.pinned {
      background: #fff8e1;
      border-color: #ffd54f;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
    }

    .badge-pinned {
      background: #ffd54f;
      color: #8b6914;
    }

    .badge-tag {
      background: #e0f2fe;
      color: #0369a1;
    }

    /* å¯µç‰©é¸æ“‡ Tag æ¨£å¼ */
    .pet-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid #c8e6d4;
      background: white;
      color: #0c5832;
    }

    .pet-tag:hover {
      border-color: #0c5832;
      background: #e7f5ee;
    }

    .pet-tag.selected {
      background: #0c5832;
      color: white;
      border-color: #0c5832;
    }

    .pet-tag.filter-tag {
      font-size: 11px;
      padding: 3px 8px;
    }

    .pet-tag.filter-tag.active {
      background: #0c5832;
      color: white;
    }

    .pet-tag-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #c8e6d4;
    }

    .pet-tag.selected .pet-tag-avatar {
      border-color: white;
    }

    .pet-tag.filter-tag.active .pet-tag-avatar {
      border-color: white;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-green-100 via-emerald-50 to-teal-100">
  <div class="w-full h-full bg-white flex flex-col relative">

   <!-- Login Screen -->
   <div id="login-screen" class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-8 overflow-hidden" style="background: linear-gradient(to bottom right, #e7f5ee, #d4ebe1, #c8e6d4);">
    <div class="absolute top-10 left-10 text-6xl opacity-30 paw-icon">ğŸ¾</div>
    <div class="absolute bottom-20 right-10 text-6xl opacity-30 paw-icon" style="animation-delay: 0.5s;">ğŸ¾</div>
    <div class="login-card w-full max-w-sm p-8 relative z-10">
     <div id="login-header" class="text-center mb-8">
      <div class="text-6xl mb-4 paw-icon">ğŸ¾</div>
      <h1 class="text-4xl font-extrabold mb-2" style="color: #0c5832;">Copaws</h1>
      <p class="text-gray-600 text-sm">è¨˜éŒ„å¯¶è²çš„æ¯ä¸€åˆ» â¤ï¸</p>
     </div>

     <div id="registration-header" class="text-center mb-3 hidden">
      <h1 class="text-xl font-extrabold" style="color: #0c5832;">å»ºç«‹å¸³è™Ÿ</h1>
     </div>

     <div id="auth-step-1" class="space-y-4">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Email æˆ–æ‰‹æ©Ÿè™Ÿç¢¼</label> <input type="text" id="auth-input" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:outline-none" placeholder="è¼¸å…¥ Email æˆ–æ‰‹æ©Ÿè™Ÿç¢¼"></div>
      <button id="auth-continue-btn" class="paw-button w-full text-white font-bold py-3 rounded-xl" style="background: linear-gradient(to right, #0c5832, #0a4528);"> ç¹¼çºŒ </button>
      <div class="text-center text-sm text-gray-500 my-4">æˆ–</div>
      <button id="google-login-btn" class="w-full bg-white border-2 border-gray-300 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-50 flex items-center justify-center gap-2">
       <svg class="w-5 h-5" viewbox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg> ä½¿ç”¨ Google ç™»å…¥
      </button>
     </div>

     <div id="registration-form" class="hidden space-y-2">
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">æš±ç¨± <span class="text-red-500">*</span></label> <input type="text" id="owner-nickname" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" placeholder="è«‹è¼¸å…¥æš±ç¨±" required></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">ç”Ÿæ—¥ <span class="text-red-500">*</span></label> <input type="date" id="owner-birthday" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" required></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">é€šè¨Š EMAIL</label> <input type="email" id="owner-email" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" placeholder="example@email.com"></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">é€šè¨Šé›»è©±</label> <input type="tel" id="owner-phone" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" placeholder="0912345678"></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">æ€§åˆ¥</label> <select id="owner-gender" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm"><option value="">è«‹é¸æ“‡</option><option value="male">ç”·</option><option value="female">å¥³</option><option value="other">å…¶ä»–</option></select></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">èˆˆè¶£</label> <input type="text" id="owner-interests" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" placeholder="ä¾‹å¦‚ï¼šæ”å½±ã€æ•£æ­¥ã€å¯µç‰©è¨“ç·´"></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">å–œæ­¡çš„å¯µç‰©é¡åˆ¥</label> <select id="owner-pet-type" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm"><option value="">è«‹é¸æ“‡</option><option value="dog">ğŸ¶ ç‹—ç‹—</option><option value="cat">ğŸ± è²“å’ª</option><option value="both">éƒ½å–œæ­¡</option></select></div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-0.5">å–œæ­¡çš„å¯µç‰©å“ç¨®</label> <input type="text" id="owner-pet-breed" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm" placeholder="ä¾‹å¦‚ï¼šæŸ´çŠ¬ã€è‹±çŸ­"></div>
      <button id="register-submit-btn" class="paw-button w-full text-white font-bold py-2.5 rounded-xl mt-3" style="background: linear-gradient(to right, #0c5832, #0a4528);"> é–‹å§‹è¨˜éŒ„ ğŸ¾ </button>
      <button id="back-to-login-btn" class="w-full text-gray-600 text-sm mt-1"> â† è¿”å› </button>
     </div>
    </div>
   </div>

   <!-- Main App -->
   <div id="main-app" class="h-full flex flex-col hidden overflow-hidden">
    <header class="h-12 flex-shrink-0 flex items-center justify-center px-6" style="background: linear-gradient(to right, #0c5832, #0a4528);">
     <h1 id="app-title" class="text-white font-bold text-lg">ğŸ¾ Copaws</h1><span class="demo-badge">ç¤ºç¯„æ¨¡å¼</span>
    </header>

    <main class="flex-1 overflow-hidden relative">
      <div class="absolute inset-0 flex flex-col">

        <!-- Upload Tab -->
        <section id="upload-tab" class="flex-1 h-full p-4 overflow-auto" style="background: linear-gradient(to bottom, #e7f5ee, #ffffff);">
         <div class="text-center mb-3">
          <h2 class="text-xl font-bold mb-1" style="color: #0c5832;">ä¸Šå‚³ç…§ç‰‡ ğŸ“¸</h2>
          <p class="text-gray-600 text-xs">è¨˜éŒ„æ¯›å­©çš„ç¾å¥½æ™‚å…‰</p>
         </div>
         <label for="file-input" id="upload-btn" class="paw-button text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer mb-3" style="background: linear-gradient(to right, #e5ad3f, #d99e2f);"> <span class="text-2xl">ğŸ“·</span> <span>é¸æ“‡ç…§ç‰‡</span> </label>
         <input type="file" id="file-input" accept="image/*" class="hidden">

         <div id="upload-form-container" class="hidden space-y-3 pb-8">
          <div id="image-preview-wrapper" class="relative rounded-xl overflow-hidden shadow-lg"><img id="image-preview" class="w-full object-contain max-h-48"> <button id="remove-image-btn" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center">âœ•</button></div>

          <!-- å¯µç‰©é¸æ“‡å™¨ -->
          <div>
            <label class="block text-xs font-bold mb-1" style="color: #0c5832;">é¸æ“‡å¯µç‰©ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div id="pet-selector-container" class="flex flex-wrap gap-2">
              <!-- å¯µç‰© tags å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
          </div>

          <div><label class="block text-xs font-bold mb-1" style="color: #0c5832;">å¯«ä¸‹å›æ†¶</label> <textarea id="photo-note" class="input-field w-full px-3 py-2 border-2 rounded-xl focus:outline-none resize-none text-sm" rows="3" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼æœ‰è¶£çš„äº‹å‘¢ï¼Ÿ ğŸ˜Š"></textarea></div>
          <div><label class="block text-xs font-bold mb-1" style="color: #0c5832;">é¸æ“‡æ—¥æœŸ</label> <input type="date" id="photo-date" class="input-field w-full px-3 py-2 border-2 rounded-xl focus:outline-none text-sm"></div>
          <button id="save-photo-btn" class="paw-button w-full text-white font-bold py-3 rounded-xl" style="background: linear-gradient(to right, #0c5832, #0a4528);"> é–‹å§‹ä¸Šå‚³ âœ¨ </button>

          <div id="upload-progress-container" class="hidden">
            <div class="flex justify-between items-center mb-1">
              <span class="text-[10px] font-bold text-emerald-800">ä¸Šå‚³é€²åº¦</span>
              <span id="upload-pct-text" class="text-[10px] font-bold text-emerald-800">0%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="upload-progress-bar" class="h-full bg-emerald-500 transition-all duration-300" style="width: 0%;"></div>
            </div>
          </div>

          <div id="upload-success" class="hidden p-4 rounded-xl border-2 text-center bg-emerald-50 border-emerald-200 shadow-sm">
            <p class="font-bold text-emerald-800 mb-2">æˆåŠŸç´€éŒ„ç¾å¥½å›æ†¶~ âœ¨</p>
            <button id="upload-another-btn" class="paw-button w-full bg-emerald-800 text-white py-2 rounded-lg text-sm font-bold">ç¹¼çºŒä¸Šå‚³ä¸‹ä¸€å¼µ</button>
          </div>
         </div>
        </section>

        <!-- Calendar Tab -->
        <section id="calendar-tab" class="flex-1 h-full overflow-auto hidden" style="background: linear-gradient(to bottom, #e7f5ee, #ffffff);">
         <div class="p-5 pb-20">
          <!-- å¯µç‰©ç¯©é¸å™¨ -->
          <div class="mb-4">
            <div id="pet-filter-container" class="flex flex-wrap gap-2 justify-center">
              <!-- å¯µç‰©ç¯©é¸ tags å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
          </div>

          <div class="flex items-center justify-between mb-6">
           <button id="prev-month" class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-800 flex items-center justify-center font-bold">â—€</button>
           <h2 id="current-month" class="text-xl font-extrabold text-[#0c5832]"></h2>
           <button id="next-month" class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-800 flex items-center justify-center font-bold">â–¶</button>
          </div>
          <div class="grid grid-cols-7 gap-2 mb-4 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
           <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="calendar-grid-no-border"></div>
         </div>
        </section>

        <!-- Profile Tab - å®¶åº­ç®¡ç† -->
        <section id="profile-tab" class="flex-1 h-full overflow-auto hidden" style="background: linear-gradient(to bottom, #e7f5ee, #ffffff);">
         <div class="p-4 space-y-6 pb-20">

          <!-- é£¼ä¸»è³‡æ–™å€ -->
          <div class="bg-white rounded-2xl p-4 shadow-sm border-2 border-emerald-100">
            <h3 class="text-lg font-bold text-emerald-800 mb-3 flex items-center gap-2">
              <span>ğŸ‘¤</span>
              <span>é£¼ä¸»è³‡æ–™</span>
            </h3>
            <div class="space-y-2">
              <div><label class="text-[10px] font-bold text-gray-600 block mb-0.5">å§“å <span class="text-red-500">*</span></label><input type="text" id="owner-name-input" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm focus:outline-none" placeholder="è«‹è¼¸å…¥å§“å"></div>
              <div><label class="text-[10px] font-bold text-gray-600 block mb-0.5">ç”Ÿæ—¥ <span class="text-red-500">*</span></label><input type="date" id="owner-birthday-input" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm focus:outline-none"></div>
              <div><label class="text-[10px] font-bold text-gray-600 block mb-0.5">Email</label><input type="email" id="owner-email-input" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm focus:outline-none" placeholder="example@email.com"></div>
              <div><label class="text-[10px] font-bold text-gray-600 block mb-0.5">é›»è©±</label><input type="tel" id="owner-phone-input" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm focus:outline-none" placeholder="0912345678"></div>
              <div><label class="text-[10px] font-bold text-gray-600 block mb-0.5">æ€§åˆ¥</label><select id="owner-gender-input" class="input-field w-full px-3 py-1.5 border-2 rounded-lg text-sm focus:outline-none"><option value="">è«‹é¸æ“‡</option><option value="male">ç”·</option><option value="female">å¥³</option><option value="other">å…¶ä»–</option></select></div>
            </div>
            <button id="save-owner-btn" class="paw-button w-full mt-3 text-white font-bold py-2 rounded-xl text-sm" style="background: linear-gradient(to right, #0c5832, #0a4528);">å„²å­˜é£¼ä¸»è³‡æ–™</button>
          </div>

          <!-- å¯µç‰©æ¸…å–®å€ -->
          <div class="bg-white rounded-2xl p-4 shadow-sm border-2 border-emerald-100">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-bold text-emerald-800 flex items-center gap-2">
                <span>ğŸ¾</span>
                <span id="pets-count-title">æˆ‘çš„æ¯›å­© (0/5)</span>
              </h3>
            </div>
            <div id="pets-list-container" class="space-y-3 mb-3">
              <!-- å¯µç‰©å¡ç‰‡å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
            <button id="add-pet-btn" class="paw-button w-full text-emerald-800 font-bold py-2 rounded-xl text-sm border-2 border-emerald-800 hover:bg-emerald-50">+ æ–°å¢å¯µç‰©</button>
          </div>

          <button id="logout-btn" class="w-full bg-gray-100 text-gray-400 py-2 rounded-xl font-bold text-xs">ç™»å‡ºå¸³è™Ÿ</button>
         </div>
        </section>
      </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="h-20 flex-shrink-0 bg-white flex border-t border-emerald-100 shadow-[0_-4px_15px_rgba(0,0,0,0.03)]">
     <button id="nav-upload" class="flex-1 flex flex-col items-center justify-center tab-active transition"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg><span class="text-[10px] font-bold">ç´€éŒ„</span></button>
     <button id="nav-calendar" class="flex-1 flex flex-col items-center justify-center text-gray-400 transition"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg><span class="text-[10px] font-bold">å›æ†¶</span></button>
     <button id="nav-profile" class="flex-1 flex flex-col items-center justify-center text-gray-400 transition"><svg class="w-7 h-7 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-linecap="round" stroke-linejoin="round" /></svg><span class="text-[10px] font-bold">å®¶åº­</span></button>
    </nav>
   </div>

   <!-- Detail Page -->
   <div id="detail-page" class="detail-page hidden bg-white">
    <div class="h-full flex flex-col slide-up">
     <header class="h-14 flex-shrink-0 flex items-center px-4 border-b bg-white">
      <button id="back-btn" class="w-10 h-10 rounded-full bg-emerald-800 text-white flex items-center justify-center shadow-lg font-bold">â—€</button>
      <h2 id="detail-title" class="flex-1 text-center font-extrabold text-[#0c5832]">æ—¥æœŸ</h2>
      <div class="w-10"></div>
     </header>
     <div id="detail-content" class="flex-1 p-4 scrollable bg-gray-50/50"></div>
     <div id="next-date-hint" class="h-12 flex-shrink-0 flex items-center justify-center bg-emerald-50 text-emerald-800 text-[10px] font-bold tracking-widest">â†“â†“ ç¹¼çºŒå‘ä¸‹æ»‘å‹•ç¿»é–±ä¸‹ä¸€å¤© â†“â†“</div>
    </div>
   </div>

   <!-- å¯µç‰©ç·¨è¼¯ Modal -->
   <div id="pet-edit-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-4 border-b flex items-center justify-between bg-emerald-50">
        <h3 id="pet-edit-modal-title" class="text-lg font-bold text-emerald-800">ç·¨è¼¯å¯µç‰©</h3>
        <button id="close-pet-edit-modal" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">âœ•</button>
      </div>
      <div class="p-4 space-y-3">
        <input type="hidden" id="pet-edit-id">
        <input type="hidden" id="pet-edit-avatar-data">

        <!-- é ­åƒä¸Šå‚³å€åŸŸ -->
        <div class="flex flex-col items-center mb-3">
          <label class="text-xs font-bold text-gray-600 block mb-2">å¯µç‰©é ­åƒ</label>
          <div class="relative">
            <div id="pet-avatar-preview" class="w-24 h-24 rounded-full border-2 border-emerald-200 overflow-hidden bg-emerald-50 flex items-center justify-center cursor-pointer hover:border-emerald-400 transition">
              <span class="text-3xl">ğŸ“·</span>
            </div>
            <input type="file" id="pet-avatar-input" accept="image/*" class="hidden">
            <button type="button" onclick="document.getElementById('pet-avatar-input').click()" class="absolute bottom-0 right-0 w-8 h-8 bg-emerald-600 text-white rounded-full flex items-center justify-center text-xs font-bold hover:bg-emerald-700 shadow-lg">+</button>
          </div>
          <button type="button" id="remove-pet-avatar-btn" class="text-xs text-red-500 mt-2 hidden hover:underline">ç§»é™¤é ­åƒ</button>
        </div>

        <div><label class="text-xs font-bold text-gray-600 block mb-1">åå­— <span class="text-red-500">*</span></label><input type="text" id="pet-edit-name" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼šLucky"></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">é¡åˆ¥</label><select id="pet-edit-type" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none"><option value="dog">ğŸ¶ ç‹—ç‹—</option><option value="cat">ğŸ± è²“å’ª</option><option value="other">å…¶ä»–</option></select></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">æ€§åˆ¥</label><select id="pet-edit-gender" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none"><option value="male">å…¬</option><option value="female">æ¯</option></select></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">å“ç¨®</label><input type="text" id="pet-edit-breed" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼šæŸ´çŠ¬"></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">ç”Ÿæ—¥/å¹´é½¡</label><input type="text" id="pet-edit-birthday" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼š2020-01-01 æˆ– 3æ­²"></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">æ¯›è‰²</label><input type="text" id="pet-edit-color" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼šé»ƒè‰²"></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">é«”é‡ (kg)</label><input type="number" id="pet-edit-weight" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼š15"></div>
        <div class="flex gap-2 pt-2">
          <button id="save-pet-btn" class="flex-1 paw-button text-white font-bold py-2 rounded-xl text-sm" style="background: linear-gradient(to right, #0c5832, #0a4528);">å„²å­˜</button>
          <button id="delete-pet-btn" class="px-4 bg-red-500 text-white font-bold py-2 rounded-xl text-sm hover:bg-red-600">åˆªé™¤</button>
        </div>
      </div>
    </div>
   </div>

   <!-- æ³¨æ„äº‹é … Modal -->
   <div id="notes-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-4 border-b flex items-center justify-between bg-emerald-50">
        <h3 id="notes-modal-title" class="text-lg font-bold text-emerald-800">æ³¨æ„äº‹é …</h3>
        <button id="close-notes-modal" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">âœ•</button>
      </div>
      <div class="p-4">
        <input type="hidden" id="notes-pet-id">
        <button id="add-note-btn" class="w-full mb-3 paw-button text-emerald-800 font-bold py-2 rounded-xl text-sm border-2 border-emerald-800 hover:bg-emerald-50">+ æ–°å¢æ³¨æ„äº‹é …</button>
        <div id="notes-list-container" class="space-y-2">
          <!-- æ³¨æ„äº‹é …å¡ç‰‡å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
      </div>
    </div>
   </div>

   <!-- æ³¨æ„äº‹é …ç·¨è¼¯ Modal -->
   <div id="note-edit-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-4 border-b flex items-center justify-between bg-emerald-50">
        <h3 id="note-edit-modal-title" class="text-lg font-bold text-emerald-800">ç·¨è¼¯æ³¨æ„äº‹é …</h3>
        <button id="close-note-edit-modal" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">âœ•</button>
      </div>
      <div class="p-4 space-y-3">
        <input type="hidden" id="note-edit-id">
        <input type="hidden" id="note-edit-pet-id">
        <div><label class="text-xs font-bold text-gray-600 block mb-1">æ¨™é¡Œï¼ˆå¯é¸ï¼‰</label><input type="text" id="note-edit-title" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼šé£²é£Ÿæ³¨æ„"></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">å…§å®¹ <span class="text-red-500">*</span></label><textarea id="note-edit-content" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none resize-none" rows="4" placeholder="è«‹è¼¸å…¥æ³¨æ„äº‹é …å…§å®¹..."></textarea></div>
        <div><label class="text-xs font-bold text-gray-600 block mb-1">æ¨™ç±¤ï¼ˆå¯é¸ï¼‰</label><input type="text" id="note-edit-tag" class="input-field w-full px-3 py-2 border-2 rounded-lg text-sm focus:outline-none" placeholder="ä¾‹å¦‚ï¼šé‡è¦ã€å¥åº·ã€é£²é£Ÿ"></div>
        <div class="flex gap-2 pt-2">
          <button id="save-note-btn" class="flex-1 paw-button text-white font-bold py-2 rounded-xl text-sm" style="background: linear-gradient(to right, #0c5832, #0a4528);">å„²å­˜</button>
          <button id="delete-note-btn" class="px-4 bg-red-500 text-white font-bold py-2 rounded-xl text-sm hover:bg-red-600">åˆªé™¤</button>
        </div>
      </div>
    </div>
   </div>
  </div>

  <script>
    // ========== è³‡æ–™çµæ§‹èˆ‡ localStorage ç®¡ç† ==========
    const STORAGE_KEY = 'copawsAppData';
    const DATA_VERSION = 'v2';

    let appData = {
      version: DATA_VERSION,
      ownerProfile: {
        ownerName: '',
        birthday: '',
        email: '',
        phone: '',
        gender: '',
        avatar: null
      },
      pets: [],
      photos: [], // å„²å­˜ç…§ç‰‡è³‡æ–™ï¼ŒåŒ…å« petIds
      selectedPetIds: [], // ä¸Šå‚³æ™‚é¸ä¸­çš„å¯µç‰©
      selectedPetFilter: [], // æ—¥æ›†ç¯©é¸çš„å¯µç‰©ï¼ˆç©ºé™£åˆ—=å…¨éƒ¨ï¼‰
      currentPetId: null
    };

    // localStorage Helper å‡½æ•¸
    function loadAppData() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === DATA_VERSION) {
            appData = parsed;
            // ç¢ºä¿å¿…è¦çš„æ¬„ä½å­˜åœ¨
            if (!appData.photos) appData.photos = [];
            if (!appData.selectedPetIds) appData.selectedPetIds = [];
            if (!appData.selectedPetFilter) appData.selectedPetFilter = [];
          } else {
            migrateOldData();
          }
        }
      } catch (e) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
      }
    }

    function saveAppData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        return true;
      } catch (e) {
        console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e);
        showToast('å„²å­˜å¤±æ•—ï¼è³‡æ–™å¯èƒ½éå¤§ï¼Œè«‹å˜—è©¦ä½¿ç”¨è¼ƒå°çš„åœ–ç‰‡ã€‚');
        return false;
      }
    }

    function migrateOldData() {
      try {
        const oldPetProfile = localStorage.getItem('petProfile');
        if (oldPetProfile) {
          const old = JSON.parse(oldPetProfile);
          if (old.nickname) {
            appData.ownerProfile.ownerName = old.nickname;
          }
          if (old.birthday) appData.ownerProfile.birthday = old.birthday;
          if (old.email) appData.ownerProfile.email = old.email;
          if (old.phone) appData.ownerProfile.phone = old.phone;
          if (old.gender) appData.ownerProfile.gender = old.gender;

          if (old.name || old.age) {
            const firstPet = {
              petId: generateId(),
              name: old.name || 'Lucky',
              type: old.type || 'dog',
              gender: old.gender || 'male',
              breed: old.breed || '',
              birthdayOrAge: old.age ? old.age + 'æ­²' : '',
              color: old.color || '',
              weight: old.weight || '',
              avatar: null,
              notes: []
            };
            appData.pets.push(firstPet);
          }
        }

        appData.version = DATA_VERSION;
        appData.photos = [];
        appData.selectedPetIds = [];
        appData.selectedPetFilter = [];
        saveAppData();
      } catch (e) {
        console.error('è³‡æ–™é·ç§»å¤±æ•—:', e);
      }
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ========== Toast é€šçŸ¥ ==========
    function showToast(message) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = message;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    // ========== é£¼ä¸»è³‡æ–™ç®¡ç† ==========
    function renderOwnerProfile() {
      document.getElementById('owner-name-input').value = appData.ownerProfile.ownerName || '';
      document.getElementById('owner-birthday-input').value = appData.ownerProfile.birthday || '';
      document.getElementById('owner-email-input').value = appData.ownerProfile.email || '';
      document.getElementById('owner-phone-input').value = appData.ownerProfile.phone || '';
      document.getElementById('owner-gender-input').value = appData.ownerProfile.gender || '';
    }

    function saveOwnerProfile() {
      const ownerName = document.getElementById('owner-name-input').value.trim();
      const birthday = document.getElementById('owner-birthday-input').value;

      if (!ownerName) {
        showToast('è«‹è¼¸å…¥å§“åï¼');
        return;
      }
      if (!birthday) {
        showToast('è«‹é¸æ“‡ç”Ÿæ—¥ï¼');
        return;
      }

      appData.ownerProfile.ownerName = ownerName;
      appData.ownerProfile.birthday = birthday;
      appData.ownerProfile.email = document.getElementById('owner-email-input').value;
      appData.ownerProfile.phone = document.getElementById('owner-phone-input').value;
      appData.ownerProfile.gender = document.getElementById('owner-gender-input').value;

      saveAppData();
      showToast('é£¼ä¸»è³‡æ–™å·²å„²å­˜ï¼âœ¨');
    }

    // ========== å¯µç‰©ç®¡ç† ==========
    function renderPetsList() {
      const container = document.getElementById('pets-list-container');
      const countTitle = document.getElementById('pets-count-title');
      const addBtn = document.getElementById('add-pet-btn');

      countTitle.textContent = `æˆ‘çš„æ¯›å­© (${appData.pets.length}/5)`;

      if (appData.pets.length >= 5) {
        addBtn.disabled = true;
        addBtn.textContent = 'å·²é”ä¸Šé™ 5 éš»';
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        addBtn.disabled = false;
        addBtn.textContent = '+ æ–°å¢å¯µç‰©';
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      container.innerHTML = '';

      if (appData.pets.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">é‚„æ²’æœ‰å¯µç‰©è³‡æ–™ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢å§ï¼</p>';
        return;
      }

      appData.pets.forEach(pet => {
        const card = document.createElement('div');
        card.className = 'pet-card';

        const petIcon = pet.type === 'dog' ? 'ğŸ¶' : pet.type === 'cat' ? 'ğŸ±' : 'ğŸ¾';
        const genderIcon = pet.gender === 'male' ? 'â™‚' : 'â™€';
        const notesCount = pet.notes ? pet.notes.length : 0;

        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-2xl flex-shrink-0">
              ${pet.avatar ? `<img src="${pet.avatar}" class="w-full h-full object-cover rounded-full">` : petIcon}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h4 class="font-bold text-emerald-800">${pet.name}</h4>
                <span class="text-xs text-gray-500">${genderIcon}</span>
              </div>
              <div class="text-xs text-gray-600 space-y-0.5">
                ${pet.breed ? `<div>å“ç¨®ï¼š${pet.breed}</div>` : ''}
                ${pet.birthdayOrAge ? `<div>å¹´é½¡ï¼š${pet.birthdayOrAge}</div>` : ''}
                ${pet.weight ? `<div>é«”é‡ï¼š${pet.weight} kg</div>` : ''}
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button class="flex-1 text-xs font-bold py-1.5 rounded-lg border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-50" onclick="openPetEditModal('${pet.petId}')">ç·¨è¼¯è³‡æ–™</button>
            <button class="flex-1 text-xs font-bold py-1.5 rounded-lg border-2 border-amber-600 text-amber-600 hover:bg-amber-50" onclick="openNotesModal('${pet.petId}')">æ³¨æ„äº‹é … (${notesCount})</button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function openPetEditModal(petId = null) {
      const modal = document.getElementById('pet-edit-modal');
      const title = document.getElementById('pet-edit-modal-title');
      const deleteBtn = document.getElementById('delete-pet-btn');

      if (petId) {
        const pet = appData.pets.find(p => p.petId === petId);
        if (!pet) return;

        title.textContent = 'ç·¨è¼¯å¯µç‰©';
        deleteBtn.classList.remove('hidden');

        document.getElementById('pet-edit-id').value = pet.petId;
        document.getElementById('pet-edit-name').value = pet.name || '';
        document.getElementById('pet-edit-type').value = pet.type || 'dog';
        document.getElementById('pet-edit-gender').value = pet.gender || 'male';
        document.getElementById('pet-edit-breed').value = pet.breed || '';
        document.getElementById('pet-edit-birthday').value = pet.birthdayOrAge || '';
        document.getElementById('pet-edit-color').value = pet.color || '';
        document.getElementById('pet-edit-weight').value = pet.weight || '';

        // è¨­ç½®é ­åƒ
        document.getElementById('pet-edit-avatar-data').value = pet.avatar || '';
        updatePetAvatarPreview(pet.avatar);
      } else {
        title.textContent = 'æ–°å¢å¯µç‰©';
        deleteBtn.classList.add('hidden');

        document.getElementById('pet-edit-id').value = '';
        document.getElementById('pet-edit-name').value = '';
        document.getElementById('pet-edit-type').value = 'dog';
        document.getElementById('pet-edit-gender').value = 'male';
        document.getElementById('pet-edit-breed').value = '';
        document.getElementById('pet-edit-birthday').value = '';
        document.getElementById('pet-edit-color').value = '';
        document.getElementById('pet-edit-weight').value = '';

        // é‡ç½®é ­åƒ
        document.getElementById('pet-edit-avatar-data').value = '';
        updatePetAvatarPreview(null);
      }

      modal.classList.remove('hidden');
    }

    function closePetEditModal() {
      document.getElementById('pet-edit-modal').classList.add('hidden');
    }

    function savePet() {
      const petId = document.getElementById('pet-edit-id').value;
      const name = document.getElementById('pet-edit-name').value.trim();

      if (!name) {
        showToast('è«‹è¼¸å…¥å¯µç‰©åå­—ï¼');
        return;
      }

      const petData = {
        name: name,
        type: document.getElementById('pet-edit-type').value,
        gender: document.getElementById('pet-edit-gender').value,
        breed: document.getElementById('pet-edit-breed').value,
        birthdayOrAge: document.getElementById('pet-edit-birthday').value,
        color: document.getElementById('pet-edit-color').value,
        weight: document.getElementById('pet-edit-weight').value,
        avatar: document.getElementById('pet-edit-avatar-data').value || null
      };

      let isNewPet = false;

      if (petId) {
        const index = appData.pets.findIndex(p => p.petId === petId);
        if (index !== -1) {
          appData.pets[index] = { ...appData.pets[index], ...petData };
        }
      } else {
        if (appData.pets.length >= 5) {
          showToast('å·²é”ä¸Šé™ 5 éš»ï¼');
          return;
        }
        const newPet = {
          petId: generateId(),
          ...petData,
          notes: []
        };
        appData.pets.push(newPet);
        isNewPet = true;
      }

      const success = saveAppData();
      if (success) {
        showToast(isNewPet ? 'å¯µç‰©å·²æ–°å¢ï¼âœ¨' : 'å¯µç‰©è³‡æ–™å·²æ›´æ–°ï¼âœ¨');
        renderPetsList();
        renderPetSelector();
        renderPetFilter();
        closePetEditModal();
      }
    }

    function deletePet() {
      const petId = document.getElementById('pet-edit-id').value;
      if (!petId) return;

      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™éš»å¯µç‰©å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„æ³¨æ„äº‹é …ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) {
        appData.pets = appData.pets.filter(p => p.petId !== petId);
        // åŒæ™‚æ¸…ç†ç…§ç‰‡ä¸­çš„é—œè¯
        appData.photos.forEach(photo => {
          if (photo.petIds) {
            photo.petIds = photo.petIds.filter(id => id !== petId);
          }
        });
        saveAppData();
        renderPetsList();
        renderPetSelector();
        renderPetFilter();
        closePetEditModal();
        showToast('å¯µç‰©å·²åˆªé™¤');
      }
    }

    // ========== å¯µç‰©é¸æ“‡å™¨ï¼ˆä¸Šå‚³é é¢ï¼‰==========
    function renderPetSelector() {
      const container = document.getElementById('pet-selector-container');
      container.innerHTML = '';

      if (appData.pets.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-400">è«‹å…ˆåœ¨ã€Œå®¶åº­ã€é é¢æ–°å¢å¯µç‰©</p>';
        return;
      }

      appData.pets.forEach(pet => {
        const tag = document.createElement('div');
        tag.className = 'pet-tag';
        if (appData.selectedPetIds.includes(pet.petId)) {
          tag.classList.add('selected');
        }

        // ä½¿ç”¨é ­åƒæˆ–é è¨­åœ–ç¤º
        let iconHtml = '';
        if (pet.avatar) {
          iconHtml = `<img src="${pet.avatar}" class="pet-tag-avatar">`;
        } else {
          const petIcon = pet.type === 'dog' ? 'ğŸ¶' : pet.type === 'cat' ? 'ğŸ±' : 'ğŸ¾';
          iconHtml = `<span>${petIcon}</span>`;
        }
        tag.innerHTML = `${iconHtml}<span>${pet.name}</span>`;

        tag.onclick = () => {
          const index = appData.selectedPetIds.indexOf(pet.petId);
          if (index > -1) {
            appData.selectedPetIds.splice(index, 1);
            tag.classList.remove('selected');
          } else {
            appData.selectedPetIds.push(pet.petId);
            tag.classList.add('selected');
          }
        };

        container.appendChild(tag);
      });
    }

    // ========== å¯µç‰©ç¯©é¸å™¨ï¼ˆæ—¥æ›†é é¢ï¼‰==========
    function renderPetFilter() {
      const container = document.getElementById('pet-filter-container');
      container.innerHTML = '';

      // å…¨éƒ¨é¸é …
      const allTag = document.createElement('div');
      allTag.className = 'pet-tag filter-tag';
      if (appData.selectedPetFilter.length === 0) {
        allTag.classList.add('active');
      }
      allTag.innerHTML = '<span>å…¨éƒ¨</span>';
      allTag.onclick = () => {
        appData.selectedPetFilter = [];
        renderPetFilter();
        renderCalendar();
      };
      container.appendChild(allTag);

      // å€‹åˆ¥å¯µç‰©é¸é …
      appData.pets.forEach(pet => {
        const tag = document.createElement('div');
        tag.className = 'pet-tag filter-tag';
        if (appData.selectedPetFilter.includes(pet.petId)) {
          tag.classList.add('active');
        }

        // ä½¿ç”¨é ­åƒæˆ–é è¨­åœ–ç¤º
        let iconHtml = '';
        if (pet.avatar) {
          iconHtml = `<img src="${pet.avatar}" class="pet-tag-avatar">`;
        } else {
          const petIcon = pet.type === 'dog' ? 'ğŸ¶' : pet.type === 'cat' ? 'ğŸ±' : 'ğŸ¾';
          iconHtml = `<span>${petIcon}</span>`;
        }
        tag.innerHTML = `${iconHtml}<span>${pet.name}</span>`;

        tag.onclick = () => {
          const index = appData.selectedPetFilter.indexOf(pet.petId);
          if (index > -1) {
            appData.selectedPetFilter.splice(index, 1);
          } else {
            appData.selectedPetFilter.push(pet.petId);
          }
          renderPetFilter();
          renderCalendar();
        };

        container.appendChild(tag);
      });
    }

    // ========== æ³¨æ„äº‹é …ç®¡ç† ==========
    function openNotesModal(petId) {
      const pet = appData.pets.find(p => p.petId === petId);
      if (!pet) return;

      const modal = document.getElementById('notes-modal');
      const title = document.getElementById('notes-modal-title');

      title.textContent = `${pet.name} çš„æ³¨æ„äº‹é …`;
      document.getElementById('notes-pet-id').value = petId;

      renderPetNotes(petId);
      modal.classList.remove('hidden');
    }

    function closeNotesModal() {
      document.getElementById('notes-modal').classList.add('hidden');
    }

    function renderPetNotes(petId) {
      const pet = appData.pets.find(p => p.petId === petId);
      if (!pet) return;

      const container = document.getElementById('notes-list-container');
      container.innerHTML = '';

      if (!pet.notes || pet.notes.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">é‚„æ²’æœ‰æ³¨æ„äº‹é …</p>';
        return;
      }

      const sortedNotes = [...pet.notes].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      sortedNotes.forEach(note => {
        const card = document.createElement('div');
        card.className = `note-card ${note.pinned ? 'pinned' : ''}`;

        const timeStr = new Date(note.createdAt).toLocaleDateString('zh-TW');

        card.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-2">
            <div class="flex-1">
              ${note.title ? `<h5 class="font-bold text-sm text-emerald-800 mb-1">${note.title}</h5>` : ''}
              <p class="text-xs text-gray-700 whitespace-pre-wrap">${note.content}</p>
            </div>
            <button class="text-xl flex-shrink-0" onclick="toggleNotePin('${petId}', '${note.noteId}')">
              ${note.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
            </button>
          </div>
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-1">
              ${note.pinned ? '<span class="badge badge-pinned">ç½®é ‚</span>' : ''}
              ${note.tag ? `<span class="badge badge-tag">${note.tag}</span>` : ''}
              <span class="text-[10px] text-gray-400">${timeStr}</span>
            </div>
            <div class="flex gap-1">
              <button class="text-xs text-blue-600 font-bold" onclick="openNoteEditModal('${petId}', '${note.noteId}')">ç·¨è¼¯</button>
              <button class="text-xs text-red-600 font-bold" onclick="deleteNote('${petId}', '${note.noteId}')">åˆªé™¤</button>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function toggleNotePin(petId, noteId) {
      const pet = appData.pets.find(p => p.petId === petId);
      if (!pet || !pet.notes) return;

      const note = pet.notes.find(n => n.noteId === noteId);
      if (!note) return;

      note.pinned = !note.pinned;
      note.updatedAt = new Date().toISOString();

      saveAppData();
      renderPetNotes(petId);
      renderPetsList();
      showToast(note.pinned ? 'å·²ç½®é ‚' : 'å·²å–æ¶ˆç½®é ‚');
    }

    function openNoteEditModal(petId, noteId = null) {
      const modal = document.getElementById('note-edit-modal');
      const title = document.getElementById('note-edit-modal-title');
      const deleteBtn = document.getElementById('delete-note-btn');

      document.getElementById('note-edit-pet-id').value = petId;

      if (noteId) {
        const pet = appData.pets.find(p => p.petId === petId);
        if (!pet) return;
        const note = pet.notes.find(n => n.noteId === noteId);
        if (!note) return;

        title.textContent = 'ç·¨è¼¯æ³¨æ„äº‹é …';
        deleteBtn.classList.remove('hidden');

        document.getElementById('note-edit-id').value = note.noteId;
        document.getElementById('note-edit-title').value = note.title || '';
        document.getElementById('note-edit-content').value = note.content || '';
        document.getElementById('note-edit-tag').value = note.tag || '';
      } else {
        title.textContent = 'æ–°å¢æ³¨æ„äº‹é …';
        deleteBtn.classList.add('hidden');

        document.getElementById('note-edit-id').value = '';
        document.getElementById('note-edit-title').value = '';
        document.getElementById('note-edit-content').value = '';
        document.getElementById('note-edit-tag').value = '';
      }

      closeNotesModal();
      modal.classList.remove('hidden');
    }

    function closeNoteEditModal() {
      const modal = document.getElementById('note-edit-modal');
      modal.classList.add('hidden');

      const petId = document.getElementById('note-edit-pet-id').value;
      if (petId) {
        openNotesModal(petId);
      }
    }

    function saveNote() {
      const petId = document.getElementById('note-edit-pet-id').value;
      const noteId = document.getElementById('note-edit-id').value;
      const content = document.getElementById('note-edit-content').value.trim();

      if (!content) {
        showToast('è«‹è¼¸å…¥å…§å®¹ï¼');
        return;
      }

      const pet = appData.pets.find(p => p.petId === petId);
      if (!pet) return;

      if (!pet.notes) pet.notes = [];

      const noteData = {
        title: document.getElementById('note-edit-title').value.trim(),
        content: content,
        tag: document.getElementById('note-edit-tag').value.trim(),
        updatedAt: new Date().toISOString()
      };

      if (noteId) {
        const index = pet.notes.findIndex(n => n.noteId === noteId);
        if (index !== -1) {
          pet.notes[index] = { ...pet.notes[index], ...noteData };
          showToast('æ³¨æ„äº‹é …å·²æ›´æ–°ï¼âœ¨');
        }
      } else {
        const newNote = {
          noteId: generateId(),
          ...noteData,
          pinned: false,
          createdAt: new Date().toISOString()
        };
        pet.notes.push(newNote);
        showToast('æ³¨æ„äº‹é …å·²æ–°å¢ï¼âœ¨');
      }

      saveAppData();
      renderPetsList();

      document.getElementById('note-edit-modal').classList.add('hidden');
      openNotesModal(petId);
    }

    function deleteNote(petId, noteId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡æ³¨æ„äº‹é …å—ï¼Ÿ')) return;

      const pet = appData.pets.find(p => p.petId === petId);
      if (!pet || !pet.notes) return;

      pet.notes = pet.notes.filter(n => n.noteId !== noteId);

      saveAppData();
      renderPetNotes(petId);
      renderPetsList();
      showToast('æ³¨æ„äº‹é …å·²åˆªé™¤');
    }

    // ========== é ­åƒè™•ç† ==========
    function updatePetAvatarPreview(avatarUrl) {
      const preview = document.getElementById('pet-avatar-preview');
      const removeBtn = document.getElementById('remove-pet-avatar-btn');

      if (avatarUrl) {
        preview.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover">`;
        removeBtn.classList.remove('hidden');
      } else {
        preview.innerHTML = '<span class="text-3xl">ğŸ“·</span>';
        removeBtn.classList.add('hidden');
      }
    }

    function handlePetAvatarSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // æª¢æŸ¥æ–‡ä»¶é¡å‹
      if (!file.type.startsWith('image/')) {
        showToast('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶ï¼');
        return;
      }

      // æª¢æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        showToast('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MBï¼');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          // å£“ç¸®åœ–ç‰‡åˆ°æœ€å¤§ 400x400
          const maxSize = 400;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
          }

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // è½‰æ›ç‚º JPEG æ ¼å¼ï¼Œå“è³ª 0.8
          const compressedData = canvas.toDataURL('image/jpeg', 0.8);
          document.getElementById('pet-edit-avatar-data').value = compressedData;
          updatePetAvatarPreview(compressedData);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function removePetAvatar() {
      document.getElementById('pet-edit-avatar-data').value = '';
      updatePetAvatarPreview(null);
      document.getElementById('pet-avatar-input').value = '';
    }

    // ========== äº‹ä»¶ç¶å®š ==========
    document.getElementById('save-owner-btn').onclick = saveOwnerProfile;
    document.getElementById('add-pet-btn').onclick = () => openPetEditModal();
    document.getElementById('close-pet-edit-modal').onclick = closePetEditModal;
    document.getElementById('save-pet-btn').onclick = savePet;
    document.getElementById('delete-pet-btn').onclick = deletePet;
    document.getElementById('pet-avatar-input').onchange = handlePetAvatarSelect;
    document.getElementById('remove-pet-avatar-btn').onclick = removePetAvatar;
    document.getElementById('close-notes-modal').onclick = closeNotesModal;
    document.getElementById('add-note-btn').onclick = () => {
      const petId = document.getElementById('notes-pet-id').value;
      openNoteEditModal(petId);
    };
    document.getElementById('close-note-edit-modal').onclick = closeNoteEditModal;
    document.getElementById('save-note-btn').onclick = saveNote;

    // Modal é»æ“ŠèƒŒæ™¯é—œé–‰
    document.getElementById('pet-edit-modal').onclick = (e) => {
      if (e.target.id === 'pet-edit-modal') closePetEditModal();
    };
    document.getElementById('notes-modal').onclick = (e) => {
      if (e.target.id === 'notes-modal') closeNotesModal();
    };
    document.getElementById('note-edit-modal').onclick = (e) => {
      if (e.target.id === 'note-edit-modal') closeNoteEditModal();
    };

    // ========== åŸæœ‰åŠŸèƒ½ï¼šæ—¥æ›†èˆ‡ç…§ç‰‡ ==========

    // ç¤ºç¯„ç…§ç‰‡è³‡æ–™ï¼ˆåŒ…å« petIdsï¼‰
    const samplePhotos = {
      '2025-01-01': [{ image: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=600', note: 'å…ƒæ—¦å¿«æ¨‚ï¼èˆ‡ Lucky çš„ç¬¬ä¸€å¼µåˆç…§ ğŸ†', time: '00:15', petIds: [] }, { image: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=600', note: 'ç¡å¾—å¥½æ²‰', time: '10:00', petIds: [] }],
      '2025-01-02': [{ image: 'https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=600', note: 'å‡ºé–€æ•£æ­¥ï¼ä»Šå¤©é‡åˆ°äº†æŸ´çŠ¬æœ‹å‹ ğŸ•', time: '09:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1544568100-847a948585b9?w=600', note: 'å’Œé„°å±…å®¶çš„ç‹—ç‹—ç©è€ ğŸ•', time: '16:30', petIds: [] }],
      '2025-01-03': [{ image: 'https://images.unsplash.com/photo-1534361960057-19889db9621e?w=600', note: 'è²·äº†æ–°ç©å…·ï¼Œå®ƒå’¬è‘—ä¸æ”¾ ğŸ¦´', time: '15:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1530281700549-e82e7bf110d6?w=600', note: 'æ–°ç©å…·çœŸçš„å¾ˆå–œæ­¡', time: '18:20', petIds: [] }],
      '2025-01-04': [{ image: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=600', note: 'è‰åœ°è·‘è·‘æ—¥ï¼é«”åŠ›çœŸçš„å¾ˆå¥½ ğŸ’š', time: '14:20', petIds: [] }, { image: 'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=600', note: 'åœ¨å…¬åœ’ç©åˆ°ä¸æƒ³å›å®¶', time: '17:00', petIds: [] }],
      '2025-01-05': [{ image: 'https://images.unsplash.com/photo-1450778869180-41d0601e046e?w=600', note: 'é™ªä¸»äººçœ‹æ›¸ï¼ˆå…¶å¯¦æ˜¯åœ¨ç¡è¦ºï¼‰ğŸ’¤', time: '11:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?w=600', note: 'åˆç¡æ™‚é–“åˆ°', time: '14:30', petIds: [] }],
      '2025-01-06': [{ image: 'https://images.unsplash.com/photo-1558788353-f76d92427f16?w=600', note: 'ä»Šå¤©æ´—æ¾¡é¦™é¦™çš„ ğŸ›', time: '10:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1422565096762-bdb997a56a84?w=600', note: 'æ´—å®Œæ¾¡è®Šå¾—æ›´å¸¥äº†', time: '11:00', petIds: [] }],
      '2025-01-07': [{ image: 'https://images.unsplash.com/photo-1523480717984-24cba35ae1ef?w=600', note: 'å»å¯µç‰©åº—å‰ªæ¯›å›‰ âœ‚ï¸', time: '15:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1477884213360-7e9d7dcc1e48?w=600', note: 'æ–°é€ å‹è¶…å¯æ„›', time: '16:30', petIds: [] }],
      '2025-01-08': [{ image: 'https://images.unsplash.com/photo-1510771463146-e89e6e86560e?w=600', note: 'åœ¨æ²™ç™¼ä¸Šè³´åºŠä¸èµ·ä¾† ğŸ›‹ï¸', time: '09:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1576201836106-db1758fd1c97?w=600', note: 'çµ‚æ–¼é¡˜æ„èµ·åºŠäº†', time: '11:00', petIds: [] }],
      '2025-01-09': [{ image: 'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=600', note: 'ä»Šå¤©ç‰¹åˆ¥æ´»æ½‘ ğŸ¾', time: '14:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?w=600', note: 'ç©çƒç©å¾—å¥½é–‹å¿ƒ', time: '15:30', petIds: [] }, { image: 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=600', note: 'ç´¯äº†åœ¨æ¨¹ä¸‹ä¼‘æ¯', time: '17:00', petIds: [] }],
      '2025-01-10': [{ image: 'https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=600', note: 'æ…µæ‡¶çš„åˆå¾Œï¼Œé™½å…‰ç‘é€²ä¾†çœŸèˆ’æœ â˜€ï¸', time: '15:20', petIds: [] }, { image: 'https://images.unsplash.com/photo-1541364983171-a8ba01e95cfc?w=600', note: 'è¶´åœ¨çª—é‚Šçœ‹é¢¨æ™¯', time: '16:00', petIds: [] }],
      '2025-01-11': [{ image: 'https://images.unsplash.com/photo-1560807707-8cc77767d783?w=600', note: 'ä»Šå¤©æ˜¯ç¾å¥½çš„ä¸€å¤© âœ¨', time: '10:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1453227588063-bb302b62f50b?w=600', note: 'å’Œä¸»äººä¸€èµ·æ›¬å¤ªé™½', time: '14:00', petIds: [] }],
      '2025-01-12': [{ image: 'https://images.unsplash.com/photo-1415369629372-26f2fe60c467?w=600', note: 'ç™¼ç¾æ–°çš„æ¢éšªåœ°é» ğŸ—ºï¸', time: '09:30', petIds: [] }, { image: 'https://images.unsplash.com/photo-1526336024174-e58f5cdd8e13?w=600', note: 'å¥½å¥‡åœ°èä¾†èå»', time: '10:30', petIds: [] }],
      '2025-01-13': [{ image: 'https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?w=600', note: 'æœ€å–œæ­¡çš„åˆç¡æ™‚å…‰ ğŸ’¤', time: '13:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=600', note: 'ç¡åˆ°ä¸çœäººäº‹', time: '15:00', petIds: [] }],
      '2025-01-14': [{ image: 'https://images.unsplash.com/photo-1583512603806-077998240c7a?w=600', note: 'è¶…æ„›é€™å€‹æŠ±æ• ğŸ§¸', time: '11:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=600', note: 'æŠ±è‘—æŠ±æ•ä¸æ”¾', time: '12:00', petIds: [] }],
      '2025-01-15': [{ image: 'https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=600', note: 'å¥½å¥‡å¿ƒçˆ†æ£šçš„ä¸€å¤© ğŸ‘€', time: '10:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1444212477490-ca407925329e?w=600', note: 'ç™¼ç¾æœ‰è¶£çš„æ±è¥¿', time: '12:00', petIds: [] }, { image: 'https://images.unsplash.com/photo-1573865526739-10c1dd7463aa?w=600', note: 'ç›¯è‘—é–€å¤–çœ‹', time: '16:00', petIds: [] }]
    };

    let currentDate = new Date(2025, 0, 1);
    let isTransitioning = false;
    const detailContent = document.getElementById('detail-content');

    function detectAndFillPhone() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        const phoneInput = document.getElementById('owner-phone');
      }
    }

    // ç™»å…¥
    document.getElementById('auth-continue-btn').onclick = () => {
      document.getElementById('registration-form').classList.remove('hidden');
      document.getElementById('auth-step-1').classList.add('hidden');
      document.getElementById('login-header').classList.add('hidden');
      document.getElementById('registration-header').classList.remove('hidden');
      document.querySelector('.login-card').style.padding = '1.25rem';
      detectAndFillPhone();
    };

    document.getElementById('register-submit-btn').onclick = () => {
      const nickname = document.getElementById('owner-nickname').value.trim();
      const birthday = document.getElementById('owner-birthday').value;

      if (!nickname) {
        showToast('è«‹è¼¸å…¥æš±ç¨±ï¼');
        return;
      }
      if (!birthday) {
        showToast('è«‹é¸æ“‡ç”Ÿæ—¥ï¼');
        return;
      }

      appData.ownerProfile.ownerName = nickname;
      appData.ownerProfile.birthday = birthday;
      appData.ownerProfile.email = document.getElementById('owner-email').value;
      appData.ownerProfile.phone = document.getElementById('owner-phone').value;
      appData.ownerProfile.gender = document.getElementById('owner-gender').value;

      saveAppData();
      loginUser();
    };

    document.getElementById('google-login-btn').onclick = () => loginUser();

    document.getElementById('back-to-login-btn').onclick = () => {
      document.getElementById('registration-form').classList.add('hidden');
      document.getElementById('auth-step-1').classList.remove('hidden');
      document.getElementById('login-header').classList.remove('hidden');
      document.getElementById('registration-header').classList.add('hidden');
      document.querySelector('.login-card').style.padding = '2rem';
    };

    function loginUser() {
      showToast('ç™»å…¥æˆåŠŸï¼ğŸ¾');
      setTimeout(() => {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        renderCalendar();
      }, 1000);
    }

    // Tab åˆ‡æ›
    function showTab(id) {
      ['upload', 'calendar', 'profile'].forEach(t => {
        document.getElementById(t + '-tab').classList.add('hidden');
        document.getElementById('nav-' + t).classList.remove('tab-active');
        document.getElementById('nav-' + t).classList.add('text-gray-400');
      });
      document.getElementById(id + '-tab').classList.remove('hidden');
      document.getElementById('nav-' + id).classList.add('tab-active');
      document.getElementById('nav-' + id).classList.remove('text-gray-400');
      if(id === 'calendar') {
        renderPetFilter();
        renderCalendar();
      }
      if(id === 'profile') {
        renderOwnerProfile();
        renderPetsList();
      }
      if(id === 'upload') {
        renderPetSelector();
      }
    }
    document.getElementById('nav-upload').onclick = () => showTab('upload');
    document.getElementById('nav-calendar').onclick = () => showTab('calendar');
    document.getElementById('nav-profile').onclick = () => showTab('profile');

    // æ—¥æ›†æ¸²æŸ“ï¼ˆæ”¯æ´ç¯©é¸ï¼‰
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('current-month').textContent = `${year} å¹´ ${month + 1} æœˆ`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        let photos = samplePhotos[dateStr];

        // æ ¹æ“šç¯©é¸å™¨éæ¿¾ç…§ç‰‡
        if (photos && appData.selectedPetFilter.length > 0) {
          photos = photos.filter(photo => {
            // å¦‚æœç…§ç‰‡æ²’æœ‰é—œè¯å¯µç‰©ï¼Œæˆ–é—œè¯çš„å¯µç‰©åœ¨ç¯©é¸å™¨ä¸­
            if (!photo.petIds || photo.petIds.length === 0) return true;
            return photo.petIds.some(petId => appData.selectedPetFilter.includes(petId));
          });
        }

        const cell = document.createElement('button');
        cell.className = 'calendar-day rounded-xl flex items-center justify-center';

        if (photos && photos.length > 0) {
          cell.classList.add('has-entry');
          let stackHtml = '<div class="photo-stack">';
          const displayCount = Math.min(3, photos.length);
          for(let i=0; i<displayCount; i++){
            stackHtml += `<div class="photo-stack-item"><img src="${photos[i].image}"></div>`;
          }
          stackHtml += '</div>';
          cell.innerHTML = `${stackHtml}<span class="day-number">${day}</span>`;
          cell.onclick = () => openDetailPage(dateStr);
        } else {
          cell.innerHTML = `<span class="no-photo-day">${day}</span>`;
        }
        grid.appendChild(cell);
      }
    }

    function openDetailPage(dateStr) {
      renderDetailPage(dateStr);
      document.getElementById('detail-page').classList.remove('hidden');
    }

    function renderDetailPage(dateStr) {
      const [year, month, day] = dateStr.split('-');
      document.getElementById('detail-title').textContent = `${year} å¹´ ${parseInt(month)} æœˆ ${parseInt(day)} æ—¥`;
      let photos = samplePhotos[dateStr] || [];

      // æ ¹æ“šç¯©é¸å™¨éæ¿¾ç…§ç‰‡
      if (appData.selectedPetFilter.length > 0) {
        photos = photos.filter(photo => {
          if (!photo.petIds || photo.petIds.length === 0) return true;
          return photo.petIds.some(petId => appData.selectedPetFilter.includes(petId));
        });
      }

      detailContent.innerHTML = '';

      photos.forEach((photo, index) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl shadow-sm border border-emerald-50 overflow-hidden mb-5 fade-in';
        card.style.animationDelay = `${index * 0.1}s`;

        // æ ¹æ“šç…§ç‰‡çš„ petIds é¡¯ç¤ºå°æ‡‰é ­åƒ
        let avatarHtml = '';
        let pet = null;

        // å¦‚æœç…§ç‰‡æœ‰é—œè¯å¯µç‰©ï¼Œä½¿ç”¨é—œè¯çš„å¯µç‰©
        if (photo.petIds && photo.petIds.length > 0) {
          pet = appData.pets.find(p => p.petId === photo.petIds[0]);
        }
        // å¦‚æœæ²’æœ‰é—œè¯å¯µç‰©ï¼Œä½†ç”¨æˆ¶æœ‰æ–°å¢å¯µç‰©ï¼Œå‰‡é¡¯ç¤ºç¬¬ä¸€å€‹å¯µç‰©çš„é ­åƒ
        else if (appData.pets.length > 0) {
          pet = appData.pets[0];
        }

        if (pet) {
          if (pet.avatar) {
            avatarHtml = `<img src="${pet.avatar}" class="w-8 h-8 rounded-full object-cover border-2 border-emerald-100 shadow-sm">`;
          } else {
            const petIcon = pet.type === 'dog' ? 'ğŸ¶' : pet.type === 'cat' ? 'ğŸ±' : 'ğŸ¾';
            avatarHtml = `<div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-lg border-2 border-white shadow-sm">${petIcon}</div>`;
          }
        } else {
          avatarHtml = `<div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-lg border-2 border-white shadow-sm">ğŸ¾</div>`;
        }

        card.innerHTML = `
          <img src="${photo.image}" class="w-full aspect-square object-cover">
          <div class="p-4 flex gap-3 items-start">
            <div class="flex-shrink-0">${avatarHtml}</div>
            <div class="flex-1">
              <p class="text-[#0c5832] text-sm font-semibold leading-relaxed">${photo.note}</p>
              <p class="text-[10px] text-gray-400 mt-2 font-bold italic">ğŸ• ${photo.time}</p>
            </div>
          </div>
        `;
        detailContent.appendChild(card);
      });

      const nextDate = getNextDate(dateStr);
      if (nextDate) {
        document.getElementById('next-date-hint').classList.remove('hidden');
        setupAutoScroll(dateStr);
      } else {
        document.getElementById('next-date-hint').classList.add('hidden');
        detailContent.onscroll = null;
      }
    }

    function setupAutoScroll(currentDateStr) {
      detailContent.onscroll = () => {
        if (isTransitioning) return;
        if (detailContent.scrollTop + detailContent.clientHeight >= detailContent.scrollHeight - 10) {
          const nextDate = getNextDate(currentDateStr);
          if (nextDate) {
            isTransitioning = true;
            detailContent.classList.add('page-transition-out');
            setTimeout(() => {
              detailContent.scrollTop = 0;
              detailContent.classList.remove('page-transition-out');
              renderDetailPage(nextDate);
              detailContent.classList.add('page-transition-in');
              setTimeout(() => {
                detailContent.classList.remove('page-transition-in');
                isTransitioning = false;
              }, 500);
            }, 400);
          }
        }
      };
    }

    function getNextDate(dateStr) {
      const dates = Object.keys(samplePhotos).sort();
      const idx = dates.indexOf(dateStr);
      if (idx >= 0 && idx < dates.length - 1) {
        return dates[idx + 1];
      }
      return null;
    }

    // ä¸Šå‚³é‚è¼¯
    document.getElementById('file-input').onchange = (e) => {
      const file = e.target.files[0];
      if(file) {
        document.getElementById('photo-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('image-preview').src = URL.createObjectURL(file);
        document.getElementById('upload-form-container').classList.remove('hidden');
        document.getElementById('save-photo-btn').classList.remove('hidden');
        document.getElementById('upload-success').classList.add('hidden');
        document.getElementById('upload-progress-container').classList.add('hidden');
        appData.selectedPetIds = []; // é‡ç½®é¸æ“‡
        renderPetSelector();
      }
    };

    document.getElementById('save-photo-btn').onclick = () => {
      const container = document.getElementById('upload-progress-container');
      const bar = document.getElementById('upload-progress-bar');
      const text = document.getElementById('upload-pct-text');

      container.classList.remove('hidden');
      document.getElementById('save-photo-btn').classList.add('hidden');

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.floor(Math.random() * 15) + 5;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('upload-success').classList.remove('hidden');
            container.classList.add('hidden');

            // é€™è£¡å¯ä»¥å„²å­˜ç…§ç‰‡åˆ° appData.photos
            // åŒ…å«é¸ä¸­çš„ petIds
            showToast(`å·²æ¨™è¨˜ ${appData.selectedPetIds.length} éš»å¯µç‰©`);
          }, 300);
        }
        bar.style.width = progress + '%';
        text.textContent = progress + '%';
      }, 150);
    };

    document.getElementById('upload-another-btn').onclick = () => {
      document.getElementById('file-input').value = "";
      document.getElementById('image-preview').src = "";
      document.getElementById('photo-note').value = "";
      document.getElementById('upload-form-container').classList.add('hidden');
      document.getElementById('upload-success').classList.add('hidden');
      document.getElementById('save-photo-btn').classList.remove('hidden');
      document.getElementById('upload-progress-container').classList.add('hidden');
      document.getElementById('upload-progress-bar').style.width = '0%';
      document.getElementById('upload-pct-text').textContent = '0%';
      appData.selectedPetIds = [];
    };

    document.getElementById('remove-image-btn').onclick = () => {
      document.getElementById('file-input').value = "";
      document.getElementById('upload-form-container').classList.add('hidden');
      appData.selectedPetIds = [];
    };

    document.getElementById('back-btn').onclick = () => document.getElementById('detail-page').classList.add('hidden');
    document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
    document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };

    // ç™»å‡ºæŒ‰éˆ• - æ·»åŠ ç¢ºèªå°è©±æ¡†
    document.getElementById('logout-btn').onclick = () => {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        location.reload();
      }
    };

    // ========== åˆå§‹åŒ– ==========
    loadAppData();
  </script>
 </body>
</html>
