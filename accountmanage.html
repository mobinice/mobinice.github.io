<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>帳號管理 Demo（SAP 客戶代碼版）</title>
  <style>
    /* 原有 CSS 樣式完全保留，未做變動 */
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --primary:#2563eb;
      --primaryHover:#1d4ed8;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#d97706;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --shadow2: 0 6px 18px rgba(17,24,39,.10);
      --radius:14px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:22px auto 70px;
      padding:0 18px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-start;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .subtitle{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.45;max-width:820px}
    .rightbox{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .lang{
      display:inline-flex;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      overflow:hidden;
      box-shadow:var(--shadow2);
    }
    .lang button{
      border:0;
      padding:8px 12px;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
    }
    .lang button.active{
      background:#eef2ff;
      color:#1e3a8a;
      font-weight:700;
    }

    .btn{
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow2);
    }
    .btn:hover{background:var(--primaryHover)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:var(--card);
      color:var(--text);
      border-color:var(--line);
      box-shadow:var(--shadow2);
    }
    .btn.secondary:hover{border-color:var(--line2); background:#fafafa}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
    .btn.danger{
      background:var(--danger);
    }
    .btn.danger:hover{filter:brightness(.95)}

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .control-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      flex:1;
      min-width:280px;
    }
    .control-right{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .input, select, textarea{
      background:#fff;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .input:focus, select:focus, textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .input{min-width:280px; flex:1}
    select{cursor:pointer}
    textarea{min-height:84px; resize:vertical; width:100%}
    .hint{color:var(--muted); font-size:12px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      overflow:hidden;
      border-radius:var(--radius);
      border:1px solid var(--line);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.25px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
      background:#fff;
    }
    tbody tr:hover td{background:#fbfdff}
    .mono{font-family:var(--mono); font-size:12px}
    .muted{color:var(--muted)}
    .chip{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      background:#f9fafb;
      color:var(--text);
      white-space:nowrap;
      gap:8px;
      font-weight:700;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      white-space:nowrap;
      background:#f9fafb;
    }
    .badge.good{color:var(--success); border-color:#bbf7d0; background:#f0fdf4}
    .badge.bad{color:var(--danger); border-color:#fecaca; background:#fef2f2}
    .row-actions{display:flex; gap:8px; flex-wrap:wrap}

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(860px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#ffffff;
    }
    .modal-title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .modal-title h2{margin:0;font-size:16px}
    .modal-body{
      padding:14px 16px;
      max-height:min(72vh, 720px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .section{
      border:1px solid var(--line);
      background:#ffffff;
      border-radius:14px;
      padding:12px;
    }
    .section h3{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
      text-transform:uppercase;
      font-weight:900;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid .full{grid-column:1 / -1}
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:800;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      font-weight:900;
    }
    .tab.active{
      background:#eef2ff;
      color:#1e3a8a;
      border-color:#c7d2fe;
    }
    .scope-box{display:none; gap:10px; flex-direction:column}
    .scope-box.show{display:flex}
    .pill-list{display:flex; flex-wrap:wrap; gap:8px}
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
      font-weight:800;
    }
    .pill.selected{
      border-color:#86efac;
      background:#f0fdf4;
      color:#166534;
    }
    .preview{
      border:1px dashed #d1d5db;
      background:#f9fafb;
      border-radius:14px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .modal-foot{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fafafa;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(760px, 92vw);
      font-size:13px;
      opacity:.96;
    }
    .toast.show{display:block}

    .scope-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      border-radius:999px;
      font-size:12px;
      color:#1e3a8a;
      font-weight:700;
    }
    .scope-tag button{
      border:0;
      background:transparent;
      cursor:pointer;
      color:#1e3a8a;
      font-size:14px;
      padding:0 2px;
      line-height:1;
    }

    @media (max-width:820px){
      .grid{grid-template-columns:1fr}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody tr{
        margin:10px 0;
        border-top:1px solid var(--line);
      }
      tbody td{
        border-bottom:0;
        border-top:1px solid var(--line);
      }
      tbody td::before{
        content:attr(data-label);
        display:block;
        color:var(--muted);
        font-size:12px;
        margin-bottom:6px;
        font-weight:800;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="pageTitle">帳號管理</h1>
        <div class="subtitle" id="pageSubtitle">
          內部僅管理員可操作：根據 SAP 代碼建立帳號並設定權限。
        </div>
      </div>
      <div class="rightbox">
        <div class="lang" aria-label="language switch">
          <button id="btnZH" class="active" type="button">繁中</button>
          <button id="btnEN" type="button">EN</button>
        </div>
        <button class="btn secondary" id="btnExport" type="button">匯出 CSV</button>
        <button class="btn" id="btnCreate" type="button">+ 新增帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="control-left">
          <!-- 可搜尋下拉輸入框 -->
          <div style="position:relative;flex:1;min-width:240px">
            <input class="input" id="q" style="width:100%;min-width:0"
                   placeholder="輸入關鍵字搜尋..." autocomplete="off" />
            <ul id="qDropdown"
                style="display:none;position:absolute;left:0;right:0;top:calc(100% + 4px);
                       z-index:100;background:#fff;border:1px solid var(--line);
                       border-radius:12px;margin:0;padding:6px;list-style:none;
                       box-shadow:var(--shadow2);max-height:200px;overflow-y:auto;"></ul>
          </div>
          <select id="filterStatus"><option value="all">全部狀態</option></select>
          <select id="filterType"><option value="all">全部類型</option></select>
          <button class="btn small" id="btnSearch" type="button">搜尋</button>
          <span class="hint" id="countHint">—</span>
        </div>
        <div class="control-right">
          <button class="btn secondary small" id="btnClear" type="button">清除條件</button>
        </div>
      </div>

      <table aria-label="accounts table">
        <thead>
          <tr>
            <th id="thStatus">狀態</th>
            <th id="thCustCode">客戶代碼</th>
            <th id="thOrg">公司/單位</th>
            <th id="thType">類型</th>
            <th id="thInfo">附加資訊 (Memo)</th>
            <th id="thScope">BOM 權限</th>
            <th id="thLastLogin">最後登入</th>
            <th id="thCreatedAt">建立時間</th>
            <th id="thActions">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">
          <h2 id="modalTitle">新增帳號</h2>
          <div class="hint" id="modalHint">直接設定客戶代碼與登入密碼。</div>
        </div>
        <button class="btn secondary small" id="btnClose" type="button">✕</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <h3 id="secBasic">基本資料</h3>
          <div class="grid">
            <div class="field">
              <label id="lbCustCode">客戶代碼 *</label>
              <select id="fCustCode" class="input"></select>
              <div class="hint" id="hintCustCode">由 SAP 資料自動帶入</div>
            </div>
            <div class="field">
              <label id="lbPassword">登入密碼 *</label>
              <input id="fPassword" type="password" class="input" placeholder="請設定初始密碼" />
            </div>
            <div class="field">
              <label id="lbOrg">公司/單位 *</label>
              <input id="fOrg" class="input" placeholder="系統自動帶入或手動輸入" />
            </div>
            <div class="field">
              <label id="lbType">類型 *</label>
              <select id="fType">
                <option value="customer">客戶 / Customer</option>
                <option value="vendor">廠商 / Vendor</option>
              </select>
            </div>
            <div class="field">
              <label id="lbEmail">聯絡 Email</label>
              <input id="fEmail" class="input" placeholder="非必填" />
            </div>
            <div class="field">
              <label id="lbContactName">聯絡人</label>
              <input id="fContactName" class="input" placeholder="非必填" />
            </div>
            <div class="field full">
              <label id="lbNotes">備註 (Memo)</label>
              <textarea id="fNotes" placeholder="額外記錄欄位"></textarea>
            </div>
            <div class="field full">
              <label id="lbEnabled">初始狀態</label>
              <select id="fEnabled">
                <option value="enabled">啟用</option>
                <option value="disabled">停用</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <h3 id="secScope">BOM 權限範圍（必填）</h3>
          <div id="scopeSelectedTags" style="display:flex;flex-wrap:wrap;gap:6px;min-height:0;margin-bottom:8px;"></div>
          <div style="position:relative">
            <input id="scopeSearchInput" class="input" style="width:100%;min-width:0" placeholder="輸入關鍵字搜尋 BOM 權限..." autocomplete="off" />
            <ul id="scopeDropdown" style="display:none;position:absolute;left:0;right:0;top:calc(100% + 4px);z-index:100;background:#fff;border:1px solid var(--line);border-radius:12px;margin:0;padding:6px;list-style:none;box-shadow:var(--shadow2);max-height:200px;overflow-y:auto;"></ul>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn secondary" id="btnCancel" type="button">取消</button>
        <button class="btn" id="btnSave" type="button">儲存</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="pwdOverlay" role="dialog" aria-modal="true">
    <div class="modal" style="width:min(400px,100%)">
      <div class="modal-head">
        <div class="modal-title">
          <h2 id="pwdModalTitle">重設密碼</h2>
        </div>
        <button class="btn secondary small" id="btnPwdClose" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>新密碼</label>
          <input id="fNewPwd" type="password" class="input" style="width:100%" placeholder="請輸入新密碼" />
        </div>
        <div class="field">
          <label>確認新密碼</label>
          <input id="fConfirmPwd" type="password" class="input" style="width:100%" placeholder="請再次輸入新密碼" />
        </div>
        <div id="pwdError" style="color:var(--danger);font-size:12px;display:none;margin-top:4px;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="btnPwdCancel" type="button">取消</button>
        <button class="btn" id="btnPwdConfirm" type="button">確認</button>
      </div>
    </div>
  </div>

  <!-- BOM 權限檢視 -->
  <div class="overlay" id="scopeViewOverlay" role="dialog" aria-modal="true">
    <div class="modal" style="max-width:480px">
      <div class="modal-head">
        <div class="modal-title">
          <h2 id="scopeViewTitle">BOM 權限範圍</h2>
          <div class="hint" id="scopeViewSubtitle"></div>
        </div>
        <button class="btn secondary small" id="btnScopeViewClose" type="button">✕</button>
      </div>
      <div class="modal-body">
        <ul id="scopeViewList"
            style="margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px;"></ul>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // 模擬 SAP 客戶資料
    const sapCustomers = [
      { code: "SAP-C001", name: "華東電子" },
      { code: "SAP-C002", name: "北海貿易" },
      { code: "SAP-V009", name: "精工零件" },
      { code: "SAP-V010", name: "宏盛代工" }
    ];

    const I18N = {
      zh: {
        pageTitle: "帳號管理",
        pageSubtitle: "管理員手動建立/維護外部帳號。客戶以「代碼」登入，Email 為選填資訊。",
        exportCSV: "匯出 CSV", create: "+ 新增帳號",
        searchPH: "搜尋 客戶代碼 / 公司", clear: "清除條件", search: "搜尋",
        statusAll: "全部狀態", statusEnabled: "啟用", statusDisabled: "停用",
        typeAll: "全部類型", typeCustomer: "客戶", typeVendor: "廠商",
        thStatus: "狀態", thCustCode: "客戶代碼", thOrg: "公司/單位", thType: "類型",
        thInfo: "附加資訊 (Memo)", thScope: "BOM 權限", thLastLogin: "最後登入",
        thCreatedAt: "建立時間", thActions: "操作",
        enabled: "啟用", disabled: "停用", customer: "客戶", vendor: "廠商", never: "—",
        edit: "編輯", disable: "停用", enable: "啟用", resetPwd: "重設密碼",
        modalCreate: "新增帳號", modalEdit: "編輯帳號", modalHint: "直接設定客戶代碼與登入密碼。",
        secBasic: "基本資料", lbCustCode: "客戶代碼 *", lbPassword: "密碼 *", lbEmail: "聯絡 Email",
        lbOrg: "公司/單位 *", lbType: "類型 *", lbContactName: "聯絡人", secScope: "BOM 權限範圍",
        previewPrefix: "權限概覽：", previewEmpty: "至少需設定一種範圍",
        msgSaved: "帳號已儲存", msgDisabled: "已停用", msgEnabled: "已啟用",
        msgPwdUpdated: "密碼已更新", confirmReset: "請輸入新密碼：",
        save: "保存",
        errRequired: "請填寫必填欄位", errUnique: "此代碼帳號已存在", errScope: "請設定權限範圍",
        viewScope: "查看",
        countHint: (n, total)=>`顯示 ${n} / ${total} 筆`
      },
      en: {
        pageTitle: "Account Management (SAP Code)",
        pageSubtitle: "Admin sets accounts based on SAP codes. Email is optional info.",
        exportCSV: "Export CSV", create: "+ Create",
        searchPH: "Search code / org", clear: "Clear", search: "Search",
        statusAll: "All status", statusEnabled: "Enabled", statusDisabled: "Disabled",
        typeAll: "All types", thStatus: "Status", thCustCode: "Customer Code",
        thInfo: "Info (Memo)", thActions: "Actions", never: "—",
        edit: "Edit", resetPwd: "Reset PWD",
        modalCreate: "New Account", lbCustCode: "Customer Code *", lbPassword: "Password *",
        msgSaved: "Saved", msgPwdUpdated: "Password updated", confirmReset: "Enter new password:",
        save: "Save",
        errRequired: "Required fields missing", errScope: "Scope required",
        viewScope: "View",
        countHint: (n, total)=>`Showing ${n} / ${total}`
      }
    };

    const demoOrgs = [{ id:"CUST-A", nameZH:"客戶 A", nameEN:"Cust A" },{ id:"VEND-X", nameZH:"廠商 X", nameEN:"Vend X" }];
    const demoBoms = [{ id:"BOM-101", nameZH:"BOM-101｜主板", nameEN:"BOM-101 | Board" }];

    let state = {
      lang: "zh",
      editingId: null,
      resetingId: null,
      draftScope: { selected: new Set() },
      accounts: [
        {
          id: crypto.randomUUID(),
          status: "enabled",
          custCode: "SAP-C001",
          password: "••••••",
          email: "buyer-a@huadong.com",
          org: "華東電子",
          type: "customer",
          contactName: "王小明",
          scope: { orgIds:["CUST-A"], bomIds:[], prefix:"", range:"" },
          lastLogin: "2026-02-10 09:21",
          createdAt: "2026-02-01 14:05"
        }
      ]
    };

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    function t(key, ...args){
      const v = I18N[state.lang][key];
      return typeof v === "function" ? v(...args) : v;
    }
    function toast(msg){
      const el = $("#toast"); el.textContent = msg; el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 2400);
    }

    function summarizeScope(scope){
      const count = scope.selected != null
        ? scope.selected.length
        : (scope.orgIds?.length||0) + (scope.bomIds?.length||0) + (scope.prefix?1:0);
      if(!count) return `<span class="muted">${I18N[state.lang].previewEmpty||"—"}</span>`;
      return `<div class="mono" style="font-size:11px">&#x2713; ${count} 項已選</div>`;
    }

    function applyI18n(){
      $("#pageTitle").textContent = t("pageTitle");
      $("#pageSubtitle").textContent = t("pageSubtitle");
      $("#btnExport").textContent = t("exportCSV");
      $("#btnCreate").textContent = t("create");
      $("#q").placeholder = t("searchPH");
      $("#btnSearch").textContent = t("search");
      $("#btnClear").textContent = t("clear");
      $("#filterStatus").innerHTML = `<option value="all">${t("statusAll")}</option><option value="enabled">${t("statusEnabled")}</option><option value="disabled">${t("statusDisabled")}</option>`;
      $("#filterType").innerHTML = `<option value="all">${t("typeAll")}</option><option value="customer">${t("typeCustomer")}</option><option value="vendor">${t("typeVendor")}</option>`;
      ["Status","CustCode","Org","Type","Info","Scope","LastLogin","CreatedAt","Actions"].forEach(id=> { if($("#th"+id)) $("#th"+id).textContent = t("th"+id); });
      $("#lbCustCode").textContent = t("lbCustCode");
      $("#lbPassword").textContent = t("lbPassword");
      $("#lbEmail").textContent = t("lbEmail");
      $("#lbOrg").textContent = t("lbOrg");
      $("#btnSave").textContent = t("save");
    }

    function renderTable(){
      const q = $("#q").value.trim().toLowerCase();
      const status = $("#filterStatus").value;
      const type   = $("#filterType").value;
      const list = state.accounts.filter(a=>{
        if(q && !a.custCode.toLowerCase().includes(q) && !a.org.toLowerCase().includes(q)) return false;
        if(status !== "all" && a.status !== status) return false;
        if(type   !== "all" && a.type   !== type)   return false;
        return true;
      });
      $("#countHint").textContent = t("countHint", list.length, state.accounts.length);

      $("#tbody").innerHTML = list.map(a=>{
        return `
          <tr>
            <td>${a.status==="enabled" ? `<span class="badge good">● ${t("enabled")}</span>` : `<span class="badge bad">● ${t("disabled")}</span>`}</td>
            <td><div class="mono" style="font-weight:800">${a.custCode}</div></td>
            <td>${a.org}</td>
            <td><span class="chip">${a.type==="customer"?t("customer"):t("vendor")}</span></td>
            <td>
               <div style="font-size:11px">Email: ${a.email||'—'}</div>
               <div style="font-size:11px">Contact: ${a.contactName||'—'}</div>
            </td>
            <td>
              <button class="btn secondary small" data-act="scope" data-id="${a.id}">
                ${summarizeScope(a.scope)}
              </button>
            </td>
            <td class="mono">${a.lastLogin}</td>
            <td class="mono">${a.createdAt}</td>
            <td>
              <div class="row-actions">
                <button class="btn secondary small" data-act="edit" data-id="${a.id}">${t("edit")}</button>
                <button class="btn secondary small" data-act="pwd" data-id="${a.id}">${t("resetPwd")}</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      $$('[data-act]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.id; const acc = state.accounts.find(x=>x.id===id);
          if(btn.dataset.act==="edit") openModal("edit", acc);
          if(btn.dataset.act==="scope") openScopeView(acc);
          if(btn.dataset.act==="pwd") {
            state.resetingId = id;
            $("#fNewPwd").value = "";
            $("#fConfirmPwd").value = "";
            $("#pwdError").style.display = "none";
            $("#pwdOverlay").classList.add("show");
          }
        };
      });
    }

    function openScopeView(acc){
      const ids = acc.scope.selected != null
        ? [...acc.scope.selected]
        : [...(acc.scope.orgIds||[]), ...(acc.scope.bomIds||[])];
      $("#scopeViewSubtitle").textContent = `${acc.custCode}｜${acc.org}`;
      const ul = $("#scopeViewList");
      ul.innerHTML = ids.map(id=>{
        const opt = allScopeOptions.find(o=>o.id===id);
        const label = opt ? getScopeLabel(opt) : id;
        return `<li style="padding:8px 12px;background:var(--surface2,#f8f9fa);border-radius:8px;font-size:13px">
          <span style="font-weight:700">${id}</span>
          <span style="color:var(--muted);margin-left:6px">${label}</span>
        </li>`;
      }).join("");
      $("#scopeViewOverlay").classList.add("show");
    }

    function renderQDropdown(query){
      const ul = $("#qDropdown");
      const q = query.trim().toLowerCase();
      const filtered = state.accounts.filter(a=>
        !q || a.custCode.toLowerCase().includes(q) || a.org.toLowerCase().includes(q)
      );
      if(!filtered.length){ ul.style.display="none"; return; }
      ul.innerHTML = filtered.map(a=>
        `<li style="padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;user-select:none"
             data-code="${a.custCode}">
           <span style="font-weight:800">${a.custCode}</span>
           <span style="color:var(--muted);font-size:11px;margin-left:6px">${a.org}</span>
         </li>`
      ).join("");
      ul.querySelectorAll("li").forEach(li=>{
        li.onmouseenter = ()=> li.style.background="#f0f4ff";
        li.onmouseleave = ()=> li.style.background="";
        li.onclick = ()=>{
          $("#q").value = li.dataset.code;
          ul.style.display = "none";
        };
      });
      ul.style.display = "block";
    }

    function openModal(mode, acc=null){
      state.editingId = mode==="edit" ? acc.id : null;
      $("#overlay").classList.add("show");
      $("#fCustCode").innerHTML = sapCustomers.map(c=>`<option value="${c.code}" data-name="${c.name}">${c.code} (${c.name})</option>`).join("");
      
      if(mode==="edit"){
        $("#fCustCode").value = acc.custCode; $("#fCustCode").disabled = true;
        $("#fPassword").value = "********"; $("#fPassword").disabled = true; // 編輯時不改密碼，用重設功能
        $("#fOrg").value = acc.org; $("#fEmail").value = acc.email;
        $("#fContactName").value = acc.contactName;
        const sel = acc.scope.selected
          ? new Set(acc.scope.selected)
          : new Set([...(acc.scope.orgIds||[]), ...(acc.scope.bomIds||[])]);
        state.draftScope = { selected: sel };
        $("#fEnabled").value = acc.status;
        $("#fType").value = acc.type;
      } else {
        $("#fCustCode").disabled = false; $("#fPassword").disabled = false;
        $("#fPassword").value = ""; $("#fOrg").value = ""; $("#fEmail").value = ""; $("#fContactName").value = "";
        state.draftScope = { selected: new Set() };
      }
      renderScopeTags();
      $("#scopeSearchInput").value = "";
      $("#scopeDropdown").style.display = "none";
    }

    function saveDraft(){
      const code = $("#fCustCode").value;
      const pwd = $("#fPassword").value;
      const org = $("#fOrg").value;
      const hasScope = state.draftScope.selected.size > 0;

      if(!code || (!state.editingId && !pwd) || !org) return toast(t("errRequired"));
      if(!hasScope) return toast(t("errScope"));

      if(state.editingId){
        const acc = state.accounts.find(a=>a.id===state.editingId);
        acc.org = org; acc.email = $("#fEmail").value;
        acc.contactName = $("#fContactName").value;
        acc.scope = { selected: [...state.draftScope.selected] };
        acc.status = $("#fEnabled").value;
        acc.type = $("#fType").value;
      } else {
        state.accounts.unshift({
          id: crypto.randomUUID(), status: $("#fEnabled").value, type: $("#fType").value, custCode:code, password:pwd,
          org, email: $("#fEmail").value, contactName: $("#fContactName").value,
          scope: { selected: [...state.draftScope.selected] },
          lastLogin: "—", createdAt: "2026-02-11 23:00"
        });
      }
      $("#overlay").classList.remove("show"); toast(t("msgSaved")); renderTable();
    }

    // BOM 搜尋下拉選單
    const allScopeOptions = [
      ...demoOrgs.map(o=>({ id:o.id, labelZH:o.nameZH, labelEN:o.nameEN })),
      ...demoBoms.map(b=>({ id:b.id, labelZH:b.nameZH, labelEN:b.nameEN }))
    ];
    function getScopeLabel(opt){ return state.lang==="en" ? opt.labelEN : opt.labelZH; }

    function renderScopeTags(){
      const wrap = $("#scopeSelectedTags");
      if(!wrap) return;
      wrap.innerHTML = [...state.draftScope.selected].map(id=>{
        const opt = allScopeOptions.find(o=>o.id===id);
        const label = opt ? getScopeLabel(opt) : id;
        return `<span class="scope-tag" data-id="${id}">${label} <button type="button" aria-label="移除">✕</button></span>`;
      }).join("");
      wrap.querySelectorAll(".scope-tag button").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.closest(".scope-tag").dataset.id;
          state.draftScope.selected.delete(id);
          renderScopeTags();
        };
      });
    }

    function renderScopeDropdown(query){
      const ul = $("#scopeDropdown");
      if(!ul) return;
      const q = query.trim().toLowerCase();
      const filtered = allScopeOptions.filter(o=>{
        if(state.draftScope.selected.has(o.id)) return false;
        const label = getScopeLabel(o).toLowerCase();
        return !q || label.includes(q) || o.id.toLowerCase().includes(q);
      });
      if(!filtered.length){ ul.style.display="none"; return; }
      ul.innerHTML = filtered.map(o=>`<li style="padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;user-select:none" data-id="${o.id}">${getScopeLabel(o)} <span style="color:var(--muted);font-size:11px">${o.id}</span></li>`).join("");
      ul.querySelectorAll("li").forEach(li=>{
        li.onmouseenter = ()=> li.style.background="#f0f4ff";
        li.onmouseleave = ()=> li.style.background="";
        li.onclick = ()=>{
          state.draftScope.selected.add(li.dataset.id);
          renderScopeTags();
          $("#scopeSearchInput").value = "";
          ul.style.display = "none";
        };
      });
      ul.style.display = "block";
    }

    $("#fCustCode").onchange = (e)=> {
      const opt = e.target.options[e.target.selectedIndex];
      if(!state.editingId) $("#fOrg").value = opt.dataset.name;
    };
    $("#btnCreate").onclick = ()=> openModal("create");
    $("#btnClose").onclick = $("#btnCancel").onclick = ()=> $("#overlay").classList.remove("show");
    $("#btnSave").onclick = ()=> saveDraft();
    $("#btnZH").onclick = ()=>{ state.lang="zh"; applyI18n(); renderTable(); };
    $("#btnEN").onclick = ()=>{ state.lang="en"; applyI18n(); renderTable(); };
    // 搜尋框下拉
    $("#q").oninput = (e)=> renderQDropdown(e.target.value);
    $("#q").onfocus = (e)=> renderQDropdown(e.target.value);

    // 搜尋按鈕
    $("#btnSearch").onclick = ()=>{
      $("#qDropdown").style.display = "none";
      renderTable();
    };

    // 清除條件
    $("#btnClear").onclick = ()=>{
      $("#q").value = "";
      $("#filterStatus").value = "all";
      $("#filterType").value = "all";
      $("#qDropdown").style.display = "none";
      renderTable();
    };

    // BOM 搜尋下拉事件
    $("#scopeSearchInput").oninput = (e)=> renderScopeDropdown(e.target.value);
    $("#scopeSearchInput").onfocus = (e)=> renderScopeDropdown(e.target.value);
    document.addEventListener("click", e=>{
      if(!e.target.closest("#scopeSearchInput") && !e.target.closest("#scopeDropdown")){
        const ul = $("#scopeDropdown");
        if(ul) ul.style.display = "none";
      }
      if(!e.target.closest("#q") && !e.target.closest("#qDropdown")){
        const ul = $("#qDropdown");
        if(ul) ul.style.display = "none";
      }
    });

    $("#btnScopeViewClose").onclick = ()=> $("#scopeViewOverlay").classList.remove("show");

    // 重設密碼 modal 事件
    $("#btnPwdClose").onclick = $("#btnPwdCancel").onclick = ()=>{
      $("#pwdOverlay").classList.remove("show");
      state.resetingId = null;
    };
    $("#btnPwdConfirm").onclick = ()=>{
      const p1 = $("#fNewPwd").value;
      const p2 = $("#fConfirmPwd").value;
      const errEl = $("#pwdError");
      if(!p1){ errEl.textContent = "密碼不可為空"; errEl.style.display = "block"; return; }
      if(p1 !== p2){ errEl.textContent = "兩次密碼不一致"; errEl.style.display = "block"; return; }
      const acc = state.accounts.find(x=>x.id===state.resetingId);
      if(acc) acc.password = p1;
      $("#pwdOverlay").classList.remove("show");
      state.resetingId = null;
      toast(t("msgPwdUpdated"));
    };

    applyI18n(); renderTable();
  </script>
</body>
</html>