<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>帳號管理 Demo（白色風格 + 中間彈窗）</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --primary:#2563eb;
      --primaryHover:#1d4ed8;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#d97706;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --shadow2: 0 6px 18px rgba(17,24,39,.10);
      --radius:14px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:22px auto 70px;
      padding:0 18px;
    }

    /* Topbar */
    .topbar{
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-start;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .subtitle{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.45;max-width:820px}
    .rightbox{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .lang{
      display:inline-flex;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      overflow:hidden;
      box-shadow:var(--shadow2);
    }
    .lang button{
      border:0;
      padding:8px 12px;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
    }
    .lang button.active{
      background:#eef2ff;
      color:#1e3a8a;
      font-weight:700;
    }

    /* Buttons */
    .btn{
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow2);
    }
    .btn:hover{background:var(--primaryHover)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:var(--card);
      color:var(--text);
      border-color:var(--line);
      box-shadow:var(--shadow2);
    }
    .btn.secondary:hover{border-color:var(--line2); background:#fafafa}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
    .btn.danger{
      background:var(--danger);
    }
    .btn.danger:hover{filter:brightness(.95)}

    /* Panel */
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    /* Controls */
    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .control-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      flex:1;
      min-width:280px;
    }
    .control-right{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .input, select, textarea{
      background:#fff;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .input:focus, select:focus, textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .input{min-width:280px; flex:1}
    select{cursor:pointer}
    textarea{min-height:84px; resize:vertical; width:100%}
    .hint{color:var(--muted); font-size:12px}

    /* Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      overflow:hidden;
      border-radius:var(--radius);
      border:1px solid var(--line);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.25px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
      background:#fff;
    }
    tbody tr:hover td{background:#fbfdff}
    .mono{font-family:var(--mono); font-size:12px}
    .muted{color:var(--muted)}
    .chip{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      background:#f9fafb;
      color:var(--text);
      white-space:nowrap;
      gap:8px;
      font-weight:700;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      white-space:nowrap;
      background:#f9fafb;
    }
    .badge.good{color:var(--success); border-color:#bbf7d0; background:#f0fdf4}
    .badge.bad{color:var(--danger); border-color:#fecaca; background:#fef2f2}
    .row-actions{display:flex; gap:8px; flex-wrap:wrap}

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(860px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#ffffff;
    }
    .modal-title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .modal-title h2{margin:0;font-size:16px}
    .modal-body{
      padding:14px 16px;
      max-height:min(72vh, 720px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .section{
      border:1px solid var(--line);
      background:#ffffff;
      border-radius:14px;
      padding:12px;
    }
    .section h3{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
      text-transform:uppercase;
      font-weight:900;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid .full{grid-column:1 / -1}
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:800;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      font-weight:900;
    }
    .tab.active{
      background:#eef2ff;
      color:#1e3a8a;
      border-color:#c7d2fe;
    }
    .scope-box{display:none; gap:10px; flex-direction:column}
    .scope-box.show{display:flex}
    .pill-list{display:flex; flex-wrap:wrap; gap:8px}
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
      font-weight:800;
    }
    .pill.selected{
      border-color:#86efac;
      background:#f0fdf4;
      color:#166534;
    }
    .preview{
      border:1px dashed #d1d5db;
      background:#f9fafb;
      border-radius:14px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .modal-foot{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fafafa;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(760px, 92vw);
      font-size:13px;
      opacity:.96;
    }
    .toast.show{display:block}

    @media (max-width:820px){
      .grid{grid-template-columns:1fr}
      .input{min-width:unset;width:100%}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody tr{
        margin:10px 0;
        border-top:1px solid var(--line);
      }
      tbody td{
        border-bottom:0;
        border-top:1px solid var(--line);
      }
      tbody td::before{
        content:attr(data-label);
        display:block;
        color:var(--muted);
        font-size:12px;
        margin-bottom:6px;
        font-weight:800;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="pageTitle">帳號管理</h1>
        <div class="subtitle" id="pageSubtitle">
          內部僅管理員可操作：建立客戶/廠商帳號，並設定其可查詢 BOM 範圍。沒有其他權限角色。
        </div>
      </div>
      <div class="rightbox">
        <div class="lang" aria-label="language switch">
          <button id="btnZH" class="active" type="button">繁中</button>
          <button id="btnEN" type="button">EN</button>
        </div>
        <button class="btn secondary" id="btnExport" type="button">匯出 CSV</button>
        <button class="btn" id="btnCreate" type="button">+ 新增帳號</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="control-left">
          <input class="input" id="q" placeholder="搜尋 Email / 公司 / 聯絡人" />
          <select id="filterStatus">
            <option value="all">全部狀態</option>
            <option value="enabled">啟用</option>
            <option value="disabled">停用</option>
          </select>
          <select id="filterType">
            <option value="all">全部類型</option>
            <option value="customer">客戶</option>
            <option value="vendor">廠商</option>
          </select>
          <span class="hint" id="countHint">—</span>
        </div>
        <div class="control-right">
          <button class="btn secondary small" id="btnClear" type="button">清除條件</button>
        </div>
      </div>

      <table aria-label="accounts table">
        <thead>
          <tr>
            <th id="thStatus">狀態</th>
            <th id="thEmail">帳號 Email</th>
            <th id="thOrg">公司/單位</th>
            <th id="thType">類型</th>
            <th id="thContact">聯絡人</th>
            <th id="thScope">BOM 權限範圍</th>
            <th id="thLastLogin">最後登入</th>
            <th id="thCreatedAt">建立時間</th>
            <th id="thCreatedBy">建立者</th>
            <th id="thActions">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">
          <h2 id="modalTitle">新增帳號</h2>
          <div class="hint" id="modalHint">建立後可用 Email 登入查詢 BOM（僅查詢）。</div>
        </div>
        <button class="btn secondary small" id="btnClose" type="button">✕</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <h3 id="secBasic">基本資料</h3>
          <div class="grid">
            <div class="field full">
              <label id="lbEmail">帳號 Email *</label>
              <input id="fEmail" class="input" placeholder="name@company.com" />
              <div class="hint" id="hintEmail">Email 必須唯一</div>
            </div>
            <div class="field">
              <label id="lbOrg">公司/單位 *</label>
              <input id="fOrg" class="input" placeholder="例如：ABC Trading" />
            </div>
            <div class="field">
              <label id="lbType">類型 *</label>
              <select id="fType">
                <option value="customer">客戶 / Customer</option>
                <option value="vendor">廠商 / Vendor</option>
              </select>
            </div>
            <div class="field">
              <label id="lbContactName">聯絡人</label>
              <input id="fContactName" class="input" placeholder="例如：王小明 / Alex" />
            </div>
            <div class="field">
              <label id="lbPhone">電話</label>
              <input id="fPhone" class="input" placeholder="+886 9xx-xxx-xxx" />
            </div>
            <div class="field full">
              <label id="lbNotes">備註</label>
              <textarea id="fNotes" placeholder="例如：僅能查詢 2026 Q1 專案 BOM"></textarea>
            </div>
            <div class="field full">
              <label id="lbEnabled">初始狀態</label>
              <select id="fEnabled">
                <option value="enabled">啟用</option>
                <option value="disabled">停用</option>
              </select>
              <div class="hint" id="hintEnabled">停用後不可登入</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3 id="secScope">BOM 權限範圍（必填）</h3>
          <div class="tabs" role="tablist">
            <div class="tab active" data-tab="org" id="tabOrg">綁定客戶/廠商</div>
            <div class="tab" data-tab="bom" id="tabBom">指定 BOM 清單</div>
            <div class="tab" data-tab="rules" id="tabRules">料號規則</div>
          </div>

          <div class="scope-box show" id="box-org">
            <div class="hint" id="hintOrgScope">選擇可查詢的客戶/廠商（示意資料）</div>
            <div class="pill-list" id="orgPills"></div>
          </div>

          <div class="scope-box" id="box-bom">
            <div class="hint" id="hintBomScope">選擇可查詢的 BOM（示意資料）</div>
            <div class="pill-list" id="bomPills"></div>
          </div>

          <div class="scope-box" id="box-rules">
            <div class="grid">
              <div class="field">
                <label id="lbPrefix">料號前綴 Prefix</label>
                <input id="fPrefix" class="input" placeholder="例如：ABC" />
              </div>
              <div class="field">
                <label id="lbRange">料號區間 Range</label>
                <input id="fRange" class="input" placeholder="例如：ABC0001~ABC9999" />
              </div>
              <div class="field full">
                <div class="hint" id="hintRules">
                  這是「保留給未來」的模式：當 BOM 無法一一綁定時，用規則快速授權。
                </div>
              </div>
            </div>
          </div>

          <div class="preview" id="scopePreview">—</div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn secondary" id="btnCancel" type="button">取消</button>
        <button class="btn secondary" id="btnSaveInvite" type="button">儲存並寄送邀請信</button>
        <button class="btn" id="btnSave" type="button">儲存</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const I18N = {
      zh: {
        pageTitle: "帳號管理",
        pageSubtitle: "內部僅管理員可操作：建立客戶/廠商帳號，並設定其可查詢 BOM 範圍。沒有其他權限角色。",
        exportCSV: "匯出 CSV",
        create: "+ 新增帳號",
        searchPH: "搜尋 Email / 公司 / 聯絡人",
        clear: "清除條件",
        statusAll: "全部狀態",
        statusEnabled: "啟用",
        statusDisabled: "停用",
        typeAll: "全部類型",
        typeCustomer: "客戶",
        typeVendor: "廠商",
        thStatus: "狀態",
        thEmail: "帳號 Email",
        thOrg: "公司/單位",
        thType: "類型",
        thContact: "聯絡人",
        thScope: "BOM 權限範圍",
        thLastLogin: "最後登入",
        thCreatedAt: "建立時間",
        thCreatedBy: "建立者",
        thActions: "操作",

        enabled: "啟用",
        disabled: "停用",
        customer: "客戶",
        vendor: "廠商",
        never: "—",

        edit: "編輯",
        disable: "停用",
        enable: "啟用",
        resetPwd: "重設密碼",

        modalCreate: "新增帳號",
        modalEdit: "編輯帳號",
        modalHint: "建立後可用 Email 登入查詢 BOM（僅查詢）。",
        secBasic: "基本資料",
        lbEmail: "帳號 Email *",
        hintEmail: "Email 必須唯一",
        lbOrg: "公司/單位 *",
        lbType: "類型 *",
        lbContactName: "聯絡人",
        lbPhone: "電話",
        lbNotes: "備註",
        lbEnabled: "初始狀態",
        hintEnabled: "停用後不可登入",

        secScope: "BOM 權限範圍（必填）",
        tabOrg: "綁定客戶/廠商",
        tabBom: "指定 BOM 清單",
        tabRules: "料號規則",
        hintOrgScope: "選擇可查詢的客戶/廠商（示意資料）",
        hintBomScope: "選擇可查詢的 BOM（示意資料）",
        lbPrefix: "料號前綴 Prefix",
        lbRange: "料號區間 Range",
        hintRules: "這是「保留給未來」的模式：當 BOM 無法一一綁定時，用規則快速授權。",
        previewPrefix: "可查詢：",
        previewEmpty: "尚未設定範圍（至少要選一種）",

        cancel: "取消",
        save: "儲存",
        saveInvite: "儲存並寄送邀請信",

        msgSaved: "已儲存",
        msgSavedInvite: "已儲存並寄送邀請信（Demo）",
        msgDisabled: "帳號已停用",
        msgEnabled: "帳號已啟用",
        msgReset: (email)=>`已發送密碼重設信至 ${email}（Demo）`,
        confirmDisable: "確定要停用此帳號？停用後將無法登入。",
        confirmEnable: "確定要啟用此帳號？",
        confirmReset: (email)=>`是否發送密碼重設信至 ${email}？`,
        errEmail: "請填寫有效 Email",
        errRequired: "請填寫必填欄位",
        errUnique: "此 Email 已存在",
        errScope: "請至少設定一種 BOM 範圍",
        countHint: (n, total)=>`顯示 ${n} / ${total} 筆`
      },
      en: {
        pageTitle: "Account Management",
        pageSubtitle: "Admin only: create customer/vendor accounts and define BOM query scope. No other roles.",
        exportCSV: "Export CSV",
        create: "+ Create Account",
        searchPH: "Search email / organization / contact",
        clear: "Clear",
        statusAll: "All status",
        statusEnabled: "Enabled",
        statusDisabled: "Disabled",
        typeAll: "All types",
        typeCustomer: "Customer",
        typeVendor: "Vendor",
        thStatus: "Status",
        thEmail: "Email",
        thOrg: "Organization",
        thType: "Type",
        thContact: "Contact",
        thScope: "BOM Scope",
        thLastLogin: "Last Login",
        thCreatedAt: "Created At",
        thCreatedBy: "Created By",
        thActions: "Actions",

        enabled: "Enabled",
        disabled: "Disabled",
        customer: "Customer",
        vendor: "Vendor",
        never: "—",

        edit: "Edit",
        disable: "Disable",
        enable: "Enable",
        resetPwd: "Reset Password",

        modalCreate: "Create Account",
        modalEdit: "Edit Account",
        modalHint: "After creation, user can sign in with email to query BOM (read-only).",
        secBasic: "Basic",
        lbEmail: "Email *",
        hintEmail: "Email must be unique",
        lbOrg: "Organization *",
        lbType: "Type *",
        lbContactName: "Contact Name",
        lbPhone: "Phone",
        lbNotes: "Notes",
        lbEnabled: "Initial Status",
        hintEnabled: "Disabled users cannot sign in",

        secScope: "BOM Scope (Required)",
        tabOrg: "Bind Organization",
        tabBom: "Select BOM List",
        tabRules: "Part Rules",
        hintOrgScope: "Choose organizations the user can query (demo data)",
        hintBomScope: "Choose BOMs the user can query (demo data)",
        lbPrefix: "Part Prefix",
        lbRange: "Part Range",
        hintRules: "Future-proof mode: use rules when binding BOMs one-by-one is not feasible.",
        previewPrefix: "Scope:",
        previewEmpty: "Scope is empty (choose at least one)",

        cancel: "Cancel",
        save: "Save",
        saveInvite: "Save & Send Invite",

        msgSaved: "Saved",
        msgSavedInvite: "Saved & invite sent (demo)",
        msgDisabled: "Account disabled",
        msgEnabled: "Account enabled",
        msgReset: (email)=>`Password reset email sent to ${email} (demo)`,
        confirmDisable: "Disable this account? User will not be able to sign in.",
        confirmEnable: "Enable this account?",
        confirmReset: (email)=>`Send password reset email to ${email}?`,
        errEmail: "Please enter a valid email",
        errRequired: "Please fill required fields",
        errUnique: "This email already exists",
        errScope: "Please set at least one scope",
        countHint: (n, total)=>`Showing ${n} / ${total}`
      }
    };

    const demoOrgs = [
      { id:"CUST-A", nameZH:"客戶 A（華東電子）", nameEN:"Customer A (HuaDong)" },
      { id:"CUST-B", nameZH:"客戶 B（北海貿易）", nameEN:"Customer B (BeiHai)" },
      { id:"VEND-X", nameZH:"廠商 X（精工零件）", nameEN:"Vendor X (JingGong)" },
      { id:"VEND-Y", nameZH:"廠商 Y（宏盛代工）", nameEN:"Vendor Y (HongSheng)" }
    ];
    const demoBoms = [
      { id:"BOM-10012", nameZH:"BOM-10012｜主板組件", nameEN:"BOM-10012 | Mainboard" },
      { id:"BOM-20388", nameZH:"BOM-20388｜電源模組", nameEN:"BOM-20388 | Power Module" },
      { id:"BOM-33001", nameZH:"BOM-33001｜外殼件", nameEN:"BOM-33001 | Enclosure" },
      { id:"BOM-44007", nameZH:"BOM-44007｜線束組", nameEN:"BOM-44007 | Wiring Harness" }
    ];

    let state = {
      lang: "zh",
      editingId: null,
      scopeTab: "org",
      draftScope: { orgIds: new Set(), bomIds: new Set(), prefix:"", range:"" },
      accounts: [
        {
          id: crypto.randomUUID(),
          status: "enabled",
          email: "buyer-a@huadong.com",
          org: "華東電子",
          type: "customer",
          contactName: "王小明",
          phone: "+886 912-000-111",
          notes: "僅查詢 2026Q1 專案 BOM",
          scope: { orgIds:["CUST-A"], bomIds:["BOM-10012","BOM-20388"], prefix:"", range:"" },
          lastLogin: "2026-02-10 09:21",
          createdAt: "2026-02-01 14:05",
          createdBy: "Admin"
        },
        {
          id: crypto.randomUUID(),
          status: "disabled",
          email: "vendor-x@jinggong.com",
          org: "精工零件",
          type: "vendor",
          contactName: "Alex Chen",
          phone: "+886 2-2345-6789",
          notes: "",
          scope: { orgIds:["VEND-X"], bomIds:[], prefix:"ABC", range:"" },
          lastLogin: "—",
          createdAt: "2026-01-28 11:40",
          createdBy: "Admin"
        },
        {
          id: crypto.randomUUID(),
          status: "enabled",
          email: "pm@beihai.co",
          org: "北海貿易",
          type: "customer",
          contactName: "Lina",
          phone: "",
          notes: "查詢含外殼件 BOM",
          scope: { orgIds:["CUST-B"], bomIds:["BOM-33001"], prefix:"", range:"ABC0001~ABC0999" },
          lastLogin: "2026-02-09 17:03",
          createdAt: "2026-01-30 09:12",
          createdBy: "Admin"
        }
      ]
    };

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    function t(key, ...args){
      const v = I18N[state.lang][key];
      return typeof v === "function" ? v(...args) : v;
    }
    function toast(msg){
      const el = $("#toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.remove("show"), 2400);
    }

    function formatType(type){ return type==="customer" ? t("customer") : t("vendor"); }
    function badgeStatus(status){
      return status==="enabled"
        ? `<span class="badge good">● ${t("enabled")}</span>`
        : `<span class="badge bad">● ${t("disabled")}</span>`;
    }

    function summarizeScope(scope){
      const orgNames = (scope.orgIds||[]).map(id=>{
        const o = demoOrgs.find(x=>x.id===id);
        if(!o) return id;
        return state.lang==="zh" ? o.nameZH : o.nameEN;
      });
      const bomNames = (scope.bomIds||[]).map(id=>{
        const b = demoBoms.find(x=>x.id===id);
        if(!b) return id;
        return state.lang==="zh" ? b.nameZH : b.nameEN;
      });

      const parts = [];
      if(orgNames.length) parts.push(`${orgNames.length} ${state.lang==="zh" ? "個單位" : "org(s)"}`);
      if(bomNames.length) parts.push(`${bomNames.length} ${state.lang==="zh" ? "筆 BOM" : "BOM(s)"}`);
      if(scope.prefix) parts.push(`${state.lang==="zh" ? "前綴" : "prefix"}: ${scope.prefix}`);
      if(scope.range) parts.push(`${state.lang==="zh" ? "區間" : "range"}: ${scope.range}`);

      const top = [];
      if(orgNames.length) top.push(orgNames.slice(0,2).join(" / ") + (orgNames.length>2 ? " …" : ""));
      if(bomNames.length) top.push(bomNames.slice(0,1).join(" ") + (bomNames.length>1 ? " …" : ""));
      if(scope.prefix) top.push(`Prefix ${scope.prefix}`);
      if(scope.range) top.push(`Range ${scope.range}`);

      const headline = top.length ? top.join(" | ") : t("previewEmpty");
      const meta = parts.length ? parts.join(" · ") : (state.lang==="zh" ? "未設定" : "empty");
      return `<div class="mono">${headline}</div><div class="muted" style="margin-top:4px">${meta}</div>`;
    }

    function applyI18n(){
      $("#pageTitle").textContent = t("pageTitle");
      $("#pageSubtitle").textContent = t("pageSubtitle");
      $("#btnExport").textContent = t("exportCSV");
      $("#btnCreate").textContent = t("create");
      $("#q").placeholder = t("searchPH");
      $("#btnClear").textContent = t("clear");

      $("#filterStatus").innerHTML = `
        <option value="all">${t("statusAll")}</option>
        <option value="enabled">${t("statusEnabled")}</option>
        <option value="disabled">${t("statusDisabled")}</option>
      `;
      $("#filterType").innerHTML = `
        <option value="all">${t("typeAll")}</option>
        <option value="customer">${t("typeCustomer")}</option>
        <option value="vendor">${t("typeVendor")}</option>
      `;

      $("#thStatus").textContent = t("thStatus");
      $("#thEmail").textContent = t("thEmail");
      $("#thOrg").textContent = t("thOrg");
      $("#thType").textContent = t("thType");
      $("#thContact").textContent = t("thContact");
      $("#thScope").textContent = t("thScope");
      $("#thLastLogin").textContent = t("thLastLogin");
      $("#thCreatedAt").textContent = t("thCreatedAt");
      $("#thCreatedBy").textContent = t("thCreatedBy");
      $("#thActions").textContent = t("thActions");

      $("#modalHint").textContent = t("modalHint");
      $("#secBasic").textContent = t("secBasic");
      $("#lbEmail").textContent = t("lbEmail");
      $("#hintEmail").textContent = t("hintEmail");
      $("#lbOrg").textContent = t("lbOrg");
      $("#lbType").textContent = t("lbType");
      $("#lbContactName").textContent = t("lbContactName");
      $("#lbPhone").textContent = t("lbPhone");
      $("#lbNotes").textContent = t("lbNotes");
      $("#lbEnabled").textContent = t("lbEnabled");
      $("#hintEnabled").textContent = t("hintEnabled");

      $("#secScope").textContent = t("secScope");
      $("#tabOrg").textContent = t("tabOrg");
      $("#tabBom").textContent = t("tabBom");
      $("#tabRules").textContent = t("tabRules");
      $("#hintOrgScope").textContent = t("hintOrgScope");
      $("#hintBomScope").textContent = t("hintBomScope");
      $("#lbPrefix").textContent = t("lbPrefix");
      $("#lbRange").textContent = t("lbRange");
      $("#hintRules").textContent = t("hintRules");

      $("#btnCancel").textContent = t("cancel");
      $("#btnSave").textContent = t("save");
      $("#btnSaveInvite").textContent = t("saveInvite");
    }

    function renderPills(){
      $("#orgPills").innerHTML = demoOrgs.map(o=>{
        const name = state.lang==="zh" ? o.nameZH : o.nameEN;
        const selected = state.draftScope.orgIds.has(o.id) ? "selected" : "";
        return `<div class="pill ${selected}" data-kind="org" data-id="${o.id}">${name}</div>`;
      }).join("");

      $("#bomPills").innerHTML = demoBoms.map(b=>{
        const name = state.lang==="zh" ? b.nameZH : b.nameEN;
        const selected = state.draftScope.bomIds.has(b.id) ? "selected" : "";
        return `<div class="pill ${selected}" data-kind="bom" data-id="${b.id}">${name}</div>`;
      }).join("");

      $$(".pill").forEach(p=>{
        p.addEventListener("click", ()=>{
          const kind = p.dataset.kind;
          const id = p.dataset.id;
          if(kind==="org"){
            state.draftScope.orgIds.has(id) ? state.draftScope.orgIds.delete(id) : state.draftScope.orgIds.add(id);
          }else{
            state.draftScope.bomIds.has(id) ? state.draftScope.bomIds.delete(id) : state.draftScope.bomIds.add(id);
          }
          renderPills();
          renderScopePreview();
        });
      });
    }

    function renderScopePreview(){
      const scope = {
        orgIds: Array.from(state.draftScope.orgIds),
        bomIds: Array.from(state.draftScope.bomIds),
        prefix: $("#fPrefix").value.trim(),
        range: $("#fRange").value.trim(),
      };
      const hasAny = scope.orgIds.length || scope.bomIds.length || scope.prefix || scope.range;
      $("#scopePreview").innerHTML = hasAny
        ? `<div class="muted" style="font-weight:900;margin-bottom:6px">${t("previewPrefix")}</div>` + summarizeScope(scope)
        : `<div class="muted">${t("previewEmpty")}</div>`;
    }

    function setScopeTab(tab){
      state.scopeTab = tab;
      $$(".tab").forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
      $("#box-org").classList.toggle("show", tab==="org");
      $("#box-bom").classList.toggle("show", tab==="bom");
      $("#box-rules").classList.toggle("show", tab==="rules");
    }

    function filteredAccounts(){
      const q = $("#q").value.trim().toLowerCase();
      const st = $("#filterStatus").value;
      const tp = $("#filterType").value;

      return state.accounts.filter(a=>{
        if(st!=="all" && a.status!==st) return false;
        if(tp!=="all" && a.type!==tp) return false;
        if(!q) return true;

        const hay = [
          a.email, a.org, a.contactName || "", a.phone || "", a.type,
          a.notes || "",
          (a.scope?.orgIds || []).join(","),
          (a.scope?.bomIds || []).join(","),
          a.scope?.prefix || "",
          a.scope?.range || ""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function renderTable(){
      const list = filteredAccounts();
      $("#countHint").textContent = t("countHint", list.length, state.accounts.length);

      $("#tbody").innerHTML = list.map(a=>{
        const contact = a.contactName
          ? `${a.contactName}${a.phone ? `<div class="muted mono">${a.phone}</div>` : ""}`
          : `<span class="muted">—</span>`;
        const typeChip = `<span class="chip">${formatType(a.type)}</span>`;
        const lastLogin = a.lastLogin && a.lastLogin!=="—" ? `<span class="mono">${a.lastLogin}</span>` : `<span class="muted">${t("never")}</span>`;
        const actions = `
          <div class="row-actions">
            <button class="btn secondary small" data-act="edit" data-id="${a.id}">${t("edit")}</button>
            ${
              a.status==="enabled"
                ? `<button class="btn secondary small" data-act="disable" data-id="${a.id}">${t("disable")}</button>`
                : `<button class="btn secondary small" data-act="enable" data-id="${a.id}">${t("enable")}</button>`
            }
            <button class="btn secondary small" data-act="reset" data-id="${a.id}">${t("resetPwd")}</button>
          </div>
        `;
        return `
          <tr>
            <td data-label="${t("thStatus")}">${badgeStatus(a.status)}</td>
            <td data-label="${t("thEmail")}"><div class="mono">${a.email}</div></td>
            <td data-label="${t("thOrg")}">${a.org}</td>
            <td data-label="${t("thType")}">${typeChip}</td>
            <td data-label="${t("thContact")}">${contact}</td>
            <td data-label="${t("thScope")}">${summarizeScope(a.scope || {})}</td>
            <td data-label="${t("thLastLogin")}">${lastLogin}</td>
            <td data-label="${t("thCreatedAt")}"><span class="mono">${a.createdAt}</span></td>
            <td data-label="${t("thCreatedBy")}"><span class="chip mono">${a.createdBy}</span></td>
            <td data-label="${t("thActions")}">${actions}</td>
          </tr>
        `;
      }).join("");

      $$('[data-act]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          const acc = state.accounts.find(x=>x.id===id);
          if(!acc) return;

          if(act==="edit"){
            openModal("edit", acc);
          }else if(act==="disable"){
            if(confirm(t("confirmDisable"))){
              acc.status = "disabled";
              toast(t("msgDisabled"));
              renderTable();
            }
          }else if(act==="enable"){
            if(confirm(t("confirmEnable"))){
              acc.status = "enabled";
              toast(t("msgEnabled"));
              renderTable();
            }
          }else if(act==="reset"){
            if(confirm(t("confirmReset", acc.email))){
              toast(t("msgReset", acc.email));
            }
          }
        });
      });
    }

    function openModal(mode, acc=null){
      state.editingId = mode==="edit" ? acc.id : null;
      $("#overlay").classList.add("show");
      $("#modalTitle").textContent = mode==="edit" ? t("modalEdit") : t("modalCreate");

      state.draftScope = { orgIds:new Set(), bomIds:new Set(), prefix:"", range:"" };

      if(mode==="edit"){
        $("#fEmail").value = acc.email;
        $("#fOrg").value = acc.org;
        $("#fType").value = acc.type;
        $("#fContactName").value = acc.contactName || "";
        $("#fPhone").value = acc.phone || "";
        $("#fNotes").value = acc.notes || "";
        $("#fEnabled").value = acc.status;

        (acc.scope?.orgIds||[]).forEach(id=>state.draftScope.orgIds.add(id));
        (acc.scope?.bomIds||[]).forEach(id=>state.draftScope.bomIds.add(id));
        $("#fPrefix").value = acc.scope?.prefix || "";
        $("#fRange").value = acc.scope?.range || "";
      }else{
        $("#fEmail").value = "";
        $("#fOrg").value = "";
        $("#fType").value = "customer";
        $("#fContactName").value = "";
        $("#fPhone").value = "";
        $("#fNotes").value = "";
        $("#fEnabled").value = "enabled";
        $("#fPrefix").value = "";
        $("#fRange").value = "";
      }

      setScopeTab("org");
      renderPills();
      renderScopePreview();

      // 一般後台交互：編輯時不讓改 Email（避免主鍵/帳號混亂）
      $("#fEmail").disabled = (mode==="edit");
      $("#fEmail").style.opacity = (mode==="edit" ? ".75" : "1");
    }

    function closeModal(){
      $("#overlay").classList.remove("show");
      state.editingId = null;
    }

    function validateDraft(){
      const email = $("#fEmail").value.trim();
      const org = $("#fOrg").value.trim();
      const type = $("#fType").value;
      const enabled = $("#fEnabled").value;

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if(!emailOk){ toast(t("errEmail")); return null; }
      if(!org || !type || !enabled){ toast(t("errRequired")); return null; }

      if(!state.editingId){
        const exists = state.accounts.some(a=>a.email.toLowerCase()===email.toLowerCase());
        if(exists){ toast(t("errUnique")); return null; }
      }

      const scope = {
        orgIds: Array.from(state.draftScope.orgIds),
        bomIds: Array.from(state.draftScope.bomIds),
        prefix: $("#fPrefix").value.trim(),
        range: $("#fRange").value.trim(),
      };
      const hasScope = scope.orgIds.length || scope.bomIds.length || scope.prefix || scope.range;
      if(!hasScope){ toast(t("errScope")); return null; }

      return {
        email, org, type,
        contactName: $("#fContactName").value.trim(),
        phone: $("#fPhone").value.trim(),
        notes: $("#fNotes").value.trim(),
        status: enabled,
        scope
      };
    }

    function saveDraft(sendInvite=false){
      const data = validateDraft();
      if(!data) return;

      if(state.editingId){
        const acc = state.accounts.find(a=>a.id===state.editingId);
        if(!acc) return;
        acc.org = data.org;
        acc.type = data.type;
        acc.contactName = data.contactName;
        acc.phone = data.phone;
        acc.notes = data.notes;
        acc.status = data.status;
        acc.scope = data.scope;
        toast(sendInvite ? t("msgSavedInvite") : t("msgSaved"));
      }else{
        const now = "2026-02-11 23:00"; // demo
        state.accounts.unshift({
          id: crypto.randomUUID(),
          status: data.status,
          email: data.email,
          org: data.org,
          type: data.type,
          contactName: data.contactName,
          phone: data.phone,
          notes: data.notes,
          scope: data.scope,
          lastLogin: "—",
          createdAt: now,
          createdBy: "Admin"
        });
        toast(sendInvite ? t("msgSavedInvite") : t("msgSaved"));
      }

      closeModal();
      renderTable();
    }

    function exportCSV(){
      const list = filteredAccounts();
      const header = ["status","email","org","type","contactName","phone","scope_orgIds","scope_bomIds","scope_prefix","scope_range","lastLogin","createdAt","createdBy"];
      const rows = list.map(a=>[
        a.status, a.email, a.org, a.type, (a.contactName||""), (a.phone||""),
        (a.scope?.orgIds||[]).join("|"),
        (a.scope?.bomIds||[]).join("|"),
        (a.scope?.prefix||""),
        (a.scope?.range||""),
        (a.lastLogin||""),
        a.createdAt, a.createdBy
      ]);
      const csv = [header, ...rows].map(r=>r.map(cell=>{
        const s = String(cell ?? "");
        return /[,"\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
      }).join(",")).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "accounts.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Events
    $("#btnZH").addEventListener("click", ()=>{
      state.lang="zh";
      $("#btnZH").classList.add("active");
      $("#btnEN").classList.remove("active");
      applyI18n(); renderPills(); renderScopePreview(); renderTable();
    });
    $("#btnEN").addEventListener("click", ()=>{
      state.lang="en";
      $("#btnEN").classList.add("active");
      $("#btnZH").classList.remove("active");
      applyI18n(); renderPills(); renderScopePreview(); renderTable();
    });

    $("#btnCreate").addEventListener("click", ()=>openModal("create"));
    $("#btnClose").addEventListener("click", closeModal);
    $("#btnCancel").addEventListener("click", closeModal);
    $("#overlay").addEventListener("click", (e)=>{ if(e.target.id==="overlay") closeModal(); });

    $("#btnSave").addEventListener("click", ()=>saveDraft(false));
    $("#btnSaveInvite").addEventListener("click", ()=>saveDraft(true));

    $$(".tab").forEach(tab=>tab.addEventListener("click", ()=>setScopeTab(tab.dataset.tab)));
    $("#fPrefix").addEventListener("input", renderScopePreview);
    $("#fRange").addEventListener("input", renderScopePreview);

    ["q","filterStatus","filterType"].forEach(id=>{
      $("#"+id).addEventListener("input", renderTable);
      $("#"+id).addEventListener("change", renderTable);
    });

    $("#btnClear").addEventListener("click", ()=>{
      $("#q").value="";
      $("#filterStatus").value="all";
      $("#filterType").value="all";
      renderTable();
    });
    $("#btnExport").addEventListener("click", exportCSV);

    // Init
    applyI18n();
    renderPills();
    renderScopePreview();
    renderTable();
  </script>
</body>
</html>
