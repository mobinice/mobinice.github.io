<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京永 - 屬性與主檔管理系統</title>
  <style>
    :root {
      --primary: #0b6f8a;
      --primary-dark: #075a70;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
    }

    .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; border-bottom: 2px solid var(--border); padding-bottom: 16px; }
    .nav-tabs { display: flex; gap: 8px; margin-bottom: -18px; }
    .tab {
      padding: 10px 24px;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 8px 8px 0 0;
      font-weight: 700;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .tab.active {
      background: var(--card);
      border: 1px solid var(--border);
      border-bottom-color: var(--card);
      color: var(--primary);
    }

    .controls { display: flex; gap: 16px; align-items: center; background: #fff; padding: 16px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f1f5f9; }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th { text-align: left; padding: 12px; background: #f8fafc; color: var(--text-muted); font-weight: 700; border-bottom: 2px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: #f1f5f9; }

    .badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; }
    .badge-info { background: #e0f2fe; color: #0369a1; }
    .badge-success { background: #dcfce7; color: #15803d; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    .field { margin-bottom: 12px; }
    .field label { display: block; font-size: 12px; font-weight: 800; color: var(--text-muted); margin-bottom: 4px; }
    input, select, textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      outline: none;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(11, 111, 138, 0.1); }
    input:disabled { background: #f8fafc; cursor: not-allowed; color: #64748b; }

    .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.5); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .overlay.show { display: flex; }
    .modal { background: #fff; width: 100%; max-width: 1150px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .mono { font-family: var(--font-mono); }
    .hidden { display: none; }
    
    .row-select { background-color: #f0fdfa; }
    .row-system { background-color: #fffbeb; }

    .btn-move { padding: 4px 8px; font-size: 12px; }
  </style>
</head>
<body>

<div class="app-container">
  <header>
    <div>
      <h1 id="txt-app-title" style="margin:0; font-size: 24px; color: var(--primary);">屬性組維護&全域字典主檔</h1>
      <p id="txt-app-subtitle" style="margin:4px 0 16px; color: var(--text-muted);">維護主檔字典與屬性規則的分層系統</p>
      <div class="nav-tabs">
        <div id="tab-btn-groups" class="tab active" onclick="switchTab('groups')">屬性組規則</div>
        <div id="tab-btn-dict" class="tab" onclick="switchTab('dict')">全域字典主檔</div>
      </div>
    </div>
    
    <div style="display:flex; gap:12px; align-items:center;">
      <div class="field" style="margin:0;">
        <label id="lbl-lang">語言</label>
        <select id="langSelector" onchange="changeLang(this.value)">
          <option value="zh">中文</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="field" style="margin:0;">
        <label id="lbl-sap-view">SAP 模板</label>
        <select id="sapTemplateSelector" onchange="renderGroups()">
          <option value="ALL">全部模板</option>
          <option value="MODEL_A">SAP 模板 A</option>
          <option value="MODEL_B">SAP 模板 B</option>
        </select>
      </div>
    </div>
  </header>

  <section id="tab-groups" class="tab-content">
    <div class="controls">
      <div style="display:flex; gap:8px;">
        <input type="text" id="searchGroup" placeholder="搜尋代碼或定義..." style="width:300px;" oninput="renderGroups()">
        <button id="btn-search" class="btn btn-outline" onclick="renderGroups()">搜尋</button>
      </div>
      <button id="btn-add-group" class="btn btn-primary" onclick="openGroupModal('new')">+ 新增屬性組</button>
    </div>

    <div class="card">
      <table id="groupsTable">
        <thead>
          <tr>
            <th id="th-g-code">代碼</th>
            <th id="th-g-name">定義</th>
            <th id="th-g-pattern">樣式</th>
            <th id="th-g-serial">流水碼</th>
            <th id="th-g-sap">SAP MODEL</th>
            <th id="th-g-status">狀態</th>
            <th id="th-g-action">操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-dict" class="tab-content hidden">
    <div class="grid-2">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 id="txt-dict-list" style="margin:0;">屬性代碼清單</h3>
          <button id="btn-add-dict" class="btn btn-primary btn-small" onclick="addNewDictCode()">+ 新增代碼</button>
        </div>
        <table id="dictCodeTable">
          <thead>
            <tr>
              <th id="th-d-code">代碼</th>
              <th id="th-d-def">定義</th>
              <th id="th-d-ref">引用</th>
              <th id="th-d-action">操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div id="dictValueEditorTitle">
          <h3 id="txt-dict-editor" style="margin:0;">屬性值維護</h3>
          <p id="txt-dict-hint" class="text-muted" style="font-size:12px;">請選擇代碼進行編輯</p>
        </div>
        <div id="dictValueActions" class="hidden" style="margin-top:16px;">
           <div class="grid-2">
             <div class="field">
               <label id="lbl-meta-zh">中文定義</label>
               <input type="text" id="editMetaZh" oninput="updateDictMeta()">
             </div>
             <div class="field">
               <label id="lbl-meta-en">英文定義</label>
               <input type="text" id="editMetaEn" oninput="updateDictMeta()">
             </div>
           </div>
           <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;">
           <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
             <strong id="txt-opt-list">選項清單</strong>
             <button id="btn-add-opt" class="btn btn-outline" onclick="addDictOption()">+ 新增選項</button>
           </div>
           <table id="dictOptionTable">
             <thead>
               <tr>
                 <th id="th-o-val">選項值</th>
                 <th id="th-o-status">狀態</th>
                 <th id="th-o-note">說明</th>
                 <th></th>
               </tr>
             </thead>
             <tbody></tbody>
           </table>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="overlay" id="groupModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle" style="margin:0; font-size:18px;">編輯屬性組</h2>
      <button class="btn btn-outline" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <div>
          <div class="field">
            <label id="lbl-modal-gcode">屬性組代碼</label>
            <input type="text" id="gCode" class="mono">
          </div>
          <div class="field">
            <label id="lbl-modal-glabel">定義</label>
            <input type="text" id="gLabel">
          </div>
        </div>
        <div>
          <div class="field">
            <label id="lbl-modal-gslen">流水碼長度</label>
            <input type="number" id="gSerialLen" min="1" max="10" oninput="syncSerialLen()">
          </div>
          <div class="field">
            <label id="lbl-modal-gstatus">狀態</label>
            <select id="gActive">
              <option value="true">啟用 / Active</option>
              <option value="false">停用 / Inactive</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h4 id="txt-modal-seg" style="margin:0;">組碼段定義 (Segments)</h4>
          <button id="btn-modal-addseg" class="btn btn-outline btn-small" onclick="addSegment()">+ 新增段落</button>
        </div>
        <table id="segmentTable">
          <thead>
            <tr>
              <th style="width:40px;">#</th>
              <th id="th-s-code" style="width:160px;">屬性代碼</th>
              <th id="th-s-def">定義內容</th>
              <th id="th-s-len" style="width:80px;">長度</th>
              <th id="th-s-type" style="width:140px;">型態</th>
              <th id="th-s-status">連動狀態</th>
              <th style="width:150px;">操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:20px; background: #f8fafc; border-style: dashed;">
        <div id="previewArea">
          <strong id="txt-pre-pattern">樣式預覽：</strong> <span class="mono" id="patternPreview">-</span>
          <span style="margin: 0 20px;">|</span>
          <strong id="txt-pre-part">範例料號：</strong> <span class="mono" id="partNoPreview">-</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btn-modal-cancel" class="btn btn-outline" onclick="closeModal()">取消</button>
      <button id="btn-modal-save" class="btn btn-primary" onclick="saveGroup()">儲存</button>
    </div>
  </div>
</div>

<div class="overlay" id="newCodeModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <h2 id="newCodeModalTitle" style="margin:0;font-size:18px;">新增屬性代碼</h2>
      <button class="btn btn-outline" onclick="closeNewCodeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label id="lbl-new-code-input">屬性代碼</label>
        <input type="text" id="newCodeInput" class="mono" placeholder="例：COLOR"
               onkeydown="if(event.key==='Enter') confirmNewCode()">
      </div>
    </div>
    <div class="modal-footer">
      <button id="btn-new-code-cancel" class="btn btn-outline" onclick="closeNewCodeModal()">取消</button>
      <button id="btn-new-code-confirm" class="btn btn-primary" onclick="confirmNewCode()">確認</button>
    </div>
  </div>
</div>

<script>
const i18n = {
  zh: {
    appTitle: "屬性組維護&全域字典主檔", appSubtitle: "維護主檔字典與屬性規則的分層系統",
    tabGroups: "屬性組規則", tabDict: "全域字典主檔",
    lblLang: "語言", lblSapView: "SAP 模板",
    btnAddGroup: "+ 新增屬性組", btnReset: "重置", btnSearch: "搜尋",
    thGCode: "代碼", thGName: "定義", thGPattern: "樣式", thGSerial: "流水碼", thGSap: "SAP 模板", thGStatus: "狀態", thGAction: "操作",
    txtDictList: "屬性代碼清單", btnAddDict: "+ 新增代碼", thDCode: "代碼", thDDef: "定義", thDRef: "引用", thDAction: "操作",
    txtDictEditor: "屬性值維護", txtDictHint: "請選擇代碼進行編輯", lblMetaZh: "中文定義", lblMetaEn: "英文定義",
    txtOptList: "選項清單", btnAddOpt: "+ 新增選項", thOVal: "選項值", thOStatus: "狀態", thONote: "說明",
    modalGCode: "屬性組代碼", modalGLabel: "定義", modalGSLen: "流水碼長度", modalGStatus: "狀態",
    modalSeg: "組碼段定義 (Segments)", modalAddSeg: "+ 新增段落", thSCode: "屬性代碼", thSDef: "定義內容", thSLen: "長度", thSType: "型態", thSStatus: "連動狀態",
    prePattern: "樣式預覽：", prePart: "範例料號：", btnCancel: "取消", btnSave: "儲存",
    badgeActive: "啟用", badgeInactive: "停用", badgeLinked: "已連動", badgeUnbound: "未定義代碼",
    typeSelect: "字典挑選", typeSystem: "系統流水",
    hintSystem: "由系統自動產生流水號",
    btnEdit: "編輯", btnDelete: "刪除",
    msgConfirmDelete: "確定要刪除此屬性組嗎？",
    lblZhLang: "中文", lblEnLang: "English",
    optAllTemplate: "全部模板", optModelA: "SAP 模板 A", optModelB: "SAP 模板 B",
    placeholderSearch: "搜尋代碼或定義...",
    optActive: "啟用 / Active", optInactive: "停用 / Inactive",
    msgRequiredCode: "請輸入屬性組代碼",
    msgConfirmReset: "確定要重置嗎？",
    msgNewCode: "請輸入新代碼",
    msgNewValue: "請輸入新選項值",
    pageTitle: "京永 - 屬性與主檔管理系統",
    modalNewCodeTitle: "新增屬性代碼", lblNewCodeInput: "屬性代碼", placeholderNewCode: "例：COLOR", btnConfirm: "確認"
  },
  en: {
    appTitle: "Part Architecture Management", appSubtitle: "Manage Dictionary & Attribute Rules Layered System",
    tabGroups: "Rules (Groups)", tabDict: "Dictionary (Global)",
    lblLang: "Interface Language", lblSapView: "SAP Template",
    btnAddGroup: "+ New Group", btnReset: "Reset", btnSearch: "Search",
    thGCode: "Code", thGName: "Name", thGPattern: "Pattern", thGSerial: "Serial", thGSap: "SAP View", thGStatus: "Status", thGAction: "Action",
    txtDictList: "Attribute Code List", btnAddDict: "+ New Code", thDCode: "Code", thDDef: "Definition", thDRef: "Refs", thDAction: "Action",
    txtDictEditor: "Value Maintenance", txtDictHint: "Select a code to edit", lblMetaZh: "ZH Definition", lblMetaEn: "EN Definition",
    txtOptList: "Option List", btnAddOpt: "+ New Option", thOVal: "Value", thOStatus: "Status", thONote: "Note",
    modalGCode: "Group Code", modalGLabel: "Label", modalGSLen: "Serial Length", modalGStatus: "Status",
    modalSeg: "Segments Definition", modalAddSeg: "+ Add Segment", thSCode: "Attr Code", thSDef: "Definition Content", thSLen: "Len", thSType: "Type", thSStatus: "Link Status",
    prePattern: "Pattern Preview:", prePart: "Sample Part No:", btnCancel: "Cancel", btnSave: "Save",
    badgeActive: "Active", badgeInactive: "Inactive", badgeLinked: "Linked", badgeUnbound: "Unbound",
    typeSelect: "Select", typeSystem: "System",
    hintSystem: "Auto-generated by system",
    btnEdit: "Edit", btnDelete: "Delete",
    msgConfirmDelete: "Delete this group?",
    lblZhLang: "Chinese", lblEnLang: "English",
    optAllTemplate: "All Templates", optModelA: "SAP Template A", optModelB: "SAP Template B",
    placeholderSearch: "Search code or definition...",
    optActive: "Active", optInactive: "Inactive",
    msgRequiredCode: "Required Code",
    msgConfirmReset: "Are you sure to reset?",
    msgNewCode: "New Code:",
    msgNewValue: "New Value:",
    pageTitle: "Jing Yong - Attribute Master",
    modalNewCodeTitle: "Add Attribute Code", lblNewCodeInput: "Attribute Code", placeholderNewCode: "e.g. COLOR", btnConfirm: "Confirm"
  }
};

let state = {
  lang: 'zh',
  dict: {
    "IDENT": { meta: {zh:"識別碼", en:"Identifier"}, options: {"5":{active:true, desc:"手機"}, "6":{active:true, desc:"平板"}} },
    "PART": { meta: {zh:"零件類型", en:"Part Type"}, options: {"AA":{active:true, desc:"電阻"}, "BB":{active:true, desc:"電容"}} }
  },
  groups: {
    "GRP-A": {
      code: "GRP-A", label: "標準電子料", serialLen: 5, active: true,
      segments: [
        {code: "IDENT", meaning: "識別碼", len: 1, type: "select"},
        {code: "PART", meaning: "零件類型", len: 2, type: "select"},
        {code: "SERIAL", meaning: "系統流水", len: 5, type: "system"}
      ]
    }
  }
};

let currentTab = 'groups', currentEditDict = null, currentEditingGroup = null;

function init() {
  const saved = localStorage.getItem('JY_ATTR_V3_FINAL');
  if (saved) state = JSON.parse(saved);
  applyLang();
  renderAll();
}

function changeLang(val) {
  state.lang = val;
  applyLang();
  renderAll();
}

function applyLang() {
  const L = i18n[state.lang];
  document.getElementById('txt-app-title').textContent = L.appTitle;
  document.getElementById('txt-app-subtitle').textContent = L.appSubtitle;
  document.getElementById('tab-btn-groups').textContent = L.tabGroups;
  document.getElementById('tab-btn-dict').textContent = L.tabDict;
  document.getElementById('lbl-lang').textContent = L.lblLang;
  document.getElementById('lbl-sap-view').textContent = L.lblSapView;
  document.getElementById('btn-add-group').textContent = L.btnAddGroup;
  document.getElementById('btn-search').textContent = L.btnSearch;
  
  document.getElementById('th-g-code').textContent = L.thGCode;
  document.getElementById('th-g-name').textContent = L.thGName;
  document.getElementById('th-g-pattern').textContent = L.thGPattern;
  document.getElementById('th-g-serial').textContent = L.thGSerial;
  document.getElementById('th-g-sap').textContent = L.thGSap;
  document.getElementById('th-g-status').textContent = L.thGStatus;
  document.getElementById('th-g-action').textContent = L.thGAction;
  
  document.getElementById('txt-dict-list').textContent = L.txtDictList;
  document.getElementById('btn-add-dict').textContent = L.btnAddDict;
  document.getElementById('th-d-code').textContent = L.thDCode;
  document.getElementById('th-d-def').textContent = L.thDDef;
  document.getElementById('th-d-ref').textContent = L.thDRef;
  document.getElementById('th-d-action').textContent = L.thDAction;
  
  document.getElementById('lbl-meta-zh').textContent = L.lblMetaZh;
  document.getElementById('lbl-meta-en').textContent = L.lblMetaEn;
  document.getElementById('txt-opt-list').textContent = L.txtOptList;
  document.getElementById('btn-add-opt').textContent = L.btnAddOpt;
  document.getElementById('th-o-val').textContent = L.thOVal;
  document.getElementById('th-o-status').textContent = L.thOStatus;
  document.getElementById('th-o-note').textContent = L.thONote;

  document.getElementById('lbl-modal-gcode').textContent = L.modalGCode;
  document.getElementById('lbl-modal-glabel').textContent = L.modalGLabel;
  document.getElementById('lbl-modal-gslen').textContent = L.modalGSLen;
  document.getElementById('lbl-modal-gstatus').textContent = L.modalGStatus;
  document.getElementById('txt-modal-seg').textContent = L.modalSeg;
  document.getElementById('btn-modal-addseg').textContent = L.modalAddSeg;
  document.getElementById('th-s-code').textContent = L.thSCode;
  document.getElementById('th-s-def').textContent = L.thSDef;
  document.getElementById('th-s-len').textContent = L.thSLen;
  document.getElementById('th-s-type').textContent = L.thSType;
  document.getElementById('th-s-status').textContent = L.thSStatus;
  document.getElementById('txt-pre-pattern').textContent = L.prePattern;
  document.getElementById('txt-pre-part').textContent = L.prePart;
  document.getElementById('btn-modal-cancel').textContent = L.btnCancel;
  document.getElementById('btn-modal-save').textContent = L.btnSave;

  // Language selector options
  document.querySelector('#langSelector option[value="zh"]').textContent = L.lblZhLang;
  document.querySelector('#langSelector option[value="en"]').textContent = L.lblEnLang;

  // SAP template selector options
  document.querySelector('#sapTemplateSelector option[value="ALL"]').textContent = L.optAllTemplate;
  document.querySelector('#sapTemplateSelector option[value="MODEL_A"]').textContent = L.optModelA;
  document.querySelector('#sapTemplateSelector option[value="MODEL_B"]').textContent = L.optModelB;

  // Search placeholder
  document.getElementById('searchGroup').placeholder = L.placeholderSearch;

  // Page title
  document.title = L.pageTitle;

  // Modal status options
  document.querySelector('#gActive option[value="true"]').textContent = L.optActive;
  document.querySelector('#gActive option[value="false"]').textContent = L.optInactive;
  document.getElementById('newCodeModalTitle').textContent = L.modalNewCodeTitle;
  document.getElementById('lbl-new-code-input').textContent = L.lblNewCodeInput;
  document.getElementById('newCodeInput').placeholder = L.placeholderNewCode;
  document.getElementById('btn-new-code-cancel').textContent = L.btnCancel;
  document.getElementById('btn-new-code-confirm').textContent = L.btnConfirm;
}

function renderAll() {
  renderGroups();
  renderDictCodes();
  localStorage.setItem('JY_ATTR_V3_FINAL', JSON.stringify(state));
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const target = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
  if(target) target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');
}

function renderGroups() {
  const L = i18n[state.lang];
  const sapMap = { ALL:'optAllTemplate', MODEL_A:'optModelA', MODEL_B:'optModelB' };
  const sapLabel = L[sapMap[document.getElementById('sapTemplateSelector').value]] || document.getElementById('sapTemplateSelector').value;
  const tbody = document.querySelector('#groupsTable tbody');
  const q = document.getElementById('searchGroup').value.toLowerCase();
  tbody.innerHTML = '';
  Object.values(state.groups).forEach(g => {
    if (g.code.toLowerCase().includes(q) || g.label.toLowerCase().includes(q)) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="mono"><strong>${g.code}</strong></td>
        <td>${g.label}</td>
        <td class="mono">${g.segments.map(s=>s.len).join('-')}</td>
        <td>${g.serialLen}</td>
        <td><span class="badge badge-info">${sapLabel}</span></td>
        <td><span class="badge ${g.active?'badge-success':''}">${g.active?L.badgeActive:L.badgeInactive}</span></td>
        <td>
          <button class="btn btn-outline btn-small" onclick="openGroupModal('edit','${g.code}')">${L.btnEdit}</button>
          <button class="btn btn-danger btn-small" onclick="deleteGroup('${g.code}')">${L.btnDelete}</button>
        </td>
      `;
      tbody.appendChild(row);
    }
  });
}

function renderDictCodes() {
  const tbody = document.querySelector('#dictCodeTable tbody');
  tbody.innerHTML = '';
  Object.keys(state.dict).forEach(code => {
    const d = state.dict[code];
    const refCount = Object.values(state.groups).filter(g=>g.segments.some(s=>s.code===code)).length;
    const row = document.createElement('tr');
    row.onclick = () => selectDictCode(code);
    if(currentEditDict === code) row.style.background = '#f1f5f9';
    row.innerHTML = `
      <td class="mono"><strong>${code}</strong></td>
      <td>${state.lang==='zh'?d.meta.zh:d.meta.en}</td>
      <td><span class="badge badge-info">${refCount}</span></td>
      <td><button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteDictCode('${code}')">✕</button></td>
    `;
    tbody.appendChild(row);
  });
}

function selectDictCode(code) {
  currentEditDict = code;
  document.getElementById('dictValueActions').classList.remove('hidden');
  document.getElementById('dictValueEditorTitle').innerHTML = `<h3>${code}</h3>`;
  document.getElementById('editMetaZh').value = state.dict[code].meta.zh;
  document.getElementById('editMetaEn').value = state.dict[code].meta.en;
  renderDictOptions();
  renderDictCodes();
}

function renderDictOptions() {
  const tbody = document.querySelector('#dictOptionTable tbody');
  tbody.innerHTML = '';
  const opts = state.dict[currentEditDict].options;
  Object.keys(opts).forEach(val => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${val}</td>
      <td><input type="checkbox" ${opts[val].active?'checked':''}></td>
      <td><input type="text" value="${opts[val].desc||''}" style="width:100%"></td>
      <td><button class="btn btn-danger btn-small">✕</button></td>
    `;
    tr.querySelector('input[type="checkbox"]').onchange = (e) => { opts[val].active = e.target.checked; renderAll(); };
    tr.querySelector('input[type="text"]').oninput = (e) => { opts[val].desc = e.target.value; localStorage.setItem('JY_ATTR_V3_FINAL', JSON.stringify(state)); };
    tr.querySelector('.btn-danger').onclick = () => { delete state.dict[currentEditDict].options[val]; renderDictOptions(); renderAll(); };
    tbody.appendChild(tr);
  });
}

function updateDictMeta() {
  if(!currentEditDict) return;
  state.dict[currentEditDict].meta.zh = document.getElementById('editMetaZh').value;
  state.dict[currentEditDict].meta.en = document.getElementById('editMetaEn').value;
  renderDictCodes();
}

function openGroupModal(mode, code = null) {
  currentEditingGroup = mode === 'edit' ? JSON.parse(JSON.stringify(state.groups[code])) : { code:"", label:"", serialLen:5, active:true, segments:[] };
  document.getElementById('gCode').value = currentEditingGroup.code;
  document.getElementById('gLabel').value = currentEditingGroup.label;
  document.getElementById('gSerialLen').value = currentEditingGroup.serialLen;
  document.getElementById('gActive').value = String(currentEditingGroup.active);
  renderSegments();
  document.getElementById('groupModal').classList.add('show');
}

function syncSerialLen() {
  const newLen = parseInt(document.getElementById('gSerialLen').value) || 0;
  currentEditingGroup.segments.forEach(s => {
    if(s.type === 'system' && s.code === 'SERIAL') s.len = newLen;
  });
  renderSegments();
}

function renderSegments() {
  const L = i18n[state.lang];
  const tbody = document.querySelector('#segmentTable tbody');
  tbody.innerHTML = '';
  
  currentEditingGroup.segments.forEach((s, idx) => {
    const tr = document.createElement('tr');
    tr.className = `row-${s.type}`;
    
    const isLinked = !!state.dict[s.code];
    const dictMeta = isLinked ? state.dict[s.code].meta[state.lang] : '';
    const optCount = isLinked ? Object.keys(state.dict[s.code].options).length : 0;
    
    let contentHtml = '';
    if(s.type === 'select') {
      contentHtml = `<input type="text" value="${dictMeta}" disabled style="font-weight:600;">`;
    } else {
      contentHtml = `<span style="color:var(--warning); font-size:12px;">⚙️ ${L.hintSystem}</span>`;
    }

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>
        <input list="dl" value="${s.code}" oninput="updateSeg(${idx}, 'code', this.value)" class="mono" ${s.type==='system'?'disabled':''}>
        <datalist id="dl">${Object.keys(state.dict).map(c=>`<option value="${c}">`).join('')}</datalist>
      </td>
      <td>${contentHtml}</td>
      <td><input type="number" value="${s.len}" oninput="updateSeg(${idx}, 'len', this.value)" ${s.type==='system'?'disabled':''}></td>
      <td>
        <select onchange="updateSeg(${idx}, 'type', this.value)">
          <option value="select" ${s.type==='select'?'selected':''}>${L.typeSelect}</option>
          <option value="system" ${s.type==='system'?'selected':''}>${L.typeSystem}</option>
        </select>
      </td>
      <td>
        ${s.type==='select' ? (isLinked ? `<span class="badge badge-success">${L.badgeLinked} (${optCount})</span>` : `<span class="badge" style="background:#fee2e2;color:#ef4444">${L.badgeUnbound}</span>`) : '-'}
      </td>
      <td>
        <button class="btn btn-outline btn-move" onclick="moveSeg(${idx}, -1)" ${idx===0?'disabled':''}>↑</button>
        <button class="btn btn-outline btn-move" onclick="moveSeg(${idx}, 1)" ${idx===currentEditingGroup.segments.length-1?'disabled':''}>↓</button>
        <button class="btn btn-danger btn-small" onclick="removeSeg(${idx})">✕</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  updatePreview();
}

function updateSeg(idx, key, val) {
  const s = currentEditingGroup.segments[idx];
  if(key === 'type') {
    const oldType = s.type;
    s.type = val;
    if(val === 'system') { 
      s.code = 'SERIAL'; 
      s.len = parseInt(document.getElementById('gSerialLen').value) || 5;
      s.meaning = i18n[state.lang].typeSystem;
    } else if (val === 'select' && oldType === 'system') {
      // 修正點：當從系統流水切換回字典取用時，重置代碼與描述
      s.code = ''; 
      s.meaning = '';
    }
  } else {
    s[key] = (key === 'len') ? parseInt(val) || 0 : val;
    if(key === 'code' && s.type === 'select') {
        const d = state.dict[val.toUpperCase()];
        if(d) s.meaning = d.meta[state.lang];
        else s.meaning = ''; // 若代碼不正確，清空描述
    }
  }
  renderSegments();
}

function moveSeg(idx, dir) {
    const arr = currentEditingGroup.segments;
    const target = idx + dir;
    if(target < 0 || target >= arr.length) return;
    [arr[idx], arr[target]] = [arr[target], arr[idx]];
    renderSegments();
}

function addSegment() { currentEditingGroup.segments.push({code:"", meaning:"", len:1, type:"select"}); renderSegments(); }
function removeSeg(idx) { currentEditingGroup.segments.splice(idx, 1); renderSegments(); }

function updatePreview() {
  const g = currentEditingGroup;
  document.getElementById('patternPreview').textContent = g.segments.map(s=>s.len).join('-') || '-';
  let p = '';
  g.segments.forEach(s => {
    if(s.type === 'system') p += '0'.repeat(s.len);
    else if(s.code && state.dict[s.code]) p += (Object.keys(state.dict[s.code].options)[0] || 'X').padEnd(s.len, '?').slice(0, s.len);
    else p += '?'.repeat(s.len);
  });
  document.getElementById('partNoPreview').textContent = p || '-';
}

function saveGroup() {
  const g = currentEditingGroup;
  g.code = document.getElementById('gCode').value.trim();
  g.label = document.getElementById('gLabel').value.trim();
  g.serialLen = parseInt(document.getElementById('gSerialLen').value);
  g.active = document.getElementById('gActive').value === 'true';
  if(!g.code) return alert(i18n[state.lang].msgRequiredCode);
  state.groups[g.code] = g;
  renderAll();
  closeModal();
}

function closeModal() { document.getElementById('groupModal').classList.remove('show'); }
function deleteGroup(code) {
  if(!confirm(i18n[state.lang].msgConfirmDelete)) return;
  delete state.groups[code];
  renderAll();
}
function addNewDictCode() {
  document.getElementById('newCodeInput').value = '';
  document.getElementById('newCodeModal').classList.add('show');
  setTimeout(() => document.getElementById('newCodeInput').focus(), 50);
}
function closeNewCodeModal() {
  document.getElementById('newCodeModal').classList.remove('show');
}
function confirmNewCode() {
  const c = document.getElementById('newCodeInput').value.trim();
  if(!c) return;
  state.dict[c.toUpperCase()] = { meta:{zh:"",en:""}, options:{} };
  closeNewCodeModal();
  renderAll();
}
function addDictOption() { const v = prompt(i18n[state.lang].msgNewValue); if(v) { state.dict[currentEditDict].options[v]={active:true,desc:""}; renderDictOptions(); } }
function resetDemo() { if(confirm(i18n[state.lang].msgConfirmReset)) { localStorage.clear(); location.reload(); } }

init();
</script>
</body>
</html>