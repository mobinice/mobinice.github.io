<!doctype html>
<html lang="zh-TW" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ–ç‰‡æ—¥è¨˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }
    
    .phone-frame {
      width: 390px;
      height: 844px;
      max-width: 100%;
      max-height: 100%;
    }
    
    .tab-active {
      color: #6366f1;
      border-bottom: 3px solid #6366f1;
    }
    
    .calendar-day {
      transition: all 0.2s ease;
    }
    
    .calendar-day:hover {
      background: #eef2ff;
    }
    
    .calendar-day.has-entry {
      background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
      color: #3730a3;
      font-weight: 600;
    }
    
    .calendar-day.selected {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .upload-zone {
      border: 2px dashed #c7d2fe;
      background: linear-gradient(135deg, #faf5ff 0%, #eef2ff 100%);
      transition: all 0.3s ease;
    }
    
    .upload-zone:hover {
      border-color: #6366f1;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    }
    
    .image-preview {
      aspect-ratio: 1;
      object-fit: cover;
    }
    
    .entry-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
    }
    
    .scrollable {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .scrollable::-webkit-scrollbar {
      width: 4px;
    }
    
    .scrollable::-webkit-scrollbar-thumb {
      background: #c7d2fe;
      border-radius: 4px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-100 flex items-center justify-center p-2">
  <div class="phone-frame bg-white rounded-[40px] shadow-2xl overflow-hidden flex flex-col relative"><!-- Status Bar -->
   <div class="h-12 bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center px-6"><span id="app-title" class="text-white font-medium text-lg">ğŸ“¸ åœ–ç‰‡æ—¥è¨˜</span>
   </div><!-- Main Content -->
   <main class="flex-1 overflow-hidden flex flex-col bg-gradient-to-b from-indigo-50 to-white"><!-- Upload Tab Content -->
    <div id="upload-tab" class="flex-1 flex flex-col p-4 scrollable">
     <div class="mb-4">
      <h2 class="text-xl font-bold text-gray-800 mb-1">æ–°å¢è¨˜éŒ„</h2>
      <p class="text-sm text-gray-500">ä¸Šå‚³åœ–ç‰‡ä¸¦å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…</p>
     </div><!-- Date Picker -->
     <div class="mb-4"><label for="entry-date" class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… é¸æ“‡æ—¥æœŸ</label> <input type="date" id="entry-date" class="w-full px-4 py-3 rounded-xl border border-indigo-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
     </div><!-- Upload Zone -->
     <div id="upload-zone" class="upload-zone rounded-2xl p-6 text-center cursor-pointer mb-4"><input type="file" id="file-input" accept="image/*" class="hidden">
      <div id="upload-placeholder" class="flex flex-col items-center">
       <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-3">
        <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
       </div>
       <p class="text-indigo-600 font-medium">é»æ“Šä¸Šå‚³åœ–ç‰‡</p>
       <p class="text-gray-400 text-sm mt-1">æ”¯æ´ JPG, PNG æ ¼å¼</p>
      </div>
      <div id="preview-container" class="hidden"><img id="image-preview" class="w-full h-48 object-cover rounded-xl mb-2" alt="é è¦½åœ–ç‰‡"> <button id="remove-image" class="text-red-500 text-sm hover:text-red-700">âœ• ç§»é™¤åœ–ç‰‡</button>
      </div>
     </div><!-- Text Input -->
     <div class="mb-4"><label for="entry-text" class="block text-sm font-medium text-gray-700 mb-2">âœï¸ å¯«ä¸‹æƒ³æ³•</label> <textarea id="entry-text" rows="3" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹..." class="w-full px-4 py-3 rounded-xl border border-indigo-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition resize-none"></textarea>
     </div><!-- Submit Button --> <button id="submit-btn" class="w-full py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"> <span id="submit-text">å„²å­˜è¨˜éŒ„</span> <span id="submit-loading" class="hidden">å„²å­˜ä¸­...</span> </button> <!-- Success Message -->
     <div id="success-message" class="hidden mt-4 p-4 bg-green-100 text-green-700 rounded-xl text-center fade-in">
      âœ… è¨˜éŒ„å·²å„²å­˜æˆåŠŸï¼
     </div><!-- Limit Warning -->
     <div id="limit-warning" class="hidden mt-4 p-4 bg-amber-100 text-amber-700 rounded-xl text-center">
      âš ï¸ å·²é”åˆ°æœ€å¤§è¨˜éŒ„æ•¸é‡ (999)ï¼Œè«‹åˆªé™¤ä¸€äº›è¨˜éŒ„å¾Œå†è©¦
     </div>
    </div><!-- Calendar Tab Content -->
    <div id="calendar-tab" class="flex-1 flex flex-col p-4 scrollable hidden"><!-- Calendar Header -->
     <div class="flex items-center justify-between mb-4"><button id="prev-month" class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center hover:bg-indigo-200 transition">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
       </svg></button>
      <h2 id="current-month" class="text-xl font-bold text-gray-800"></h2><button id="next-month" class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center hover:bg-indigo-200 transition">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
       </svg></button>
     </div><!-- Weekday Headers -->
     <div class="grid grid-cols-7 gap-1 mb-2">
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       æ—¥
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       ä¸€
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       äºŒ
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       ä¸‰
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       å››
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       äº”
      </div>
      <div class="text-center text-sm font-medium text-gray-500 py-2">
       å…­
      </div>
     </div><!-- Calendar Grid -->
     <div id="calendar-grid" class="grid grid-cols-7 gap-1 mb-4"></div><!-- Selected Date Entries -->
     <div id="entries-section" class="hidden fade-in">
      <div class="flex items-center justify-between mb-3">
       <h3 id="selected-date-title" class="font-bold text-gray-800"></h3><button id="close-entries" class="text-gray-400 hover:text-gray-600">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg></button>
      </div>
      <div id="entries-list" class="space-y-3"></div>
      <div id="no-entries" class="hidden text-center py-8 text-gray-400">
       <div class="text-4xl mb-2">
        ğŸ“­
       </div>
       <p>é€™å¤©é‚„æ²’æœ‰è¨˜éŒ„</p>
      </div>
     </div>
    </div>
   </main><!-- Bottom Navigation -->
   <nav class="h-20 bg-white border-t border-gray-100 flex"><button id="nav-upload" class="flex-1 flex flex-col items-center justify-center tab-active transition">
     <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
     </svg><span class="text-xs font-medium">ä¸Šå‚³</span> </button> <button id="nav-calendar" class="flex-1 flex flex-col items-center justify-center text-gray-400 transition">
     <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
     </svg><span class="text-xs font-medium">æ—¥æ›†</span> </button>
   </nav>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      app_title: 'ğŸ“¸ åœ–ç‰‡æ—¥è¨˜',
      background_color: '#eef2ff',
      primary_color: '#6366f1',
      text_color: '#1f2937',
      surface_color: '#ffffff',
      accent_color: '#8b5cf6'
    };

    // State
    let entries = [];
    let currentDate = new Date();
    let selectedDate = null;
    let currentImageData = null;
    let recordCount = 0;

    // DOM Elements
    const appTitle = document.getElementById('app-title');
    const uploadTab = document.getElementById('upload-tab');
    const calendarTab = document.getElementById('calendar-tab');
    const navUpload = document.getElementById('nav-upload');
    const navCalendar = document.getElementById('nav-calendar');
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const previewContainer = document.getElementById('preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image');
    const entryDate = document.getElementById('entry-date');
    const entryText = document.getElementById('entry-text');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    const successMessage = document.getElementById('success-message');
    const limitWarning = document.getElementById('limit-warning');
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthEl = document.getElementById('current-month');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const entriesSection = document.getElementById('entries-section');
    const entriesList = document.getElementById('entries-list');
    const noEntries = document.getElementById('no-entries');
    const selectedDateTitle = document.getElementById('selected-date-title');
    const closeEntriesBtn = document.getElementById('close-entries');

    // Set today's date as default
    const today = new Date();
    entryDate.value = today.toISOString().split('T')[0];

    // Tab Navigation
    navUpload.addEventListener('click', () => {
      uploadTab.classList.remove('hidden');
      calendarTab.classList.add('hidden');
      navUpload.classList.add('tab-active');
      navUpload.classList.remove('text-gray-400');
      navCalendar.classList.remove('tab-active');
      navCalendar.classList.add('text-gray-400');
    });

    navCalendar.addEventListener('click', () => {
      uploadTab.classList.add('hidden');
      calendarTab.classList.remove('hidden');
      navCalendar.classList.add('tab-active');
      navCalendar.classList.remove('text-gray-400');
      navUpload.classList.remove('tab-active');
      navUpload.classList.add('text-gray-400');
      renderCalendar();
    });

    // File Upload
    uploadZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          currentImageData = event.target.result;
          imagePreview.src = currentImageData;
          uploadPlaceholder.classList.add('hidden');
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    removeImageBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      currentImageData = null;
      fileInput.value = '';
      uploadPlaceholder.classList.remove('hidden');
      previewContainer.classList.add('hidden');
    });

    // Submit Entry
    submitBtn.addEventListener('click', async () => {
      if (!currentImageData || !entryDate.value) {
        return;
      }

      if (recordCount >= 999) {
        limitWarning.classList.remove('hidden');
        return;
      }

      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      const newEntry = {
        id: Date.now().toString(),
        date: entryDate.value,
        image_data: currentImageData,
        text: entryText.value || '',
        created_at: new Date().toISOString()
      };

      if (window.dataSdk) {
        const result = await window.dataSdk.create(newEntry);
        if (result.isOk) {
          showSuccess();
          resetForm();
        }
      }

      submitBtn.disabled = false;
      submitText.classList.remove('hidden');
      submitLoading.classList.add('hidden');
    });

    function showSuccess() {
      successMessage.classList.remove('hidden');
      setTimeout(() => {
        successMessage.classList.add('hidden');
      }, 3000);
    }

    function resetForm() {
      currentImageData = null;
      fileInput.value = '';
      entryText.value = '';
      uploadPlaceholder.classList.remove('hidden');
      previewContainer.classList.add('hidden');
    }

    // Calendar Functions
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      currentMonthEl.textContent = `${year} å¹´ ${month + 1} æœˆ`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      calendarGrid.innerHTML = '';
      
      // Empty cells for days before the first day
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'h-10';
        calendarGrid.appendChild(emptyCell);
      }
      
      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasEntry = entries.some(e => e.date === dateStr);
        const isSelected = selectedDate === dateStr;
        
        const dayCell = document.createElement('button');
        dayCell.className = `calendar-day h-10 rounded-lg flex items-center justify-center text-sm ${hasEntry ? 'has-entry' : ''} ${isSelected ? 'selected' : ''}`;
        dayCell.textContent = day;
        dayCell.addEventListener('click', () => selectDate(dateStr));
        calendarGrid.appendChild(dayCell);
      }
    }

    function selectDate(dateStr) {
      selectedDate = dateStr;
      renderCalendar();
      showEntriesForDate(dateStr);
    }

    function showEntriesForDate(dateStr) {
      const dateEntries = entries.filter(e => e.date === dateStr);
      const [year, month, day] = dateStr.split('-');
      selectedDateTitle.textContent = `${year} å¹´ ${parseInt(month)} æœˆ ${parseInt(day)} æ—¥`;
      
      entriesSection.classList.remove('hidden');
      
      if (dateEntries.length === 0) {
        entriesList.classList.add('hidden');
        noEntries.classList.remove('hidden');
      } else {
        entriesList.classList.remove('hidden');
        noEntries.classList.add('hidden');
        
        entriesList.innerHTML = '';
        dateEntries.forEach(entry => {
          const card = document.createElement('div');
          card.className = 'entry-card p-3 fade-in';
          card.innerHTML = `
            <img src="${entry.image_data}" class="w-full h-40 object-cover rounded-xl mb-2" alt="è¨˜éŒ„åœ–ç‰‡">
            ${entry.text ? `<p class="text-gray-700 text-sm">${entry.text}</p>` : ''}
            <div class="flex justify-between items-center mt-2">
              <span class="text-xs text-gray-400">${new Date(entry.created_at).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
              <button class="delete-entry text-red-400 hover:text-red-600 text-xs" data-id="${entry.__backendId}">åˆªé™¤</button>
            </div>
          `;
          entriesList.appendChild(card);
        });

        // Add delete handlers
        document.querySelectorAll('.delete-entry').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const backendId = e.target.dataset.id;
            const entryToDelete = entries.find(entry => entry.__backendId === backendId);
            if (entryToDelete && window.dataSdk) {
              e.target.textContent = 'åˆªé™¤ä¸­...';
              e.target.disabled = true;
              const result = await window.dataSdk.delete(entryToDelete);
              if (!result.isOk) {
                e.target.textContent = 'åˆªé™¤';
                e.target.disabled = false;
              }
            }
          });
        });
      }
    }

    closeEntriesBtn.addEventListener('click', () => {
      entriesSection.classList.add('hidden');
      selectedDate = null;
      renderCalendar();
    });

    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        entries = data;
        recordCount = data.length;
        
        if (recordCount >= 999) {
          limitWarning.classList.remove('hidden');
        } else {
          limitWarning.classList.add('hidden');
        }
        
        // Re-render calendar if visible
        if (!calendarTab.classList.contains('hidden')) {
          renderCalendar();
          if (selectedDate) {
            showEntriesForDate(selectedDate);
          }
        }
      }
    };

    // Element SDK Config Change Handler
    async function onConfigChange(config) {
      const title = config.app_title || defaultConfig.app_title;
      appTitle.textContent = title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['app_title', config.app_title || defaultConfig.app_title]
      ]);
    }

    // Initialize SDKs
    async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }

      renderCalendar();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b0c26fc2307a9c2',t:'MTc2NjIwMjM4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>